# Ð£Ð¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð° NodeOn Pyramid
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: .\fix_server_simple.ps1

param(
    [string]$ServerIP = "147.45.110.220",
    [string]$ServerUser = "root",
    [string]$AppDir = "/root/nodeon"
)

Write-Host "ðŸš€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ð° NodeOn Pyramid" -ForegroundColor Blue
Write-Host "==================================================" -ForegroundColor Blue

Write-Host "ðŸ“‹ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ:" -ForegroundColor Blue
Write-Host "  Ð¡ÐµÑ€Ð²ÐµÑ€: ${ServerUser}@${ServerIP}" -ForegroundColor White
Write-Host "  ÐŸÐ°Ð¿ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ: ${AppDir}" -ForegroundColor White
Write-Host ""

Write-Host "ðŸ” ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ..." -ForegroundColor Blue
Write-Host "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ ${ServerUser}@${ServerIP}:"

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
function Invoke-SSHCommand {
    param(
        [string]$Command,
        [string]$Description
    )
    
    Write-Host "ðŸ”§ $Description" -ForegroundColor Yellow
    
    try {
        $result = ssh -o StrictHostKeyChecking=no "${ServerUser}@${ServerIP}" $Command
        Write-Host "âœ… $Description - Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾" -ForegroundColor Green
        return $true
    }
    catch {
        Write-Host "âŒ $Description - Ð¾ÑˆÐ¸Ð±ÐºÐ°" -ForegroundColor Red
        return $false
    }
    Write-Host ""
}

# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
Invoke-SSHCommand "echo 'ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾'" "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ"

# 2. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
Invoke-SSHCommand "cd ${AppDir}; pwd" "ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"

# 3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²
Invoke-SSHCommand "cd ${AppDir}; ls -la" "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² Ð¿Ð°Ð¿ÐºÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"

# 4. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
$envCommand = @"
cd ${AppDir}; cat > .env << 'EOF'
NODE_ENV=production
PORT=3000

SUPABASE_URL=https://ahxwpzgltlzlvrtrbanm.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoeHdwemdsdGx6bHZydHJiYW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MDMxNDksImV4cCI6MjA3NTA3OTE0OX0.h4sMVhVwvRUiHgbevDgv9W1G2S__uDWPUSCiXdrEy4E

TELEGRAM_BOT_TOKEN=7670372637:AAG7XWbNkhvNx_M4MI4118AYXvIsn3bRMDQ
TELEGRAM_BOT_USERNAME=pro_stars_bot

SECRET_KEY=your_secret_key_here
DEVELOPER_TELEGRAM_ID=207940967
EOF
"@

Invoke-SSHCommand $envCommand "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°"

# 5. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ecosystem.config.js
$ecosystemCommand = @"
cd ${AppDir}; cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'nodeon-pyramid',
    script: 'server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
EOF
"@

Invoke-SSHCommand $ecosystemCommand "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ecosystem.config.js"

# 6. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿ÐºÐ¸ public
Invoke-SSHCommand "cd ${AppDir}; mkdir -p public" "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿ÐºÐ¸ public"

# 7. ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ index.html Ð² public
Invoke-SSHCommand "cd ${AppDir}; if [ -f index.html ] && [ ! -f public/index.html ]; then cp index.html public/; fi" "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ index.html Ð² public"

# 8. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
Invoke-SSHCommand "cd ${AppDir}; npm install" "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Node.js"

# 9. ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²ÑÐµÑ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² PM2
Invoke-SSHCommand "pm2 stop all || true" "ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²ÑÐµÑ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² PM2"

# 10. Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² PM2
Invoke-SSHCommand "pm2 delete all || true" "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² PM2"

# 11. Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
Invoke-SSHCommand "cd ${AppDir}; pm2 start ecosystem.config.js" "Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· PM2"

# 12. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ PM2
Invoke-SSHCommand "pm2 save" "Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ PM2"

# 13. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx
$nginxCommand = @"
cat > /etc/nginx/sites-available/nodeon << 'EOF'
server {
    listen 80;
    server_name sistemypro.ru www.sistemypro.ru;
    
    root ${AppDir}/public;
    index index.html;
    
    location / {
        try_files `$uri `$uri/ /index.html;
    }
    
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_set_header Host `$host;
        proxy_set_header X-Real-IP `$remote_addr;
        proxy_set_header X-Forwarded-For `$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto `$scheme;
    }
    
    location /health {
        proxy_pass http://localhost:3000;
        proxy_set_header Host `$host;
        proxy_set_header X-Real-IP `$remote_addr;
        proxy_set_header X-Forwarded-For `$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto `$scheme;
    }
}
EOF
"@

Invoke-SSHCommand $nginxCommand "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx"

# 14. ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx
Invoke-SSHCommand "ln -sf /etc/nginx/sites-available/nodeon /etc/nginx/sites-enabled/" "ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx"

# 15. Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ default ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
Invoke-SSHCommand "rm -f /etc/nginx/sites-enabled/default" "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ default ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx"

# 16. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx
Invoke-SSHCommand "nginx -t" "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx"

# 17. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Nginx
Invoke-SSHCommand "systemctl restart nginx" "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Nginx"

# 18. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
Invoke-SSHCommand "pm2 status" "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° PM2"

# 19. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð° 3000
Invoke-SSHCommand "netstat -tlnp | grep 3000" "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð° 3000"

# 20. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° health endpoint
Invoke-SSHCommand "curl -s http://localhost:3000/health || echo 'Health endpoint Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½'" "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° health endpoint"

# 21. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ°Ð¹Ñ‚Ð°
Invoke-SSHCommand "curl -s -I http://sistemypro.ru | head -1" "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÐ°Ð¹Ñ‚Ð°"

Write-Host "ðŸŽ‰ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!" -ForegroundColor Green
Write-Host ""
Write-Host "ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:" -ForegroundColor Blue
Write-Host "  Ð¡Ð°Ð¹Ñ‚: http://sistemypro.ru" -ForegroundColor White
Write-Host "  API: http://sistemypro.ru/api/health" -ForegroundColor White
Write-Host ""
Write-Host "ðŸ“‹ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:" -ForegroundColor Blue
Write-Host "  ssh ${ServerUser}@${ServerIP} 'pm2 status'" -ForegroundColor White
Write-Host "  ssh ${ServerUser}@${ServerIP} 'pm2 logs nodeon-pyramid'" -ForegroundColor White
Write-Host "  ssh ${ServerUser}@${ServerIP} 'systemctl status nginx'" -ForegroundColor White
Write-Host ""
Write-Host "ðŸ”’ Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:" -ForegroundColor Yellow
Write-Host "  ssh ${ServerUser}@${ServerIP} 'certbot --nginx -d sistemypro.ru -d www.sistemypro.ru'" -ForegroundColor White
