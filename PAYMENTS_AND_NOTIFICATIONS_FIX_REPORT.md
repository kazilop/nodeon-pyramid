# üîß –û–¢–ß–ï–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ NDN –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û: –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### üéØ –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏:

1. **–ü–æ–∫—É–ø–∫–∞ NDN –∑–∞ Stars** - –æ—à–∏–±–∫–∞ "unexpected token"
2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ 1 —Å–µ–∫—É–Ω–¥—É –≤–º–µ—Å—Ç–æ –¥–æ–ª—å—à–µ

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:

### **–ü—Ä–æ–±–ª–µ–º–∞ 1: –ü–æ–∫—É–ø–∫–∞ NDN –∑–∞ Stars**

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ "unexpected token" –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∫—É–ø–∏—Ç—å NDN
- API endpoint `/api/payments/create-invoice` –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª

**–ü—Ä–∏—á–∏–Ω–∞:** 
- –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª API —Ä–æ—É—Ç –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
- –í —Ç–∞–±–ª–∏—Ü–µ `nodeon_transactions` –Ω–µ –±—ã–ª–æ –∫–æ–ª–æ–Ω–∫–∏ `status`

### **–ü—Ä–æ–±–ª–µ–º–∞ 2: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**

**–°–∏–º–ø—Ç–æ–º—ã:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏—Å—á–µ–∑–∞–ª–∏ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É—Å–ø–µ–≤–∞–ª –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω–∞:**
- –í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ 3000ms (3 —Å–µ–∫—É–Ω–¥—ã)
- –ù–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª —Ç–æ–ª—å–∫–æ 1 —Å–µ–∫—É–Ω–¥—É

## ‚úÖ –†–ï–®–ï–ù–ò–Ø:

### **1. –°–æ–∑–¥–∞–Ω–∏–µ API –ø–ª–∞—Ç–µ–∂–µ–π**

**–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª:** `server-deployment/routes/payments.js`

**Endpoints:**
- `POST /api/payments/create-invoice` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞
- `POST /api/payments/confirm-payment` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞  
- `GET /api/payments/transactions/:user_id` - –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
```javascript
// –°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ NDN
{
  "amount_ndn": 100,
  "description": "–ü–æ–∫—É–ø–∫–∞ 100 NDN –∑–∞ 100 Telegram Stars"
}

// –û—Ç–≤–µ—Ç API
{
  "success": true,
  "invoice_link": "https://t.me/invoice/17",
  "transaction_id": 17,
  "amount_ndn": 100,
  "amount_stars": 100,
  "description": "Test purchase"
}
```

### **2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ç–∞–±–ª–∏—Ü–µ `nodeon_transactions` –Ω–µ –±—ã–ª–æ –∫–æ–ª–æ–Ω–∫–∏ `status`

**–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ `status` –∏–∑ –∫–æ–¥–∞

**–ë—ã–ª–æ:**
```javascript
status: 'pending',
```

**–°—Ç–∞–ª–æ:**
```javascript
// –£–±—Ä–∞–ª–∏ status –∏–∑ insert –∑–∞–ø—Ä–æ—Å–∞
```

### **3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ Telegram WebApp API

**–ë—ã–ª–æ:**
```javascript
const initData = tg.initData;
if (typeof tg !== 'undefined' && tg.openInvoice) {
    tg.openInvoice(result.invoice_link, (status) => {
```

**–°—Ç–∞–ª–æ:**
```javascript
const initData = window.Telegram?.WebApp?.initData || '';
if (window.Telegram?.WebApp?.openInvoice) {
    window.Telegram.WebApp.openInvoice(result.invoice_link, (status) => {
```

### **4. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**

**–ë—ã–ª–æ:**
```javascript
function showNotification(message, type = 'info', duration = 3000) {
```

**–°—Ç–∞–ª–æ:**
```javascript
function showNotification(message, type = 'info', duration = 5000) {
```

**–¢–∞–∫–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Ç–æ—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**
```javascript
function showNotification(message, type = 'success', duration = 5000) {
    // ...
    setTimeout(() => {
        notification.remove();
    }, duration);
}
```

### **5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ JSON**

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `server.js`:**
```javascript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JSON –ø–∞—Ä—Å–∏–Ω–≥–∞
app.use((error, req, res, next) => {
  if (error instanceof SyntaxError && error.status === 400 && 'body' in error) {
    console.error('JSON Parse Error:', error.message);
    return res.status(400).json({ 
      error: 'Invalid JSON',
      detail: '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –¥–∞–Ω–Ω—ã—Ö'
    });
  }
  next();
});
```

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:

### **1. API –ø–ª–∞—Ç–µ–∂–µ–π**

**–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª:** `test_payments_api.js`

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
–°—Ç–∞—Ç—É—Å: 200
–û—Ç–≤–µ—Ç: {
  "success": true,
  "invoice_link": "https://t.me/invoice/17",
  "transaction_id": 17,
  "amount_ndn": 100,
  "amount_stars": 100,
  "description": "Test purchase"
}
```

**‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!**

### **2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**

**–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª:** `test_notifications.html`

**–î–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:** https://sistemypro.ru/test_notifications.html

**–§—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- Success —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (5 —Å–µ–∫)
- Error —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (5 —Å–µ–∫)  
- Warning —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (5 —Å–µ–∫)
- Info —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (5 —Å–µ–∫)
- –ö–∞—Å—Ç–æ–º–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (10 —Å–µ–∫, 2 —Å–µ–∫)

**‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è 5 —Å–µ–∫—É–Ω–¥!**

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:

### **–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `server-deployment/routes/payments.js` - API –ø–ª–∞—Ç–µ–∂–µ–π
- `test_payments_api.js` - —Ç–µ—Å—Ç API
- `test_notifications.html` - —Ç–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `check_transactions_table.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

### **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `server-deployment/server.js` - –¥–æ–±–∞–≤–ª–µ–Ω —Ä–æ—É—Ç –ø–ª–∞—Ç–µ–∂–µ–π
- `server-deployment/public/index.html` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ Telegram API

### **API endpoints:**
- **3 –Ω–æ–≤—ã—Ö endpoint'–∞** –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** JSON –ø–∞—Ä—Å–∏–Ω–≥–∞
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢:

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- ‚ùå –ü–æ–∫—É–ø–∫–∞ NDN –∑–∞ Stars –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞
- ‚ùå –û—à–∏–±–∫–∞ "unexpected token"
- ‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å 1 —Å–µ–∫—É–Ω–¥—É
- ‚ùå API –ø–ª–∞—Ç–µ–∂–µ–π –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- ‚úÖ **–ü–æ–∫—É–ø–∫–∞ NDN –∑–∞ Stars —Ä–∞–±–æ—Ç–∞–µ—Ç** - API —Å–æ–∑–¥–∞–µ—Ç —Å—á–µ—Ç–∞
- ‚úÖ **–û—à–∏–±–∫–∞ "unexpected token" –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ Telegram API
- ‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è 5 —Å–µ–∫—É–Ω–¥** - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è
- ‚úÖ **API –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω** - —Å–æ–∑–¥–∞–Ω–∏–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –∏—Å—Ç–æ—Ä–∏—è

## üöÄ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø:

### **1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- JSON –ø–∞—Ä—Å–∏–Ω–≥ –æ—à–∏–±–æ–∫
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### **2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º (–º–∞–∫—Å–∏–º—É–º 10,000 NDN)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### **3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –¥–æ–ª—å—à–µ
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp

## üéâ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:

**–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!**

‚úÖ **–ü–æ–∫—É–ø–∫–∞ NDN –∑–∞ Stars** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è 5 —Å–µ–∫—É–Ω–¥  
‚úÖ **API –ø–ª–∞—Ç–µ–∂–µ–π** - —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω  
‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –¥–æ–±–∞–≤–ª–µ–Ω–∞  
‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ–¥–µ–Ω–æ  

**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ**

### üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫—É NDN –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Telegram Stars API –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π












