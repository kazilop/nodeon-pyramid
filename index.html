<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NodeOn Crypto - Крипто Игра</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Анимированный фон */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #1e3c72, #2a5298, #667eea, #764ba2);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Плавающие частицы */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }

        /* Контейнер */
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Система вкладок */
        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs-header {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .tab-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Игровые элементы */
        .game-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            color: #000000;
        }

        .game-card h3 {
            color: #000000;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .game-card p {
            color: #333333;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .game-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .daily-rewards {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .daily-rewards::-webkit-scrollbar {
            height: 6px;
        }

        .daily-rewards::-webkit-scrollbar-track {
            background: transparent;
        }

        .daily-rewards::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .daily-rewards::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Индикатор прокрутки */
        .daily-rewards-container::after {
            content: "← Прокрутите для просмотра всех дней →";
            position: absolute;
            right: 10px;
            bottom: -20px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            pointer-events: none;
            z-index: 1;
        }

        .daily-rewards-container {
            position: relative;
            margin-bottom: 25px;
        }

        .reward-day {
            width: 60px;
            height: 60px;
            min-width: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            color: #ffffff;
            flex-shrink: 0;
        }

        .reward-day div {
            color: #ffffff;
        }

        .reward-day.claimed {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-color: #4CAF50;
        }

        .reward-day.available {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-color: #FFD700;
            animation: pulse 2s infinite;
        }

        .reward-day.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .reward-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .reward-amount {
            font-size: 12px;
            font-weight: bold;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            color: #000000;
        }

        .achievement-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #000000;
        }

        .achievement-description {
            font-size: 14px;
            opacity: 0.8;
            color: #333333;
        }

        .achievement-item.completed {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(69, 160, 73, 0.2));
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .achievement-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .achievement-description {
            font-size: 14px;
            opacity: 0.8;
        }

        .achievement-progress {
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.1);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .level-progress {
            margin-top: 15px;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #000000;
        }

        .level-info span {
            color: #000000;
            font-weight: 500;
        }

        .level-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .level-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
            color: #000000;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
            color: #333333;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #000000;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .stat-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        /* Система уведомлений */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .notification.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .notification.info {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification-text {
            flex: 1;
            font-weight: 500;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Напоминания */
        .reminder-banner {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            border-radius: 8px;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
            cursor: pointer;
        }

        .reminder-banner:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        /* NDN Miner стили */
        .miner-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .miner-stat-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            color: #000000;
        }

        .miner-stat-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .miner-stat-info {
            flex: 1;
        }

        .miner-stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
            color: #333333;
        }

        .miner-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #000000;
        }

        .miner-farms, .miner-upgrades, .miner-shop {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            color: #000000;
        }

        .miner-farms h3, .miner-upgrades h3, .miner-shop h3 {
            color: #000000;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .farms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .farm-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            color: #000000;
        }

        .farm-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .farm-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .farm-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #000000;
        }

        .farm-description {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 10px;
            color: #333333;
        }

        .farm-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: #333333;
        }

        .farm-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .farm-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .farm-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .upgrades-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .upgrade-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #000000;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .upgrade-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .upgrade-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .upgrade-tab.active:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        .upgrade-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #000000;
        }

        .upgrade-info {
            flex: 1;
        }

        .upgrade-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #000000;
        }

        .upgrade-description {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
            color: #333333;
        }

        .upgrade-cost {
            font-size: 12px;
            font-weight: bold;
            color: #667eea;
        }

        .upgrade-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .upgrade-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .upgrade-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            color: #000000;
        }

        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .shop-item.premium {
            border: 2px solid #ffd700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .shop-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .shop-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #000000;
        }

        .shop-description {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 10px;
            color: #333333;
        }

        .shop-cost {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
        }

        .shop-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .shop-button.premium {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #000000;
        }

        .shop-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .shop-button.premium:hover {
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
        }

        /* Заголовок */
        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: slideInDown 1s ease-out;
        }

        @keyframes slideInDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.3); }
            to { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.6); }
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .language-selector {
            margin-top: 15px;
        }

        .language-selector select {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .language-selector select:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .language-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        /* Карточки */
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideInUp 1s ease-out;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Баланс */
        .balance-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .balance-item {
            display: inline-block;
            margin: 0 15px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .balance-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .balance-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Кнопки */
        .button {
            width: 100%;
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .button:hover::before {
            left: 100%;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .button-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.7);
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }

        .button-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .button-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(108, 117, 125, 0.7);
            background: linear-gradient(135deg, #5a6268, #3d4043);
        }

        .button-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .button-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.7);
            background: linear-gradient(135deg, #218838, #1ea085);
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 350px;
            width: 90%;
            animation: slideInScale 0.3s ease;
        }

        @keyframes slideInScale {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        /* Улучшенные стили для мобильных устройств */
        @media (max-width: 768px) {
            .modal-content {
                max-width: 95vw;
                max-height: 90vh;
                padding: 20px;
                margin: 10px;
                overflow-y: auto;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 10px;
                position: sticky;
                bottom: 0;
                background: var(--tg-theme-bg-color, #ffffff);
                padding: 15px 0 0 0;
                margin-top: 20px;
                border-top: 1px solid #eee;
            }
            
            .modal-buttons .button {
                width: 100%;
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            padding: 20px 0 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-buttons .button {
            flex: 1;
            margin-bottom: 0;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .modal-buttons .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        .modal-buttons .button:active {
            transform: translateY(0);
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error {
            background: #f44336;
        }

        .notification.warning {
            background: #ff9800;
        }

        /* Загрузка */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Адаптивность */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .balance-item {
                margin: 5px;
                padding: 12px 20px;
            }
            
            .card {
                padding: 20px;
            }
        }

        /* Эффекты частиц */
        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            animation: sparkle 1.5s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        /* Стили для рефералов */
        .referrals-content {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .referral-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .referral-info {
            flex: 1;
        }

        .referral-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .referral-username {
            color: #666;
            font-size: 0.9rem;
        }

        .referral-balance {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }

        .no-referrals {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
        }

        .referral-stats {
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
        }

        .stat-hint {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
        }

        .referral-levels {
            margin-bottom: 20px;
        }

        .referral-levels h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 16px;
        }

        .level-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .level-number {
            font-weight: bold;
            color: #4CAF50;
            font-size: 14px;
        }

        .level-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .level-count {
            color: rgba(255, 255, 255, 0.7);
        }

        .level-reward {
            color: #4CAF50;
            font-weight: bold;
        }

        .referral-date {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 2px;
        }

        .level-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 107, 53, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.1);
        }

        .level-section h4 {
            margin: 0 0 15px 0;
            color: #ff6b35;
            font-size: 16px;
            font-weight: 600;
        }

        /* Стили для лидерборда */
        .leaderboard-content {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .leader-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            animation: slideInRight 0.5s ease;
            position: relative;
        }

        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .leader-item.top-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: 2px solid #ffd700;
        }

        .leader-item.top-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            border: 2px solid #c0c0c0;
        }

        .leader-item.top-3 {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            border: 2px solid #cd7f32;
        }

        .leader-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.2rem;
        }

        .leader-item.top-1 .leader-rank {
            background: #ffd700;
            color: #333;
        }

        .leader-item.top-2 .leader-rank {
            background: #c0c0c0;
            color: #333;
        }

        .leader-item.top-3 .leader-rank {
            background: #cd7f32;
            color: white;
        }

        .leader-info {
            flex: 1;
        }

        .leader-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .leader-username {
            color: #666;
            font-size: 0.9rem;
        }

        .leader-balance {
            text-align: right;
        }

        .balance-ndn {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .pro-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Стили для правил */
        .rules-modal .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }
        
        .rules-modal .modal-body {
            max-height: calc(90vh - 120px);
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .rules-modal .modal-buttons {
            position: sticky;
            bottom: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 15px 0 0 0;
            margin-top: 20px;
            border-top: 1px solid #eee;
        }

        .rules-content {
            margin-bottom: 20px;
        }

        .rule-section {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .rule-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .rule-content {
            color: #666;
            line-height: 1.6;
            white-space: pre-line;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .rules-modal .modal-content {
                max-width: 95vw;
                max-height: 95vh;
                margin: 10px;
            }
            
            .rules-modal .modal-body {
                max-height: calc(95vh - 140px);
            }
            
            .rule-section {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .rule-title {
                font-size: 1rem;
            }
            
            .rule-content {
                font-size: 0.9rem;
            }
        }

        /* ==================== ДОСТИЖЕНИЯ ==================== */
        
        .achievement-category {
            margin-bottom: 2rem;
        }
        
        .achievement-category h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .achievement-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .achievement-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .achievement-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .achievement-item.completed {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .achievement-icon {
            font-size: 2rem;
            min-width: 3rem;
            text-align: center;
        }
        
        .achievement-info {
            flex: 1;
        }
        
        .achievement-name {
            font-weight: 600;
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 0.5rem;
        }
        
        .achievement-description {
            color: var(--tg-theme-hint-color, #cccccc);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .achievement-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 0.8rem;
            color: var(--tg-theme-hint-color, #cccccc);
            min-width: 60px;
            text-align: right;
        }
        
        .achievement-reward {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .reward-ndn, .reward-stars {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .reward-ndn {
            color: #FFD700;
        }
        
        .reward-stars {
            color: #FF6B6B;
        }
        
        .claimed {
            color: #4CAF50;
            font-weight: 600;
        }
        
        /* ==================== МАГАЗИНЫ ==================== */
        
        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--tg-theme-hint-color, #cccccc);
        }
        
        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .no-data-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--tg-theme-text-color, #ffffff);
        }
        
        .no-data-subtitle {
            font-size: 0.9rem;
        }
        
        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .shop-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--tg-theme-text-color, #ffffff);
        }
        
        .shop-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .shop-status.active {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        
        .shop-status.inactive {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }
        
        .shop-description {
            color: var(--tg-theme-hint-color, #cccccc);
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .shop-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .shop-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem;
            border-radius: 8px;
            min-width: 80px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--tg-theme-hint-color, #cccccc);
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--tg-theme-text-color, #ffffff);
        }
        
        .shop-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .shop-actions .button {
            flex: 1;
            min-width: 120px;
        }
        
        /* ==================== ФОРМЫ ==================== */
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--tg-theme-text-color, #ffffff);
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #667eea;
            border-radius: 12px;
            background: #ffffff !important;
            color: #000000 !important;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
            background: #ffffff !important;
            color: #000000 !important;
        }
        
        .form-input::placeholder {
            color: #666666 !important;
            opacity: 0.8;
        }
        
        .form-input:hover {
            border-color: #5a67d8;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Дополнительные стили для лучшей видимости */
        .form-input:not(:focus) {
            background: #ffffff !important;
            color: #000000 !important;
        }

        .form-input:not(:focus)::placeholder {
            color: #666666 !important;
        }

        /* Дополнительные стили для полей ввода в модальных окнах */
        .modal .form-input {
            background: #ffffff !important;
            color: #000000 !important;
            border: 2px solid #4CAF50;
        }

        .modal .form-input::placeholder {
            color: #666666 !important;
        }

        .modal .form-input:focus {
            background: #ffffff !important;
            color: #000000 !important;
            border-color: #45a049;
            outline: none;
        }
        
        /* Стили для модальных окон */
        .modal-content {
            background: var(--tg-theme-bg-color, #1a1a1a) !important;
            color: var(--tg-theme-text-color, #ffffff) !important;
        }
        
        .modal-title {
            color: var(--tg-theme-text-color, #ffffff) !important;
        }
        
        .modal-subtitle {
            color: var(--tg-theme-hint-color, #cccccc) !important;
        }
        
        .form-label {
            color: var(--tg-theme-text-color, #ffffff) !important;
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }
        
        select.form-input {
            cursor: pointer;
            background: #ffffff !important;
            color: #000000 !important;
        }
        
        select.form-input option {
            background: #ffffff !important;
            color: #000000 !important;
            padding: 8px;
        }
        
        select.form-input:focus {
            background: #ffffff !important;
            color: #000000 !important;
        }

        /* Стили для модального окна приглашения друзей */
        .invite-content {
            padding: 20px 0;
        }

        .referral-link-section {
            margin-bottom: 30px;
        }

        .referral-link-section h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .link-container {
            margin-bottom: 15px;
        }

        .link-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .link-display {
            margin: 20px 0;
        }

        .link-text {
            background: #ffffff;
            color: #000000;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            user-select: all;
            margin-bottom: 15px;
        }

        .link-instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .link-instructions p {
            margin: 0 0 10px 0;
            font-weight: bold;
            color: var(--tg-theme-text-color, #ffffff);
        }

        .link-instructions ol {
            margin: 0;
            padding-left: 20px;
            color: var(--tg-theme-text-color, #ffffff);
        }

        .link-instructions li {
            margin-bottom: 5px;
        }

        .link-container .form-input {
            width: 100%;
            background: #ffffff !important;
            color: #000000 !important;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
        }

        .invite-methods {
            margin-bottom: 30px;
        }

        .invite-methods h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .method-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .method-buttons .button {
            flex: 1;
            min-width: 150px;
        }

        .referral-info h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-icon {
            font-size: 24px;
            min-width: 30px;
        }

        .info-text {
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 14px;
            line-height: 1.4;
        }

        /* Стили для модального окна перевода NDN */
        .transfer-content {
            padding: 20px 0;
        }

        .recipient-section, .amount-section {
            margin-bottom: 30px;
        }

        .recipient-section h3, .amount-section h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .recipient-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .recipient-avatar {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .recipient-details {
            flex: 1;
        }

        .recipient-name {
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .recipient-id {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        .recipient-input-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recipient-input-section .form-input {
            flex: 1;
            background: #ffffff !important;
            color: #000000 !important;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
        }

        .recipient-input-section .form-input::placeholder {
            color: #666666 !important;
        }

        .recipient-input-section .form-input:focus {
            background: #ffffff !important;
            color: #000000 !important;
            border-color: #45a049;
            outline: none;
        }

        .amount-input-container {
            position: relative;
        }

        .amount-input-container .form-input {
            width: 100%;
            margin-bottom: 10px;
        }

        .balance-info {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            text-align: right;
        }

        .transfer-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transfer-summary h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 16px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item.total {
            font-weight: 600;
            font-size: 16px;
            color: var(--tg-theme-text-color, #ffffff);
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .summary-item span:first-child {
            color: var(--tg-theme-hint-color, #999999);
        }

        .summary-item span:last-child {
            color: var(--tg-theme-text-color, #ffffff);
            font-weight: 500;
        }

        /* Стили для игрового ID */
        .user-id-section {
            text-align: center;
            padding: 20px;
        }

        .id-label {
            color: #000000;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .id-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .id-value {
            background: #ffffff;
            color: #000000;
            font-size: 18px;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .button-small {
            padding: 8px 12px;
            font-size: 14px;
            min-width: auto;
        }

        .id-hint {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 12px;
            margin-top: 5px;
        }

        /* Админ панель */
        .admin-panel-section {
            text-align: center;
            padding: 20px;
        }

        .admin-title {
            font-size: 18px;
            font-weight: 700;
            color: #ff6b35;
            margin-bottom: 10px;
        }

        .admin-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .wallet-stats, .system-stats {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        .wallet-stats h4, .system-stats h4 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            color: #ff6b35;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 107, 53, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 107, 53, 0.15);
        }

        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ff6b35;
        }

        .admin-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .button-admin {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .button-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .button-admin:active {
            transform: translateY(0);
        }

        /* Стили для заявок на обмен */
        .exchange-requests-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .exchange-request-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-info {
            flex: 1;
        }

        .request-user {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .request-amount {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .request-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .request-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 15px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .request-actions {
            display: flex;
            gap: 8px;
        }

        .request-actions .button {
            padding: 8px 12px;
            font-size: 12px;
            min-width: auto;
        }

        .button-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
        }

        .button-danger:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
            transform: translateY(-2px);
        }

        .no-requests {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Анимированный фон -->
    <div class="background-animation"></div>
    
    <!-- Плавающие частицы -->
    <div class="particles" id="particles"></div>

    <!-- Контейнер для уведомлений -->
    <div id="notificationContainer"></div>

    <div class="container">
        <!-- Заголовок -->
        <div class="header">
            <div class="logo" data-i18n="app.name">🚀 NodeOn Crypto</div>
            <div class="subtitle" data-i18n="app.description">Крипто игра с монетами NDN</div>
            <div class="language-selector">
                <select id="languageSelect" onchange="changeLanguage(this.value)">
                    <option value="ru">🇷🇺 Русский</option>
                    <option value="en">🇺🇸 English</option>
                    <option value="es">🇪🇸 Español</option>
                    <option value="de">🇩🇪 Deutsch</option>
                    <option value="fr">🇫🇷 Français</option>
                    <option value="zh">🇨🇳 中文</option>
                    <option value="ja">🇯🇵 日本語</option>
                    <option value="ko">🇰🇷 한국어</option>
                    <option value="ar">🇸🇦 العربية</option>
                    <option value="pt">🇵🇹 Português</option>
                    <option value="it">🇮🇹 Italiano</option>
                    <option value="hi">🇮🇳 हिन्दी</option>
                </select>
            </div>
        </div>

        <!-- Система вкладок -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" onclick="switchTab('core')" data-i18n="tabs.core">
                    🏠 Основное
                </button>
                <button class="tab-button" onclick="switchTab('game')" data-i18n="tabs.game">
                    🎮 Игра
                </button>
                <button class="tab-button" onclick="switchTab('miner')" data-i18n="tabs.miner">
                    ⛏️ NDN Miner
                </button>
            </div>
        </div>

        <!-- Вкладка Core (Основное) -->
        <div class="tab-content active" id="coreTab">
            <!-- Баланс -->
            <div class="balance-section">
            <div class="balance-item">
                <div class="balance-label" data-i18n="user.balance_ndn">NDN Баланс</div>
                <div class="balance-value" id="ndnBalance">0.00</div>
            </div>
        </div>


        <!-- Основные кнопки -->
        <div class="card">
            <button class="button button-primary" onclick="buyPro()" data-i18n="buttons.buy_pro">
                💎 Купить Pro статус
            </button>
            <button class="button button-secondary" onclick="buyNDN()" data-i18n="buttons.buy_ndn">
                ⭐ Купить NDN за Telegram Stars
            </button>
            <button class="button button-success" onclick="exchangeNDN()" data-i18n="buttons.exchange">
                ⭐ Обменять NDN на Stars
            </button>
            <button class="button button-info" onclick="transferNDN()" data-i18n="buttons.transfer_ndn">
                💸 Перевести NDN
            </button>
        </div>

        <!-- Дополнительные функции -->
        <div class="card">
            <button class="button button-primary" onclick="showAchievements()" data-i18n="buttons.achievements">
                🏆 Достижения
            </button>
            <button class="button button-secondary" onclick="showShops()" data-i18n="buttons.shops">
                🏪 Магазины
            </button>
            <button class="button button-success" onclick="showReferrals()" data-i18n="buttons.referrals">
                👥 Мои рефералы
            </button>
        </div>

        <!-- PRO функции (только для PRO пользователей) -->
        <div class="card" id="proFunctionsCard" style="display: none;">
            <button class="button button-success" onclick="inviteFriends()" data-i18n="buttons.invite_friends">
                📤 Пригласить друзей
            </button>
        </div>

        <!-- Дополнительные функции 2 -->
        <div class="card">
            <button class="button button-primary" onclick="showLeaderboard()" data-i18n="buttons.leaderboard">
                🏆 Таблица лидеров
            </button>
            <button class="button button-secondary" onclick="showRules()" data-i18n="buttons.rules">
                📋 Правила игры
            </button>
        </div>

        <!-- Игровой ID (внизу) -->
        <!-- Админ панель (только для админов) -->
        <div class="card" id="adminPanelCard" style="display: none;">
            <div class="admin-panel-section">
                <div class="admin-title">🛡️ Админ панель</div>
                <div class="admin-status" id="adminStatus">Загрузка...</div>
                
                <!-- Статистика серверного кошелька -->
                <div id="walletStats" class="wallet-stats" style="display: none;">
                    <h4>💰 Серверный кошелек</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">💎</div>
                            <div class="stat-info">
                                <div class="stat-label">Баланс NDN</div>
                                <div class="stat-value" id="walletBalance">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">⭐</div>
                            <div class="stat-info">
                                <div class="stat-label">Получено Stars</div>
                                <div class="stat-value" id="starsReceived">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🔄</div>
                            <div class="stat-info">
                                <div class="stat-label">Обменено NDN</div>
                                <div class="stat-value" id="ndnExchanged">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📤</div>
                            <div class="stat-info">
                                <div class="stat-label">Отправлено Stars</div>
                                <div class="stat-value" id="starsSent">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Общая статистика -->
                <div id="systemStats" class="system-stats" style="display: none;">
                    <h4>📊 Статистика системы</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">👥</div>
                            <div class="stat-info">
                                <div class="stat-label">Всего пользователей</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">💎</div>
                            <div class="stat-info">
                                <div class="stat-label">PRO пользователей</div>
                                <div class="stat-value" id="proUsers">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🔄</div>
                            <div class="stat-info">
                                <div class="stat-label">NDN в обороте</div>
                                <div class="stat-value" id="ndnInCirculation">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🔗</div>
                            <div class="stat-info">
                                <div class="stat-label">Рефералов</div>
                                <div class="stat-value" id="totalReferrals">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="admin-buttons">
                    <button class="button button-admin" onclick="showExchangeRequests()" id="exchangeRequestsBtn" style="display: none;">
                        💰 Заявки на обмен
                    </button>
                    <button class="button button-admin" onclick="showUserManagement()" id="userManagementBtn" style="display: none;">
                        👥 Управление пользователями
                    </button>
                    <button class="button button-admin" onclick="showAnalytics()" id="analyticsBtn" style="display: none;">
                        📊 Аналитика
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="user-id-section">
                <div class="id-label" data-i18n="user.user_id">🎮 Ваш игровой ID:</div>
                <div class="id-container">
                    <div class="id-value" id="userId">-</div>
                    <button class="button button-small" onclick="copyUserId()">📋</button>
                </div>
                <div class="id-hint" data-i18n="user.user_id_hint">Используйте этот ID для переводов другим игрокам</div>
            </div>
        </div>

        <!-- Тестовые функции (только в браузере) -->
        <div class="card" id="testFunctions" style="display: none;">
            <button class="button button-secondary" onclick="resetTestData()">
                🔄 Сбросить тестовые данные
            </button>
            <button class="button button-success" onclick="addTestMoney()">
                ⭐ Добавить тестовые Stars
            </button>
        </div>

        <!-- Загрузка -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Загрузка...</div>
        </div>
        </div>

        <!-- Вкладка Game (Игра) -->
        <div class="tab-content" id="gameTab">
            <!-- Напоминания -->
            <div class="reminder-banner" id="dailyReminder" onclick="claimDailyReward(1)" style="display: none;">
                🎁 Не забудьте получить ежедневную награду!
            </div>
            
            <!-- Ежедневные награды -->
            <div class="game-card">
                <h3 data-i18n="game.daily_rewards">🎁 Ежедневные награды</h3>
                <p data-i18n="game.daily_rewards_desc">Заходите каждый день и получайте бонусы! (прокрутите для просмотра всех дней)</p>
                <div class="daily-rewards-container">
                    <div class="daily-rewards" id="dailyRewards">
                        <!-- Будет заполнено JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Достижения -->
            <div class="game-card">
                <h3 data-i18n="game.achievements">🏆 Достижения</h3>
                <p data-i18n="game.achievements_desc">Выполняйте задачи и получайте награды!</p>
                <div id="achievementsList">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Уровень игрока -->
            <div class="game-card">
                <h3 data-i18n="game.player_level">⭐ Уровень игрока</h3>
                <div class="level-progress">
                    <div class="level-info">
                        <span data-i18n="game.level">Уровень <span id="playerLevel">1</span></span>
                        <span><span id="currentXP">0</span> / <span id="nextLevelXP">100</span> <span data-i18n="game.xp">XP</span></span>
                    </div>
                    <div class="level-bar">
                        <div class="level-bar-fill" id="levelProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Статистика игры -->
            <div class="game-card">
                <h3 data-i18n="game.statistics">📊 Статистика</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">🎮</div>
                        <div class="stat-info">
                            <div class="stat-label" data-i18n="game.days_played">Дней в игре</div>
                            <div class="stat-value" id="daysPlayed">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">🏆</div>
                        <div class="stat-info">
                            <div class="stat-label" data-i18n="game.achievements_count">Достижений</div>
                            <div class="stat-value" id="achievementsCount">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">💰</div>
                        <div class="stat-info">
                            <div class="stat-label" data-i18n="game.total_earned">Заработано NDN</div>
                            <div class="stat-value" id="totalEarned">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">👥</div>
                        <div class="stat-info">
                            <div class="stat-label" data-i18n="game.total_referrals">Приглашено</div>
                            <div class="stat-value" id="totalReferrals">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Вкладка NDN Miner -->
        <div class="tab-content" id="minerTab">
            <!-- Статистика майнинга -->
            <div class="miner-stats">
                <div class="miner-stat-item">
                    <div class="miner-stat-icon">⛏️</div>
                    <div class="miner-stat-info">
                        <div class="miner-stat-label">NDN Gas</div>
                        <div class="miner-stat-value" id="ndnGasBalance">0</div>
                    </div>
                </div>
                <div class="miner-stat-item">
                    <div class="miner-stat-icon">⚡</div>
                    <div class="miner-stat-info">
                        <div class="miner-stat-label">Энергия</div>
                        <div class="miner-stat-value" id="energyLevel">100/100</div>
                    </div>
                </div>
                <div class="miner-stat-item">
                    <div class="miner-stat-icon">📊</div>
                    <div class="miner-stat-info">
                        <div class="miner-stat-label">Gas/сек</div>
                        <div class="miner-stat-value" id="gasPerSecond">0</div>
                    </div>
                </div>
            </div>

            <!-- Фермы майнинга -->
            <div class="miner-farms">
                <h3>🏭 Фермы майнинга</h3>
                <div class="farms-grid" id="farmsGrid">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Улучшения -->
            <div class="miner-upgrades">
                <h3>🔧 Улучшения</h3>
                <div class="upgrades-tabs">
                    <button class="upgrade-tab active" onclick="switchUpgradeTab('speed')">Скорость</button>
                    <button class="upgrade-tab" onclick="switchUpgradeTab('efficiency')">Эффективность</button>
                    <button class="upgrade-tab" onclick="switchUpgradeTab('automation')">Автоматизация</button>
                    <button class="upgrade-tab" onclick="switchUpgradeTab('premium')">Премиум</button>
                </div>
                <div class="upgrades-content" id="upgradesContent">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Магазин -->
            <div class="miner-shop">
                <h3>🛒 Магазин</h3>
                <div class="shop-items" id="shopItems">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно покупки Pro -->
    <div class="modal" id="buyProModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.buy_pro">💎 Купить Pro статус</div>
                <div class="modal-subtitle" data-i18n="pro.cost">Стоимость: 1000 NDN</div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="user.balance_ndn">Ваш баланс NDN:</label>
                <div class="balance-value" id="modalNdnBalance">0.00</div>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmBuyPro()" data-i18n="buttons.confirm">Подтвердить</button>
                <button class="button button-secondary" onclick="closeModal('buyProModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно покупки NDN -->
    <div class="modal" id="buyNDNModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.buy_ndn">⭐ Купить NDN за Telegram Stars</div>
                <div class="modal-subtitle" data-i18n="payment.rate">Курс: 1 NDN = 1 Telegram Star</div>
                <div class="modal-subtitle" style="font-size: 0.8rem; color: #666; margin-top: 5px;" data-i18n="payment.stars_info">
                    💡 Stars поступают на баланс бота и могут быть выведены в TON
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="transfer.amount">Количество NDN:</label>
                <input type="number" class="form-input" id="ndnAmount" data-i18n-placeholder="transfer.amount" placeholder="Введите количество" min="1">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="payment.stars_cost">Стоимость в Stars:</label>
                <div class="balance-value" id="starsCost">0</div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;" data-i18n="payment.stars_info">
                    💡 Stars поступают на баланс бота и могут быть выведены в TON
                </div>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmBuyNDN()" data-i18n="buttons.buy">Купить</button>
                <button class="button button-secondary" onclick="closeModal('buyNDNModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно обмена NDN на Stars -->
    <div class="modal" id="exchangeNDNModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.exchange">⭐ Обменять NDN на Telegram Stars</div>
                <div class="modal-subtitle" data-i18n="payment.rate">Курс: 1 NDN = 1 Telegram Star</div>
                <div class="modal-subtitle" style="font-size: 0.8rem; color: #666; margin-top: 5px;" data-i18n="exchange.stars_info">
                    💡 NDN списываются с вашего счета, Stars поступают в Telegram
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="transfer.amount">Количество NDN для обмена:</label>
                <input type="number" class="form-input" id="exchangeAmount" data-i18n-placeholder="transfer.amount" placeholder="Введите количество" min="1" oninput="updateExchangeStars()">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="exchange.username">Ваш Telegram username:</label>
                <input type="text" class="form-input" id="exchangeUsername" placeholder="@username" value="@NobodyYety">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="exchange.receive_stars">Получите Stars:</label>
                <div class="balance-value" id="exchangeStars">0</div>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmExchangeNDN()" data-i18n="buttons.exchange">Обменять</button>
                <button class="button button-secondary" onclick="closeModal('exchangeNDNModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно вывода NDN -->
    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.withdraw_ndn">💰 Вывести NDN</div>
                <div class="modal-subtitle" data-i18n="withdraw.minimum">Минимальная сумма: 100 NDN</div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="transfer.amount">Количество NDN:</label>
                <input type="number" class="form-input" id="withdrawAmount" data-i18n-placeholder="transfer.amount" placeholder="Введите количество" min="100">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="withdraw.recipient_id">Telegram ID получателя:</label>
                <input type="text" class="form-input" id="recipientId" data-i18n-placeholder="withdraw.recipient_placeholder" placeholder="@username или ID">
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmWithdraw()" data-i18n="buttons.withdraw">Вывести</button>
                <button class="button button-secondary" onclick="closeModal('withdrawModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно достижений -->
    <div class="modal" id="achievementsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.achievements">🏆 Достижения</div>
                <div class="modal-subtitle" data-i18n="achievements.description">Выполняйте задачи и получайте награды!</div>
            </div>
            <div class="modal-body" id="achievementsList">
                <div class="loading">Загрузка достижений...</div>
            </div>
            <div class="modal-buttons">
                <button class="button button-secondary" onclick="closeModal('achievementsModal')" data-i18n="buttons.back">← Назад</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно магазинов -->
    <div class="modal" id="shopsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.shops">🏪 Магазины</div>
                <div class="modal-subtitle" data-i18n="shops.description">Откройте свой магазин за 10,000 NDN!</div>
            </div>
            <div class="modal-body" id="shopsList">
                <div class="loading">Загрузка магазинов...</div>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="showOpenShopForm()" data-i18n="shops.open_shop">🏪 Открыть магазин</button>
                <button class="button button-secondary" onclick="closeModal('shopsModal')" data-i18n="buttons.back">← Назад</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно открытия магазина -->
    <div class="modal" id="openShopModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="shops.open_shop">🏪 Открыть магазин</div>
                <div class="modal-subtitle" data-i18n="shops.cost">Стоимость: 10,000 NDN</div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.shop_name">Название магазина:</label>
                <input type="text" class="form-input" id="shopName" data-i18n-placeholder="shops.shop_name" placeholder="Введите название магазина">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.shop_description">Описание:</label>
                <textarea class="form-input" id="shopDescription" data-i18n-placeholder="shops.shop_description" placeholder="Опишите ваш магазин" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.category">Категория:</label>
                <select class="form-input" id="shopCategory">
                    <option value="general" data-i18n="shops.categories.general">Общие товары</option>
                    <option value="digital" data-i18n="shops.categories.digital">Цифровые товары</option>
                    <option value="physical" data-i18n="shops.categories.physical">Физические товары</option>
                    <option value="services" data-i18n="shops.categories.services">Услуги</option>
                    <option value="congratulations" data-i18n="shops.categories.congratulations">Поздравления</option>
                    <option value="merchandise" data-i18n="shops.categories.merchandise">Мерч</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmOpenShop()" data-i18n="shops.open_shop">Открыть магазин</button>
                <button class="button button-secondary" onclick="closeModal('openShopModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления товара -->
    <div class="modal" id="addItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="shops.add_item">📦 Добавить товар</div>
                <div class="modal-subtitle" data-i18n="shops.add_item_description">Добавьте товар в ваш магазин</div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.item_name">Название товара:</label>
                <input type="text" class="form-input" id="itemName" data-i18n-placeholder="shops.item_name" placeholder="Введите название товара">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.item_description">Описание:</label>
                <textarea class="form-input" id="itemDescription" data-i18n-placeholder="shops.item_description" placeholder="Опишите товар" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.price_ndn">Цена в NDN:</label>
                <input type="number" class="form-input" id="itemPriceNDN" placeholder="0" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.price_stars">Цена в Stars:</label>
                <input type="number" class="form-input" id="itemPriceStars" placeholder="0" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.item_type">Тип товара:</label>
                <select class="form-input" id="itemType">
                    <option value="digital" data-i18n="shops.types.digital">Цифровой</option>
                    <option value="physical" data-i18n="shops.types.physical">Физический</option>
                    <option value="service" data-i18n="shops.types.service">Услуга</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.category">Категория:</label>
                <select class="form-input" id="itemCategory">
                    <option value="congratulations" data-i18n="shops.categories.congratulations">Поздравления</option>
                    <option value="merchandise" data-i18n="shops.categories.merchandise">Мерч</option>
                    <option value="digital" data-i18n="shops.categories.digital">Цифровые товары</option>
                    <option value="services" data-i18n="shops.categories.services">Услуги</option>
                    <option value="general" data-i18n="shops.categories.general">Общие</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.image_url">Ссылка на изображение:</label>
                <input type="url" class="form-input" id="itemImageUrl" placeholder="https://example.com/image.jpg">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.stock">Количество на складе (-1 = безлимит):</label>
                <input type="number" class="form-input" id="itemStock" placeholder="-1" min="-1">
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmAddItem()" data-i18n="shops.add_item">Добавить товар</button>
                <button class="button button-secondary" onclick="closeModal('addItemModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно приглашения друзей -->
    <div class="modal" id="inviteFriendsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.invite_friends">📤 Пригласить друзей</div>
                <div class="modal-subtitle" data-i18n="referrals.invite_description">Поделитесь ссылкой и зарабатывайте с каждого реферала!</div>
            </div>
            <div class="invite-content">
                    <div class="referral-link-section">
                        <h3 data-i18n="referrals.your_link">🔗 Ваша реферальная ссылка:</h3>
                        <div class="link-container">
                            <input type="text" class="form-input" id="referralLinkInput" readonly>
                        </div>
                        <div class="link-actions">
                            <button class="button button-primary" onclick="copyReferralLink()" data-i18n="buttons.copy">📋 Копировать</button>
                            <button class="button button-secondary" onclick="showLinkModal()" data-i18n="referrals.show_link">👁️ Показать ссылку</button>
                        </div>
                    </div>
                
                <div class="invite-methods">
                    <h3 data-i18n="referrals.invite_methods">📱 Способы приглашения:</h3>
                    <div class="method-buttons">
                        <button class="button button-success" onclick="inviteToTelegramContact()" data-i18n="referrals.select_contact">
                            📱 Выбрать контакт из Telegram
                        </button>
                        <button class="button button-primary" onclick="shareViaTelegram()" data-i18n="referrals.share_telegram">
                            🌐 Поделиться в Telegram
                        </button>
                        <button class="button button-secondary" onclick="shareViaOther()" data-i18n="referrals.copy_link">
                            🔗 Скопировать ссылку
                        </button>
                    </div>
                </div>
                
                <div class="referral-info">
                    <h3 data-i18n="referrals.how_to_earn">💰 Как зарабатывать:</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-icon">1️⃣</div>
                            <div class="info-text" data-i18n="referrals.step1">Друг переходит по вашей ссылке</div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">2️⃣</div>
                            <div class="info-text" data-i18n="referrals.step2">Регистрируется в игре</div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">3️⃣</div>
                            <div class="info-text" data-i18n="referrals.step3">Покупает PRO статус</div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">4️⃣</div>
                            <div class="info-text" data-i18n="referrals.step4">Вы получаете 200 NDN</div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">5️⃣</div>
                            <div class="info-text" data-i18n="referrals.step5">Зарабатываете до 7 уровней в глубину</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="button button-secondary" onclick="closeModal('inviteFriendsModal')" data-i18n="buttons.back">← Назад</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно перевода NDN -->
    <div class="modal" id="transferNDNModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="transfer.title">💸 Перевести NDN</div>
                <div class="modal-subtitle" data-i18n="transfer.instructions">Выберите получателя и введите сумму</div>
            </div>
            <div class="transfer-content">
                <div class="recipient-section">
                    <h3 data-i18n="transfer.recipient">👤 Получатель:</h3>
                    <div class="recipient-info" id="recipientInfo" style="display: none;">
                        <div class="recipient-card">
                            <div class="recipient-avatar">👤</div>
                            <div class="recipient-details">
                                <div class="recipient-name" id="recipientName"></div>
                                <div class="recipient-id" id="recipientId"></div>
                            </div>
                            <button class="button button-secondary" onclick="changeRecipient()" data-i18n="buttons.change">Изменить</button>
                        </div>
                    </div>
                    <div class="recipient-input-section" id="recipientInputSection">
                        <input type="text" class="form-input" id="recipientIdInput" data-i18n-placeholder="transfer.recipient" placeholder="Введите игровой ID получателя">
                        <button class="button button-primary" id="findRecipientBtn" onclick="findRecipient()" data-i18n="buttons.find_player">
                            🔍 Найти игрока
                        </button>
                    </div>
                </div>
                
                <div class="amount-section">
                    <h3 data-i18n="transfer.amount">💰 Сумма перевода:</h3>
                    <div class="amount-input-container">
                        <input type="number" class="form-input" id="transferAmount" data-i18n-placeholder="transfer.amount" placeholder="Введите сумму NDN" min="0.01" step="0.01">
                        <div class="balance-info">
                            <span data-i18n="transfer.balance">Ваш баланс:</span> <span id="transferBalance">0</span> NDN
                        </div>
                    </div>
                </div>
                
                <div class="transfer-summary" id="transferSummary" style="display: none;">
                    <h3>📋 Сводка перевода:</h3>
                    <div class="summary-item">
                        <span>Получатель:</span>
                        <span id="summaryRecipient"></span>
                    </div>
                    <div class="summary-item">
                        <span>Сумма:</span>
                        <span id="summaryAmount"></span> NDN
                    </div>
                    <div class="summary-item">
                        <span>Комиссия:</span>
                        <span id="summaryFee">0</span> NDN
                    </div>
                    <div class="summary-item total">
                        <span>Итого к списанию:</span>
                        <span id="summaryTotal"></span> NDN
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="button button-success" id="confirmTransferBtn" onclick="confirmTransfer()" disabled data-i18n="transfer.confirm">
                    💸 Перевести
                </button>
                <button class="button button-secondary" onclick="closeModal('transferNDNModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Глобальные переменные
        let userData = null;
        let currentLanguage = 'ru';
        let referralToken = null;
        let translations = {};
        let supportedLanguages = [];
        let gameData = {
            level: 1,
            xp: 0,
            achievements: [],
            dailyRewards: [],
            stats: {
                daysPlayed: 0,
                totalEarned: 0,
                totalReferrals: 0
            }
        };

        // NDN Miner данные
        let minerData = {
            ndnGas: 0,
            energy: 100,
            maxEnergy: 100,
            gasPerSecond: 0,
            farms: [],
            upgrades: {
                speed: 0,
                efficiency: 0,
                automation: 0
            },
            totalGasEarned: 0,
            lastUpdate: Date.now()
        };

        // Фермы майнинга
        const farmTypes = [
            {
                id: 'cpu_miner',
                name: 'CPU Miner',
                icon: '💻',
                description: 'Базовая ферма на процессоре',
                baseGasPerSecond: 1,
                baseCost: 10,
                energyCost: 1,
                unlockLevel: 1
            },
            {
                id: 'gpu_farm',
                name: 'GPU Farm',
                icon: '🎮',
                description: 'Мощная ферма на видеокартах',
                baseGasPerSecond: 5,
                baseCost: 50,
                energyCost: 3,
                unlockLevel: 3
            },
            {
                id: 'asic_rig',
                name: 'ASIC Rig',
                icon: '⚡',
                description: 'Профессиональная ферма ASIC',
                baseGasPerSecond: 20,
                baseCost: 200,
                energyCost: 8,
                unlockLevel: 5
            },
            {
                id: 'data_center',
                name: 'Data Center',
                icon: '🏢',
                description: 'Мега-ферма в дата-центре',
                baseGasPerSecond: 100,
                baseCost: 1000,
                energyCost: 25,
                unlockLevel: 10
            }
        ];

        // Улучшения
        const upgradeTypes = {
            speed: [
                { name: 'Быстрый процессор', description: '+10% скорости', cost: 50, effect: 0.1 },
                { name: 'Оптимизация кода', description: '+25% скорости', cost: 150, effect: 0.25 },
                { name: 'Параллельные вычисления', description: '+50% скорости', cost: 400, effect: 0.5 }
            ],
            efficiency: [
                { name: 'Энергосбережение', description: '-20% энергии', cost: 30, effect: 0.2 },
                { name: 'Умное охлаждение', description: '-40% энергии', cost: 100, effect: 0.4 },
                { name: 'Квантовая оптимизация', description: '-60% энергии', cost: 300, effect: 0.6 }
            ],
            automation: [
                { name: 'Авто-сбор', description: 'Автоматический сбор Gas', cost: 100, effect: 1 },
                { name: 'Умные алгоритмы', description: 'Оптимизация майнинга', cost: 250, effect: 2 },
                { name: 'ИИ управление', description: 'Полная автоматизация', cost: 500, effect: 3 }
            ]
        };

        // Система вкладок
        function switchTab(tabName) {
            // Убираем активный класс со всех кнопок и контента
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Активируем выбранную вкладку
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // Загружаем данные для игровой вкладки
            if (tabName === 'game') {
                loadGameData();
            }
            
            // Инициализируем майнер при переключении на вкладку майнера
            if (tabName === 'miner') {
                console.log('🔄 Переключаемся на вкладку майнера...');
                setTimeout(() => {
                    initializeMinerData();
                }, 100);
            }
        }

        // Игровые механики
        function loadGameData() {
            loadDailyRewards();
            loadAchievements();
            loadPlayerLevel();
            loadGameStats();
        }

        function loadDailyRewards() {
            const rewards = [
                { day: 1, icon: '💰', amount: 10, claimed: false },
                { day: 2, icon: '💎', amount: 20, claimed: false },
                { day: 3, icon: '⭐', amount: 30, claimed: false },
                { day: 4, icon: '🎁', amount: 50, claimed: false },
                { day: 5, icon: '💎', amount: 75, claimed: false },
                { day: 6, icon: '⭐', amount: 100, claimed: false },
                { day: 7, icon: '🏆', amount: 200, claimed: false }
            ];

            const container = document.getElementById('dailyRewards');
            if (!container) {
                console.warn('Контейнер dailyRewards не найден');
                return;
            }

            container.innerHTML = rewards.map(reward => {
                const today = new Date().getDay() + 1;
                const isClaimed = gameData.dailyRewards.includes(reward.day);
                const isAvailable = reward.day <= today && !isClaimed;
                const isLocked = reward.day > today;

                console.log(`Награда день ${reward.day}: claimed=${isClaimed}, available=${isAvailable}, locked=${isLocked}`);

                return `
                    <div class="reward-day ${isClaimed ? 'claimed' : isAvailable ? 'available' : isLocked ? 'locked' : ''}" 
                         onclick="${isAvailable ? `claimDailyReward(${reward.day})` : ''}"
                         title="${isClaimed ? 'Получено' : isAvailable ? 'Доступно' : isLocked ? 'Заблокировано' : ''}">
                        <div class="reward-icon">${reward.icon}</div>
                        <div class="reward-amount">${reward.amount}</div>
                        <div style="font-size: 10px; margin-top: 2px;">День ${reward.day}</div>
                        ${isClaimed ? '<div style="font-size: 8px; color: #4CAF50;">✓</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        async function claimDailyReward(day) {
            if (gameData.dailyRewards.includes(day)) {
                showNotification('Награда уже получена!', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/game/claim-daily-reward', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `tma ${tg.initData || ''}`
                    },
                    body: JSON.stringify({
                        user_id: userData?.id,
                        day: day
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Обновляем локальные данные
                    gameData.dailyRewards.push(day);
                    gameData.xp += result.reward_amount;
                    gameData.stats.totalEarned += result.reward_amount;

                    // Обновляем баланс пользователя
                    if (userData) {
                        userData.balance_ndn = (userData.balance_ndn || 0) + result.reward_amount;
                    }

                    // Сохраняем награды в localStorage
                    saveDailyRewardsToStorage();

                    // Обновляем UI
                    loadDailyRewards();
                    loadPlayerLevel();
                    loadGameStats();
                    updateUI(); // Обновляем основной UI

                    showNotification(`🎁 Получена награда: ${result.reward_amount} NDN!`, 'success');
                    playSound('success');
                } else {
                    showNotification('Ошибка получения награды', 'error');
                }
            } catch (error) {
                console.error('Error claiming daily reward:', error);
                // Fallback - добавляем награду локально
                const rewards = { 1: 10, 2: 20, 3: 30, 4: 50, 5: 75, 6: 100, 7: 200 };
                const rewardAmount = rewards[day] || 0;
                
                gameData.dailyRewards.push(day);
                gameData.xp += rewardAmount;
                gameData.stats.totalEarned += rewardAmount;
                
                if (userData) {
                    userData.balance_ndn = (userData.balance_ndn || 0) + rewardAmount;
                }

                // Сохраняем награды в localStorage
                saveDailyRewardsToStorage();

                loadDailyRewards();
                loadPlayerLevel();
                loadGameStats();
                updateUI();

                showNotification(`🎁 Получена награда: ${rewardAmount} NDN! (офлайн)`, 'success');
            }
        }

        async function loadAchievements() {
            const container = document.getElementById('achievementsList');
            if (!container) {
                console.warn('Контейнер achievementsList не найден');
                return;
            }

            try {
                const response = await fetch(`/api/game/achievements/${userData?.id || 0}`, {
                    headers: {
                        'Authorization': `tma ${tg.initData || ''}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const achievements = result.achievements;
                    
                    container.innerHTML = achievements.map(achievement => {
                        const isCompleted = achievement.completed;
                        const progressPercent = (achievement.progress / achievement.max_progress) * 100;

                        return `
                            <div class="achievement-item ${isCompleted ? 'completed' : ''}">
                                <div class="achievement-icon">${achievement.icon}</div>
                                <div class="achievement-info">
                                    <div class="achievement-title">${achievement.title}</div>
                                    <div class="achievement-description">${achievement.description}</div>
                                    <div class="achievement-progress">
                                        <div class="achievement-progress-bar" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; opacity: 0.8;">${achievement.progress}/${achievement.max_progress}</div>
                                    <div style="font-size: 14px; font-weight: bold; color: #FFD700;">${achievement.reward} NDN</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Fallback к локальным данным
                    loadAchievementsFallback();
                }
            } catch (error) {
                console.error('Error loading achievements:', error);
                loadAchievementsFallback();
            }
        }

        function loadAchievementsFallback() {
            const achievements = [
                {
                    id: 'first_login',
                    title: 'Первые шаги',
                    description: 'Войти в игру впервые',
                    icon: '🎮',
                    progress: userData ? 1 : 0,
                    maxProgress: 1,
                    reward: 50
                },
                {
                    id: 'pro_user',
                    title: 'Pro игрок',
                    description: 'Купить Pro статус',
                    icon: '💎',
                    progress: userData && userData.is_pro ? 1 : 0,
                    maxProgress: 1,
                    reward: 100
                },
                {
                    id: 'referral_master',
                    title: 'Мастер рефералов',
                    description: 'Пригласить 5 друзей',
                    icon: '👥',
                    progress: Math.min(gameData.stats.totalReferrals, 5),
                    maxProgress: 5,
                    reward: 200
                },
                {
                    id: 'daily_player',
                    title: 'Ежедневный игрок',
                    description: 'Заходить в игру 7 дней подряд',
                    icon: '📅',
                    progress: Math.min(gameData.stats.daysPlayed, 7),
                    maxProgress: 7,
                    reward: 300
                }
            ];

            const container = document.getElementById('achievementsList');
            if (!container) {
                console.warn('Контейнер achievementsList не найден в fallback');
                return;
            }

            container.innerHTML = achievements.map(achievement => {
                const isCompleted = achievement.progress >= achievement.maxProgress;
                const progressPercent = (achievement.progress / achievement.maxProgress) * 100;

                return `
                    <div class="achievement-item ${isCompleted ? 'completed' : ''}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-title">${achievement.title}</div>
                            <div class="achievement-description">${achievement.description}</div>
                            <div class="achievement-progress">
                                <div class="achievement-progress-bar" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; opacity: 0.8;">${achievement.progress}/${achievement.maxProgress}</div>
                            <div style="font-size: 14px; font-weight: bold; color: #FFD700;">${achievement.reward} NDN</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadPlayerLevel() {
            const xpForNextLevel = gameData.level * 100;
            const currentLevelXP = (gameData.level - 1) * 100;
            const progress = ((gameData.xp - currentLevelXP) / (xpForNextLevel - currentLevelXP)) * 100;

            // Проверяем существование элементов перед обновлением
            const playerLevelElement = document.getElementById('playerLevel');
            const currentXPElement = document.getElementById('currentXP');
            const nextLevelXPElement = document.getElementById('nextLevelXP');
            const levelProgressElement = document.getElementById('levelProgress');

            if (playerLevelElement) {
                playerLevelElement.textContent = gameData.level;
            } else {
                console.warn('Элемент playerLevel не найден');
            }

            if (currentXPElement) {
                currentXPElement.textContent = gameData.xp;
            } else {
                console.warn('Элемент currentXP не найден');
            }

            if (nextLevelXPElement) {
                nextLevelXPElement.textContent = xpForNextLevel;
            } else {
                console.warn('Элемент nextLevelXP не найден');
            }

            if (levelProgressElement) {
                levelProgressElement.style.width = `${Math.min(progress, 100)}%`;
            } else {
                console.warn('Элемент levelProgress не найден');
            }

            // Проверяем повышение уровня
            if (gameData.xp >= xpForNextLevel) {
                gameData.level++;
                showNotification(`Поздравляем! Вы достигли ${gameData.level} уровня!`, 'success');
                playSound('levelup');
            }
        }

        function loadGameStats() {
            // Проверяем существование элементов перед обновлением
            const daysPlayedElement = document.getElementById('daysPlayed');
            const achievementsCountElement = document.getElementById('achievementsCount');
            const totalEarnedElement = document.getElementById('totalEarned');
            const totalReferralsElement = document.getElementById('totalReferrals');

            if (daysPlayedElement) {
                daysPlayedElement.textContent = gameData.stats.daysPlayed;
            } else {
                console.warn('Элемент daysPlayed не найден');
            }

            if (achievementsCountElement) {
                achievementsCountElement.textContent = gameData.achievements.length;
            } else {
                console.warn('Элемент achievementsCount не найден');
            }

            if (totalEarnedElement) {
                totalEarnedElement.textContent = gameData.stats.totalEarned;
            } else {
                console.warn('Элемент totalEarned не найден');
            }

            if (totalReferralsElement) {
                totalReferralsElement.textContent = gameData.stats.totalReferrals;
            } else {
                console.warn('Элемент totalReferrals не найден');
            }
        }

        function updateGameData() {
            // Обновляем статистику на основе данных пользователя
            if (userData) {
                gameData.stats.totalEarned = userData.balance_ndn || 0;
                gameData.stats.totalReferrals = userData.total_referrals || 0;
                
                // Увеличиваем счетчик дней в игре
                const lastLogin = localStorage.getItem('lastLogin');
                const today = new Date().toDateString();
                if (lastLogin !== today) {
                    gameData.stats.daysPlayed++;
                    localStorage.setItem('lastLogin', today);
                }
                
                // Загружаем сохраненные игровые данные
                const savedGameData = localStorage.getItem('nodeon_game_data');
                if (savedGameData) {
                    try {
                        const parsed = JSON.parse(savedGameData);
                        gameData = { ...gameData, ...parsed };
                    } catch (e) {
                        console.warn('Ошибка загрузки игровых данных:', e);
                    }
                }
                
                // Проверяем сброс ежедневных наград (новая неделя)
                checkWeeklyReset();
                
                // Загружаем сохраненные ежедневные награды
                loadDailyRewardsFromStorage();
                
                // Обновляем достижения
                loadAchievements();
                loadPlayerLevel();
                loadGameStats();
                
                // Проверяем напоминания
                checkReminders();
                
                // Сохраняем игровые данные
                localStorage.setItem('nodeon_game_data', JSON.stringify(gameData));
            }
        }

        function checkWeeklyReset() {
            const lastReset = localStorage.getItem('lastWeeklyReset');
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            const weekStartString = weekStart.toDateString();
            
            if (lastReset !== weekStartString) {
                // Новая неделя - сбрасываем ежедневные награды
                gameData.dailyRewards = [];
                localStorage.setItem('lastWeeklyReset', weekStartString);
                localStorage.setItem('nodeon_daily_rewards', JSON.stringify([]));
                console.log('🔄 Ежедневные награды сброшены - новая неделя');
            }
        }

        function loadDailyRewardsFromStorage() {
            try {
                const savedRewards = localStorage.getItem('nodeon_daily_rewards');
                if (savedRewards) {
                    const parsed = JSON.parse(savedRewards);
                    if (Array.isArray(parsed)) {
                        gameData.dailyRewards = parsed;
                        console.log('📦 Загружены сохраненные награды:', parsed);
                    }
                }
            } catch (e) {
                console.warn('Ошибка загрузки сохраненных наград:', e);
                gameData.dailyRewards = [];
            }
        }

        function saveDailyRewardsToStorage() {
            try {
                localStorage.setItem('nodeon_daily_rewards', JSON.stringify(gameData.dailyRewards));
                console.log('💾 Награды сохранены:', gameData.dailyRewards);
            } catch (e) {
                console.warn('Ошибка сохранения наград:', e);
            }
        }

        function initializeGameData() {
            console.log('🎮 Инициализируем игровые данные...');
            
            // Загружаем сохраненные награды
            loadDailyRewardsFromStorage();
            
            // Проверяем сброс недели
            checkWeeklyReset();
            
            console.log('📊 Текущие награды:', gameData.dailyRewards);
        }

        // NDN Miner функции
        function initializeMinerData() {
            console.log('⛏️ Инициализируем данные майнера...');
            
            // Проверяем, что вкладка майнера существует
            const minerTab = document.getElementById('minerTab');
            if (!minerTab) {
                console.error('❌ Вкладка майнера не найдена!');
                return;
            }
            
            // Загружаем сохраненные данные майнера
            const savedMinerData = localStorage.getItem('nodeon_miner_data');
            if (savedMinerData) {
                try {
                    const parsed = JSON.parse(savedMinerData);
                    minerData = { ...minerData, ...parsed };
                } catch (e) {
                    console.warn('Ошибка загрузки данных майнера:', e);
                }
            }
            
            // Обновляем UI майнера
            updateMinerUI();
            loadFarms();
            loadUpgrades('speed');
            loadShop();
            
            // Запускаем основной цикл майнинга
            startMiningLoop();
            
            console.log('📊 Данные майнера загружены:', minerData);
        }

        function updateMinerUI() {
            console.log('🔄 Обновляем UI майнера...');
            
            // Обновляем статистику
            const gasBalance = document.getElementById('ndnGasBalance');
            const energyLevel = document.getElementById('energyLevel');
            const gasPerSecond = document.getElementById('gasPerSecond');
            
            console.log('Элементы майнера:', {
                gasBalance: !!gasBalance,
                energyLevel: !!energyLevel,
                gasPerSecond: !!gasPerSecond
            });
            
            if (gasBalance) {
                gasBalance.textContent = Math.floor(minerData.ndnGas).toLocaleString();
                console.log('✅ Gas баланс обновлен:', gasBalance.textContent);
            } else {
                console.error('❌ Элемент ndnGasBalance не найден!');
            }
            
            if (energyLevel) {
                energyLevel.textContent = `${Math.floor(minerData.energy)}/${minerData.maxEnergy}`;
                console.log('✅ Энергия обновлена:', energyLevel.textContent);
            } else {
                console.error('❌ Элемент energyLevel не найден!');
            }
            
            if (gasPerSecond) {
                gasPerSecond.textContent = minerData.gasPerSecond.toFixed(1);
                console.log('✅ Gas/сек обновлен:', gasPerSecond.textContent);
            } else {
                console.error('❌ Элемент gasPerSecond не найден!');
            }
        }

        function loadFarms() {
            const container = document.getElementById('farmsGrid');
            if (!container) return;
            
            container.innerHTML = farmTypes.map(farm => {
                const farmCount = minerData.farms.filter(f => f.type === farm.id).length;
                const canAfford = minerData.ndnGas >= farm.baseCost;
                const canUnlock = gameData.level >= farm.unlockLevel;
                
                return `
                    <div class="farm-item ${!canUnlock ? 'locked' : ''}">
                        <div class="farm-icon">${farm.icon}</div>
                        <div class="farm-name">${farm.name}</div>
                        <div class="farm-description">${farm.description}</div>
                        <div class="farm-stats">
                            <span>Gas/сек: ${farm.baseGasPerSecond}</span>
                            <span>Энергия: ${farm.energyCost}</span>
                        </div>
                        <div class="farm-stats">
                            <span>Количество: ${farmCount}</span>
                            <span>Стоимость: ${farm.baseCost} Gas</span>
                        </div>
                        <button class="farm-button" 
                                onclick="buyFarm('${farm.id}')" 
                                ${!canAfford || !canUnlock ? 'disabled' : ''}>
                            ${!canUnlock ? 'Заблокировано' : canAfford ? 'Купить' : 'Недостаточно Gas'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function buyFarm(farmId) {
            const farm = farmTypes.find(f => f.id === farmId);
            if (!farm) return;
            
            if (minerData.ndnGas < farm.baseCost) {
                showNotification('Недостаточно NDN Gas!', 'error');
                return;
            }
            
            // Покупаем ферму
            minerData.ndnGas -= farm.baseCost;
            minerData.farms.push({
                type: farmId,
                level: 1,
                gasPerSecond: farm.baseGasPerSecond,
                energyCost: farm.energyCost
            });
            
            // Пересчитываем общую генерацию
            calculateGasPerSecond();
            
            // Обновляем UI
            updateMinerUI();
            loadFarms();
            
            // Сохраняем данные
            saveMinerData();
            
            showNotification(`Куплена ферма: ${farm.name}!`, 'success');
        }

        function calculateGasPerSecond() {
            let totalGas = 0;
            let totalEnergy = 0;
            
            minerData.farms.forEach(farm => {
                const farmType = farmTypes.find(f => f.id === farm.type);
                if (farmType) {
                    totalGas += farm.gasPerSecond * (1 + minerData.upgrades.speed * 0.1);
                    totalEnergy += farm.energyCost * (1 - minerData.upgrades.efficiency * 0.2);
                }
            });
            
            minerData.gasPerSecond = totalGas;
            
            // Проверяем энергию
            if (totalEnergy > minerData.energy) {
                minerData.gasPerSecond *= 0.5; // Снижаем генерацию при нехватке энергии
            }
        }

        function startMiningLoop() {
            setInterval(() => {
                if (minerData.gasPerSecond > 0) {
                    const gasEarned = minerData.gasPerSecond / 10; // Обновляем 10 раз в секунду
                    minerData.ndnGas += gasEarned;
                    minerData.totalGasEarned += gasEarned;
                    
                    // Потребляем энергию
                    const energyConsumption = minerData.farms.reduce((total, farm) => {
                        const farmType = farmTypes.find(f => f.id === farm.type);
                        return total + (farmType ? farm.energyCost * (1 - minerData.upgrades.efficiency * 0.2) : 0);
                    }, 0) / 10;
                    
                    minerData.energy = Math.max(0, minerData.energy - energyConsumption);
                    
                    // Восстанавливаем энергию
                    if (minerData.energy < minerData.maxEnergy) {
                        minerData.energy = Math.min(minerData.maxEnergy, minerData.energy + 0.1);
                    }
                    
                    updateMinerUI();
                }
            }, 100);
        }

        function loadUpgrades(category) {
            const container = document.getElementById('upgradesContent');
            if (!container) return;
            
            const upgrades = upgradeTypes[category] || [];
            const currentLevel = minerData.upgrades[category] || 0;
            
            container.innerHTML = upgrades.map((upgrade, index) => {
                const isUnlocked = index <= currentLevel;
                const canAfford = minerData.ndnGas >= upgrade.cost;
                const isMaxLevel = index === upgrades.length - 1;
                
                return `
                    <div class="upgrade-item ${isUnlocked ? 'unlocked' : ''}">
                        <div class="upgrade-info">
                            <div class="upgrade-name">${upgrade.name}</div>
                            <div class="upgrade-description">${upgrade.description}</div>
                            <div class="upgrade-cost">Стоимость: ${upgrade.cost} Gas</div>
                        </div>
                        <button class="upgrade-button" 
                                onclick="buyUpgrade('${category}', ${index})" 
                                ${!canAfford || isUnlocked || isMaxLevel ? 'disabled' : ''}>
                            ${isUnlocked ? 'Куплено' : isMaxLevel ? 'Макс. уровень' : canAfford ? 'Купить' : 'Недостаточно Gas'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function buyUpgrade(category, index) {
            const upgrade = upgradeTypes[category][index];
            if (!upgrade) return;
            
            if (minerData.ndnGas < upgrade.cost) {
                showNotification('Недостаточно NDN Gas!', 'error');
                return;
            }
            
            // Покупаем улучшение
            minerData.ndnGas -= upgrade.cost;
            minerData.upgrades[category] = index + 1;
            
            // Пересчитываем генерацию
            calculateGasPerSecond();
            
            // Обновляем UI
            updateMinerUI();
            loadUpgrades(category);
            
            // Сохраняем данные
            saveMinerData();
            
            showNotification(`Куплено улучшение: ${upgrade.name}!`, 'success');
        }

        function switchUpgradeTab(category) {
            // Убираем активный класс со всех вкладок
            document.querySelectorAll('.upgrade-tab').forEach(tab => tab.classList.remove('active'));
            
            // Активируем выбранную вкладку
            document.querySelector(`[onclick="switchUpgradeTab('${category}')"]`).classList.add('active');
            
            // Загружаем улучшения
            loadUpgrades(category);
        }

        function loadShop() {
            const container = document.getElementById('shopItems');
            if (!container) return;
            
            const shopItems = [
                {
                    name: 'Энергетический напиток',
                    icon: '⚡',
                    description: 'Восстанавливает 50 энергии',
                    cost: 25,
                    currency: 'Gas',
                    action: 'restoreEnergy'
                },
                {
                    name: 'Премиум ускоритель',
                    icon: '🚀',
                    description: '2x скорость на 1 час',
                    cost: 100,
                    currency: 'NDN',
                    action: 'speedBoost',
                    premium: true
                },
                {
                    name: 'Золотая ферма',
                    icon: '🏆',
                    description: 'Эксклюзивная ферма',
                    cost: 500,
                    currency: 'NDN',
                    action: 'goldenFarm',
                    premium: true
                }
            ];
            
            container.innerHTML = shopItems.map(item => `
                <div class="shop-item ${item.premium ? 'premium' : ''}">
                    <div class="shop-icon">${item.icon}</div>
                    <div class="shop-name">${item.name}</div>
                    <div class="shop-description">${item.description}</div>
                    <div class="shop-cost">${item.cost} ${item.currency}</div>
                    <button class="shop-button ${item.premium ? 'premium' : ''}" 
                            onclick="buyShopItem('${item.action}', ${item.cost}, '${item.currency}')">
                        Купить
                    </button>
                </div>
            `).join('');
        }

        function buyShopItem(action, cost, currency) {
            if (currency === 'Gas' && minerData.ndnGas < cost) {
                showNotification('Недостаточно NDN Gas!', 'error');
                return;
            }
            
            if (currency === 'NDN' && (!userData || userData.balance_ndn < cost)) {
                showNotification('Недостаточно NDN!', 'error');
                return;
            }
            
            // Выполняем действие
            switch (action) {
                case 'restoreEnergy':
                    minerData.energy = Math.min(minerData.maxEnergy, minerData.energy + 50);
                    minerData.ndnGas -= cost;
                    showNotification('Энергия восстановлена!', 'success');
                    break;
                case 'speedBoost':
                    // TODO: Реализовать временный буст
                    showNotification('Ускоритель активирован!', 'success');
                    break;
                case 'goldenFarm':
                    // TODO: Реализовать золотую ферму
                    showNotification('Золотая ферма добавлена!', 'success');
                    break;
            }
            
            updateMinerUI();
            saveMinerData();
        }

        function saveMinerData() {
            try {
                localStorage.setItem('nodeon_miner_data', JSON.stringify(minerData));
            } catch (e) {
                console.warn('Ошибка сохранения данных майнера:', e);
            }
        }

        // Система уведомлений
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">${icons[type] || icons.info}</div>
                    <div class="notification-text">${message}</div>
                    <button class="notification-close" onclick="hideNotification(this)">×</button>
                </div>
            `;

            container.appendChild(notification);

            // Показываем уведомление
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Автоматически скрываем
            setTimeout(() => {
                hideNotification(notification.querySelector('.notification-close'));
            }, duration);
        }

        function hideNotification(closeButton) {
            const notification = closeButton.closest('.notification');
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        // Система напоминаний
        function checkReminders() {
            const today = new Date().getDay() + 1;
            const claimedToday = gameData.dailyRewards.includes(today);
            const dailyReminder = document.getElementById('dailyReminder');
            
            if (dailyReminder) {
                if (!claimedToday) {
                    dailyReminder.style.display = 'block';
                } else {
                    dailyReminder.style.display = 'none';
                }
            }

            // Проверяем другие напоминания
            checkAchievementReminders();
            checkLevelUpReminders();
        }

        function checkAchievementReminders() {
            const achievements = [
                {
                    id: 'first_login',
                    condition: userData ? 1 : 0,
                    required: 1,
                    message: 'Выполните первое достижение - войдите в игру!'
                },
                {
                    id: 'pro_user',
                    condition: userData && userData.is_pro ? 1 : 0,
                    required: 1,
                    message: 'Купите Pro статус и получите бонус!'
                },
                {
                    id: 'referral_master',
                    condition: Math.min(gameData.stats.totalReferrals, 5),
                    required: 5,
                    message: `Пригласите еще ${5 - gameData.stats.totalReferrals} друзей для получения достижения!`
                }
            ];

            achievements.forEach(achievement => {
                if (achievement.condition < achievement.required) {
                    // Показываем напоминание только раз в день
                    const reminderKey = `reminder_${achievement.id}`;
                    const lastShown = localStorage.getItem(reminderKey);
                    const today = new Date().toDateString();
                    
                    if (lastShown !== today) {
                        setTimeout(() => {
                            showNotification(achievement.message, 'info', 5000);
                            localStorage.setItem(reminderKey, today);
                        }, 2000);
                    }
                }
            });
        }

        function checkLevelUpReminders() {
            const xpForNextLevel = gameData.level * 100;
            const currentLevelXP = (gameData.level - 1) * 100;
            const xpNeeded = xpForNextLevel - gameData.xp;
            
            if (xpNeeded <= 50 && xpNeeded > 0) {
                const reminderKey = 'level_up_reminder';
                const lastShown = localStorage.getItem(reminderKey);
                const today = new Date().toDateString();
                
                if (lastShown !== today) {
                    setTimeout(() => {
                        showNotification(`До следующего уровня осталось ${xpNeeded} XP!`, 'info', 4000);
                        localStorage.setItem(reminderKey, today);
                    }, 3000);
                }
            }
        }

        // Звуковые эффекты
        function playSound(type) {
            // В реальном приложении здесь будут звуковые файлы
            console.log(`Playing sound: ${type}`);
        }

        // Система локализации
        async function loadTranslations(language = 'ru') {
            try {
                const response = await fetch(`/api/translations/${language}`);
                if (response.ok) {
                    const data = await response.json();
                    translations[language] = data.translations;
                    console.log(`✅ Translations loaded for ${language}`);
                    return true;
                } else {
                    console.warn(`⚠️ Failed to load translations for ${language}`);
                    return false;
                }
            } catch (error) {
                console.error(`❌ Error loading translations for ${language}:`, error);
                return false;
            }
        }

        async function loadSupportedLanguages() {
            try {
                const response = await fetch('/api/language/supported');
                if (response.ok) {
                    const data = await response.json();
                    supportedLanguages = data.languages;
                    console.log('✅ Supported languages loaded:', supportedLanguages);
                    return true;
                } else {
                    console.warn('⚠️ Failed to load supported languages');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error loading supported languages:', error);
                return false;
            }
        }

        async function detectUserLanguage() {
            try {
                const response = await fetch('/api/language/detect', {
                    headers: {
                        'tma': tg.initData || ''
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.detected) {
                        currentLanguage = data.language;
                        console.log(`🌍 Language detected: ${currentLanguage} (from ${data.telegram_language})`);
                        return data.language;
                    }
                }
                console.log('ℹ️ Using default language: ru');
                return 'ru';
            } catch (error) {
                console.error('❌ Error detecting language:', error);
                return 'ru';
            }
        }

        function t(key, params = {}) {
            const keys = key.split('.');
            let current = translations[currentLanguage] || translations['ru'] || {};
            
            for (const k of keys) {
                if (current && typeof current === 'object' && k in current) {
                    current = current[k];
                } else {
                    // Fallback на русский
                    current = translations['ru'] || {};
                    for (const k of keys) {
                        if (current && typeof current === 'object' && k in current) {
                            current = current[k];
                        } else {
                            return key;
                        }
                    }
                    break;
                }
            }
            
            let result = typeof current === 'string' ? current : key;
            
            // Подстановка параметров
            if (params && Object.keys(params).length > 0) {
                try {
                    result = result.replace(/\{(\w+)\}/g, (match, param) => {
                        return params[param] || match;
                    });
                } catch (e) {
                    console.warn('Error formatting translation:', e);
                }
            }
            
            return result;
        }

        async function changeLanguage(language) {
            if (language === currentLanguage) return;
            
            console.log(`🔄 Changing language to ${language}`);
            currentLanguage = language;
            
            // Загружаем переводы если их нет
            if (!translations[language]) {
                await loadTranslations(language);
            }
            
            // Обновляем UI
            updateLanguage();
            
            // Обновляем открытые модальные окна
            updateModalTranslations();
            
            // Сохраняем выбор пользователя
            localStorage.setItem('nodeon_language', language);
        }

        function updateLanguage() {
            console.log(`🔄 Updating UI for language: ${currentLanguage}`);
            
            // Обновляем все элементы с data-i18n (включая скрытые)
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const text = t(key);
                if (text && text !== key) {
                    element.textContent = text;
                }
            });
            
            // Обновляем placeholder'ы
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                const text = t(key);
                if (text && text !== key) {
                    element.placeholder = text;
                }
            });
            
            // Обновляем title'ы
            document.querySelectorAll('[data-i18n-title]').forEach(element => {
                const key = element.getAttribute('data-i18n-title');
                const text = t(key);
                if (text && text !== key) {
                    element.title = text;
                }
            });
            
            // Обновляем innerHTML для элементов с HTML содержимым
            document.querySelectorAll('[data-i18n-html]').forEach(element => {
                const key = element.getAttribute('data-i18n-html');
                const text = t(key);
                if (text && text !== key) {
                    element.innerHTML = text;
                }
            });
            
            // Принудительно обновляем модальные окна
            updateModalTranslations();
            
            console.log(`✅ UI updated for language: ${currentLanguage}`);
        }

        function updateModalTranslations() {
            // Обновляем все модальные окна (включая динамически созданные)
            const allModals = document.querySelectorAll('.modal');
            
            allModals.forEach(modal => {
                // Обновляем элементы внутри модального окна
                modal.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    const text = t(key);
                    if (text && text !== key) {
                        // Специальная обработка для элементов с данными
                        if (element.hasAttribute('data-level') && element.hasAttribute('data-count')) {
                            const level = element.getAttribute('data-level');
                            const count = element.getAttribute('data-count');
                            element.textContent = text.replace('{level}', level).replace('{count}', count);
                        } else if (element.hasAttribute('data-level')) {
                            const level = element.getAttribute('data-level');
                            element.textContent = text.replace('{level}', level);
                        } else if (element.hasAttribute('data-count')) {
                            const count = element.getAttribute('data-count');
                            element.textContent = text.replace('{count}', count);
                        } else if (element.hasAttribute('data-earnings')) {
                            const earnings = element.getAttribute('data-earnings');
                            element.textContent = text.replace('{earnings}', earnings);
                        } else {
                            element.textContent = text;
                        }
                    }
                });
                
                modal.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    const text = t(key);
                    if (text && text !== key) {
                        element.placeholder = text;
                    }
                });
            });
        }

        // Извлекаем реферальный токен из URL
        function extractReferralToken() {
            try {
                // Получаем параметры из Telegram WebApp
                const initData = tg.initData;
                if (initData) {
                    const urlParams = new URLSearchParams(initData);
                    const startParam = urlParams.get('start_param');
                    if (startParam && startParam.startsWith('ref_')) {
                        referralToken = startParam;
                        console.log('🔗 Referral token found:', referralToken);
                        return referralToken;
                    }
                }
                
                // Fallback: проверяем window.location
                const urlParams = new URLSearchParams(window.location.search);
                const startParam = urlParams.get('start_param');
                if (startParam && startParam.startsWith('ref_')) {
                    referralToken = startParam;
                    console.log('🔗 Referral token found in URL:', referralToken);
                    return referralToken;
                }
                
                console.log('ℹ️ No referral token found');
                return null;
            } catch (error) {
                console.error('Error extracting referral token:', error);
                return null;
            }
        }

        // Создание частиц
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Создание искр
        function createSparkles() {
            const sparkleCount = 10;
            for (let i = 0; i < sparkleCount; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.top = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 1.5 + 's';
                document.body.appendChild(sparkle);
                
                setTimeout(() => {
                    sparkle.remove();
                }, 1500);
            }
        }

        // Звуковые эффекты
        function playSound(type) {
            // Создаем простые звуковые эффекты через Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'click':
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'success':
                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'error':
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
            }
        }

        // Показать уведомление
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Показать загрузку
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        // Скрыть загрузку
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Открыть модальное окно
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            playSound('click');
        }

        // Закрыть модальное окно
        // Показать модальное окно
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Обновляем переводы перед показом модального окна
                updateModalTranslations();
                modal.style.display = 'flex';
                console.log(`Modal ${modalId} shown`);
            } else {
                console.error(`Modal ${modalId} not found`);
            }
        }

        function closeModal(modalElement) {
            if (typeof modalElement === 'string') {
                // Если передан ID
                const modal = document.getElementById(modalElement);
                if (modal) {
                    modal.style.display = 'none';
                }
            } else if (modalElement && modalElement.style) {
                // Если передан элемент
                modalElement.style.display = 'none';
            }
            playSound('click');
        }

        // Инициализация локализации
        async function initializeLocalization() {
            try {
                console.log('🌍 Initializing localization...');
                
                // Загружаем поддерживаемые языки
                await loadSupportedLanguages();
                
                // Определяем язык пользователя
                const detectedLanguage = await detectUserLanguage();
                
                // Проверяем сохраненный выбор пользователя
                const savedLanguage = localStorage.getItem('nodeon_language');
                if (savedLanguage && supportedLanguages.includes(savedLanguage)) {
                    currentLanguage = savedLanguage;
                    console.log(`💾 Using saved language: ${currentLanguage}`);
                } else {
                    currentLanguage = detectedLanguage;
                    console.log(`🔍 Using detected language: ${currentLanguage}`);
                }
                
                // Загружаем переводы для текущего языка
                await loadTranslations(currentLanguage);
                
                // Загружаем русский как fallback
                if (currentLanguage !== 'ru') {
                    await loadTranslations('ru');
                }
                
                // Обновляем селектор языка
                const languageSelect = document.getElementById('languageSelect');
                if (languageSelect) {
                    languageSelect.value = currentLanguage;
                }
                
                // Обновляем UI
                updateLanguage();
                
                console.log(`✅ Localization initialized for: ${currentLanguage}`);
            } catch (error) {
                console.error('❌ Error initializing localization:', error);
                // Fallback на русский
                currentLanguage = 'ru';
                await loadTranslations('ru');
                updateLanguage();
            }
        }

        // Загрузка данных пользователя
        async function loadUserData() {
            console.log('📥 Начинаем загрузку данных пользователя...');
            try {
                showLoading();
                
                // Инициализация локализации
                console.log('🌐 Инициализируем локализацию...');
                await initializeLocalization();
                
                // Извлекаем реферальный токен
                referralToken = extractReferralToken();
                
                // Проверяем, есть ли данные Telegram
                const initData = tg.initData;
                const isTelegram = tg.platform !== 'unknown' && tg.platform !== 'web' && initData && initData.trim() !== '';
                
                console.log('Telegram WebApp данные:', {
                    platform: tg.platform,
                    initData: initData ? 'есть' : 'нет',
                    user: tg.initDataUnsafe?.user,
                    referralToken: referralToken
                });
                
                if (isTelegram) {
                    // Режим Telegram - используем реальные данные
                    console.log('Telegram режим: загружаем данные пользователя');
                    console.log('initData:', initData);
                    
                    try {
                        // Формируем URL с реферальным токеном
                        let profileUrl = '/api/user/profile';
                        if (referralToken) {
                            profileUrl += `?referral_token=${encodeURIComponent(referralToken)}`;
                        }
                        
                        const response = await fetch(profileUrl, {
                            method: 'GET',
                            headers: {
                                'Authorization': `tma ${initData}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        console.log('Response status:', response.status);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('API Error:', errorText);
                            
                            // Если пользователь не найден, создаем его
                            if (response.status === 404) {
                                console.log('Пользователь не найден, создаем нового...');
                                const unsafeUser = tg.initDataUnsafe?.user;
                                if (unsafeUser && unsafeUser.id) {
                                    // Создаем пользователя через API
                                    const createResponse = await fetch('/api/user/create', {
                                        method: 'POST',
                                        headers: {
                                            'Authorization': `tma ${initData}`,
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            telegram_id: unsafeUser.id,
                                            username: unsafeUser.username || '',
                                            first_name: unsafeUser.first_name || 'Пользователь',
                                            last_name: unsafeUser.last_name || ''
                                        })
                                    });
                                    
                                    if (createResponse.ok) {
                                        const createData = await createResponse.json();
                                        if (createData.success && createData.user) {
                                            userData = createData.user;
                                            console.log('Пользователь создан:', userData);
                                            updateUI();
                                            showNotification(`Добро пожаловать, ${userData.first_name}!`, 'success');
                                            playSound('success');
                                            return;
                                        } else {
                                            console.log('Создание не удалось, пробуем загрузить пользователя...');
                                        }
                                    } else {
                                        // Если создание не удалось, попробуем загрузить пользователя
                                        console.log('Создание не удалось, пробуем загрузить пользователя...');
                                        const retryResponse = await fetch('/api/user/profile', {
                                            method: 'GET',
                                            headers: {
                                                'Authorization': `tma ${initData}`,
                                                'Content-Type': 'application/json'
                                            }
                                        });
                                        
                                        if (retryResponse.ok) {
                                            const retryData = await retryResponse.json();
                                            if (retryData.success && retryData.user) {
                                                userData = retryData.user;
                                                console.log('Пользователь загружен после создания:', userData);
                                                updateUI();
                                                showNotification(`Добро пожаловать, ${userData.first_name}!`, 'success');
                                                playSound('success');
                                                return;
                                            }
                                        }
                                    }
                                }
                            }
                            
                            throw new Error(`Ошибка загрузки данных пользователя: ${response.status}`);
                        }

                        const responseData = await response.json();
                        console.log('Получены данные от API:', responseData);
                        
                        if (responseData.success && responseData.user) {
                            userData = responseData.user;
                            console.log('✅ Данные пользователя установлены:', userData);
                            console.log('📊 userData.telegram_id:', userData.telegram_id);
                            console.log('👤 userData.first_name:', userData.first_name);
                            console.log('💰 userData.balance_ndn:', userData.balance_ndn);
                            console.log('🆔 userData.id:', userData.id);
                            
                            console.log('🔄 Вызываем updateUI...');
                            updateUI();
                            
                            // Дополнительное обновление UI через небольшую задержку
                            setTimeout(() => {
                                console.log('🔄 Повторное обновление UI...');
                                updateUI();
                            }, 100);
                            
                            checkAdminStatus(); // Проверяем админ статус
                            showNotification(`Добро пожаловать, ${userData.first_name || 'Пользователь'}!`, 'success');
                            playSound('success');
                        } else {
                            throw new Error('Неверный формат ответа от API');
                        }
                    } catch (error) {
                        console.error('Ошибка загрузки данных пользователя:', error);
                        
                        // Fallback - используем данные из initDataUnsafe
                        const unsafeUser = tg.initDataUnsafe?.user;
                        if (unsafeUser && unsafeUser.id) {
                            console.log('Используем fallback данные из initDataUnsafe');
                            userData = {
                                id: unsafeUser.id,
                                telegram_id: unsafeUser.id,
                                username: unsafeUser.username || '',
                                first_name: unsafeUser.first_name || 'Пользователь',
                                last_name: unsafeUser.last_name || '',
                                balance_ndn: 0.0,
                                is_pro: false,
                                referral_link: `https://t.me/test_bot?start=ref_${unsafeUser.id}`
                            };
                            
                            console.log('Fallback userData установлен:', userData);
                            updateUI();
                            showNotification(`Добро пожаловать, ${userData.first_name}! (Fallback)`, 'success');
                            playSound('success');
                            return;
                        }
                        
                        throw error;
                    }
                    
                } else {
                    // Проверяем, есть ли данные пользователя в tg.initDataUnsafe
                    const unsafeUser = tg.initDataUnsafe?.user;
                    if (unsafeUser && unsafeUser.id) {
                        console.log('Найдены данные пользователя в initDataUnsafe:', unsafeUser);
                        
                        // Создаем пользователя на основе данных Telegram
                        userData = {
                            id: unsafeUser.id,
                            telegram_id: unsafeUser.id,
                            username: unsafeUser.username,
                            first_name: unsafeUser.first_name,
                            last_name: unsafeUser.last_name,
                            balance_ndn: 0.0, // NDN покупается только за Stars
                            is_pro: false,
                            referral_link: `https://t.me/test_bot?start=ref_${unsafeUser.id}`
                        };
                        
                        updateUI();
                        showNotification(`Добро пожаловать, ${userData.first_name}! (Telegram данные)`, 'success');
                        playSound('success');
                        return;
                    }
                    
                    // Режим браузера - создаем тестового пользователя
                    console.log('Браузер режим: создаем тестового пользователя');
                    
                    // Пытаемся получить данные из localStorage
                    const savedUser = localStorage.getItem('nodeon_test_user');
                    if (savedUser) {
                        userData = JSON.parse(savedUser);
                        console.log('Загружены сохраненные данные пользователя');
                    } else {
                        // Создаем нового тестового пользователя
                        userData = {
                            id: Math.floor(Math.random() * 10000) + 1,
                            telegram_id: Math.floor(Math.random() * 1000000000) + 100000000,
                            username: 'test_user_' + Math.floor(Math.random() * 1000),
                            first_name: 'Тестовый',
                            last_name: 'Пользователь',
                            balance_ndn: 0.0, // NDN покупается только за Stars
                            is_pro: false, // Pro статус покупается за NDN
                            referral_link: `https://t.me/test_bot?start=ref_${Math.floor(Math.random() * 1000000)}`,
                            created_at: new Date().toISOString()
                        };
                        
                        // Сохраняем в localStorage
                        localStorage.setItem('nodeon_test_user', JSON.stringify(userData));
                        console.log('Создан новый тестовый пользователь');
                    }
                    
                    updateUI();
                    showNotification(`Добро пожаловать, ${userData.first_name}! (Тестовый режим)`, 'warning');
                    playSound('success');
                    
                    // Показываем тестовые функции в браузере
                    const testFunctions = document.getElementById('testFunctions');
                    if (testFunctions) {
                        testFunctions.style.display = 'block';
                    }
                }
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                
                // Fallback - создаем тестового пользователя
                console.log('Fallback: создаем тестового пользователя');
                userData = {
                    id: 1,
                    telegram_id: 123456789,
                    username: 'fallback_user',
                    first_name: 'Пользователь',
                    last_name: 'Fallback',
                    balance_ndn: 0.0, // NDN покупается только за Stars
                    is_pro: false,
                    referral_link: 'https://t.me/test_bot?start=ref_fallback'
                };
                updateUI();
                showNotification('Загружены базовые данные пользователя', 'warning');
                playSound('success');
            } finally {
                hideLoading();
            }
        }

        // Обновление UI
        function updateUI() {
            console.log('updateUI вызвана, userData:', userData);
            if (userData) {
                console.log('Обновляем UI с данными:', {
                    first_name: userData.first_name,
                    telegram_id: userData.telegram_id,
                    balance_ndn: userData.balance_ndn
                });
                
                // Обновляем локализацию
                updateLanguage();
                
                // Обновляем балансы
                const ndnBalanceElement = document.getElementById('ndnBalance');
                const modalNdnBalanceElement = document.getElementById('modalNdnBalance');
                
                console.log('Элементы баланса:', {
                    ndnBalanceElement: !!ndnBalanceElement,
                    modalNdnBalanceElement: !!modalNdnBalanceElement
                });
                
                if (ndnBalanceElement) {
                    const balanceValue = (userData.balance_ndn || 0).toFixed(2);
                    ndnBalanceElement.textContent = balanceValue;
                    ndnBalanceElement.innerHTML = balanceValue; // Принудительное обновление
                    console.log('✅ Баланс NDN обновлен:', balanceValue);
                } else {
                    console.error('❌ Элемент ndnBalance не найден!');
                    // Попробуем найти элемент еще раз
                    const retryElement = document.getElementById('ndnBalance');
                    if (retryElement) {
                        retryElement.textContent = (userData.balance_ndn || 0).toFixed(2);
                        console.log('✅ Баланс NDN обновлен при повторной попытке');
                    }
                }
                
                if (modalNdnBalanceElement) {
                    modalNdnBalanceElement.textContent = (userData.balance_ndn || 0).toFixed(2);
                } else {
                    console.error('Элемент modalNdnBalance не найден!');
                }
                
                // Обновляем игровые данные
                updateGameData();
                
                // Обновляем игровой ID
                const userIdElement = document.getElementById('userId');
                if (userIdElement) {
                    userIdElement.textContent = userData.id || '-';
                    console.log('Игровой ID обновлен:', userData.id || '-');
                } else {
                    console.error('Элемент userId не найден!');
                }
                
                // Обновляем заголовок с именем пользователя
                const welcomeTitle = document.querySelector('.subtitle');
                if (welcomeTitle) {
                    const proStatus = userData.is_pro ? ' 💎 PRO' : '';
                    const welcomeText = `Добро пожаловать, ${userData.first_name || 'Пользователь'}!${proStatus}`;
                    welcomeTitle.textContent = welcomeText;
                    welcomeTitle.innerHTML = welcomeText; // Принудительное обновление
                    console.log('✅ Заголовок обновлен:', welcomeText);
                } else {
                    console.error('❌ Элемент .subtitle не найден!');
                    // Попробуем найти элемент еще раз
                    const retryTitle = document.querySelector('.subtitle');
                    if (retryTitle) {
                        const proStatus = userData.is_pro ? ' 💎 PRO' : '';
                        const welcomeText = `Добро пожаловать, ${userData.first_name || 'Пользователь'}!${proStatus}`;
                        retryTitle.textContent = welcomeText;
                        console.log('✅ Заголовок обновлен при повторной попытке');
                    }
                }
                
                // Обновляем кнопку Pro статуса
                const buyProButton = document.querySelector('button[onclick="buyPro()"]');
                if (buyProButton) {
                    if (userData.is_pro) {
                        buyProButton.innerHTML = '💎 Pro статус активирован';
                        buyProButton.disabled = true;
                        buyProButton.style.opacity = '0.7';
                    } else {
                        buyProButton.innerHTML = '💎 Купить Pro статус';
                        buyProButton.disabled = false;
                        buyProButton.style.opacity = '1';
                    }
                }
                
                // Показываем/скрываем PRO функции
                const proFunctionsCard = document.getElementById('proFunctionsCard');
                console.log('PRO Functions Debug:', {
                    userData_is_pro: userData.is_pro,
                    proFunctionsCard_found: !!proFunctionsCard,
                    proFunctionsCard_current_display: proFunctionsCard ? proFunctionsCard.style.display : 'element not found'
                });
                
                if (proFunctionsCard) {
                    proFunctionsCard.style.display = userData.is_pro ? 'block' : 'none';
                    console.log('PRO Functions Card display set to:', proFunctionsCard.style.display);
                } else {
                    console.error('PRO Functions Card element not found!');
                }
                
                // Показываем информацию о пользователе в консоли
                console.log('Данные пользователя обновлены:', {
                    name: userData.first_name,
                    username: userData.username,
                    balance_ndn: userData.balance_ndn,
                    is_pro: userData.is_pro,
                    referral_link: userData.referral_link
                });
            }
        }

        // Обновление данных пользователя после операций
        function updateUserData(newData) {
            if (userData && newData) {
                // Обновляем данные
                Object.assign(userData, newData);
                
                // Сохраняем в localStorage для тестового режима
                if (localStorage.getItem('nodeon_test_user')) {
                    localStorage.setItem('nodeon_test_user', JSON.stringify(userData));
                }
                
                // Обновляем UI
                updateUI();
                
                console.log('Данные пользователя обновлены:', newData);
            }
        }

        // Проверка админ статуса
        async function checkAdminStatus() {
            try {
                const response = await fetch('/api/admin/check-status', {
                    headers: {
                        'Authorization': `tma ${tg.initData}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.is_admin) {
                        showAdminPanel(data);
                    }
                }
            } catch (error) {
                console.log('Admin status check failed:', error);
            }
        }

        // Показать админ панель
        function showAdminPanel(adminData) {
            const adminCard = document.getElementById('adminPanelCard');
            const adminStatus = document.getElementById('adminStatus');
            
            if (adminCard && adminStatus) {
                adminCard.style.display = 'block';
                adminStatus.textContent = `Статус: ${adminData.status_name}`;
                
                // Загружаем данные админ панели
                loadAdminDashboard();
                
                // Показываем кнопки в зависимости от прав
                if (adminData.permissions.can_manage_exchanges) {
                    document.getElementById('exchangeRequestsBtn').style.display = 'block';
                }
                if (adminData.permissions.can_manage_users) {
                    document.getElementById('userManagementBtn').style.display = 'block';
                }
                if (adminData.permissions.can_view_analytics) {
                    document.getElementById('analyticsBtn').style.display = 'block';
                }
            }
        }

        // Загрузить данные админ панели
        async function loadAdminDashboard() {
            try {
                const response = await fetch('/api/admin/dashboard', {
                    headers: {
                        'Authorization': `tma ${window.Telegram?.WebApp?.initData || ''}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateAdminDashboard(data);
                    }
                }
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }

        // Обновить данные админ панели
        function updateAdminDashboard(data) {
            // Обновляем статистику серверного кошелька
            if (data.wallet) {
                document.getElementById('walletBalance').textContent = formatNumber(data.wallet.balance_ndn) + ' NDN';
                document.getElementById('starsReceived').textContent = formatNumber(data.wallet.total_stars_received) + ' ⭐';
                document.getElementById('ndnExchanged').textContent = formatNumber(data.wallet.total_ndn_exchanged) + ' NDN';
                document.getElementById('starsSent').textContent = formatNumber(data.wallet.total_stars_sent) + ' ⭐';
                document.getElementById('walletStats').style.display = 'block';
            }
            
            // Обновляем общую статистику
            if (data.stats) {
                document.getElementById('totalUsers').textContent = data.stats.total_users;
                document.getElementById('proUsers').textContent = data.stats.total_pro_users;
                document.getElementById('ndnInCirculation').textContent = formatNumber(data.stats.total_ndn_in_circulation) + ' NDN';
                document.getElementById('totalReferrals').textContent = data.stats.total_referrals;
                document.getElementById('systemStats').style.display = 'block';
            }
        }

        // Форматировать числа
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }

        // Показать заявки на обмен
        async function showExchangeRequests() {
            try {
                const response = await fetch('/api/admin/exchange-requests', {
                    headers: {
                        'Authorization': `tma ${tg.initData}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showExchangeRequestsModal(data.requests);
                    } else {
                        showNotification('Ошибка загрузки заявок', 'error');
                    }
                } else {
                    showNotification('Нет доступа к заявкам', 'error');
                }
            } catch (error) {
                console.error('Error loading exchange requests:', error);
                showNotification('Ошибка соединения', 'error');
            }
        }

        // Модальное окно заявок на обмен
        function showExchangeRequestsModal(requests) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">💰 Заявки на обмен NDN</div>
                        <div class="modal-subtitle">Управление заявками на обмен NDN на Telegram Stars</div>
                    </div>
                    
                    <div class="exchange-requests-content">
                        ${requests.length > 0 ? 
                            requests.map(req => `
                                <div class="exchange-request-item">
                                    <div class="request-info">
                                        <div class="request-user">@${req.telegram_username}</div>
                                        <div class="request-amount">${req.amount_ndn} NDN → ${req.amount_stars} ⭐</div>
                                        <div class="request-date">${new Date(req.created_at).toLocaleString('ru-RU')}</div>
                                        <div class="request-status status-${req.status}">${getStatusText(req.status)}</div>
                                    </div>
                                    <div class="request-actions">
                                        ${req.status === 'pending' ? `
                                            <button class="button button-success" onclick="approveExchangeRequest(${req.id})">
                                                ✅ Одобрить
                                            </button>
                                            <button class="button button-danger" onclick="rejectExchangeRequest(${req.id})">
                                                ❌ Отклонить
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('') :
                            '<div class="no-requests">Нет заявок на обмен</div>'
                        }
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="closeModal(this.closest('.modal'))">← Назад</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            playSound('success');
        }

        // Получить текст статуса
        function getStatusText(status) {
            const statusTexts = {
                'pending': 'Ожидает',
                'approved': 'Одобрена',
                'rejected': 'Отклонена',
                'completed': 'Выполнена'
            };
            return statusTexts[status] || status;
        }

        // Одобрить заявку на обмен
        async function approveExchangeRequest(requestId) {
            try {
                const response = await fetch(`/api/admin/exchange-requests/${requestId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${tg.initData}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification('Заявка одобрена', 'success');
                        showExchangeRequests(); // Обновляем список
                    } else {
                        showNotification(data.message || 'Ошибка одобрения', 'error');
                    }
                } else {
                    showNotification('Ошибка сервера', 'error');
                }
            } catch (error) {
                console.error('Error approving request:', error);
                showNotification('Ошибка соединения', 'error');
            }
        }

        // Отклонить заявку на обмен
        async function rejectExchangeRequest(requestId) {
            try {
                const response = await fetch(`/api/admin/exchange-requests/${requestId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${tg.initData}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification('Заявка отклонена', 'success');
                        showExchangeRequests(); // Обновляем список
                    } else {
                        showNotification(data.message || 'Ошибка отклонения', 'error');
                    }
                } else {
                    showNotification('Ошибка сервера', 'error');
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                showNotification('Ошибка соединения', 'error');
            }
        }

        // Управление пользователями (заглушка)
        function showUserManagement() {
            showNotification('Функция в разработке', 'info');
        }

        // Аналитика (заглушка)
        function showAnalytics() {
            showNotification('Функция в разработке', 'info');
        }

        // Покупка Pro статуса
        function buyPro() {
            if (!userData) {
                showNotification('Сначала загрузите данные пользователя', 'error');
                return;
            }
            
            if (userData.balance_ndn < 1000) {
                showNotification('Недостаточно NDN для покупки Pro статуса', 'error');
                playSound('error');
                return;
            }
            
            openModal('buyProModal');
        }

        // Подтверждение покупки Pro
        async function confirmBuyPro() {
            try {
                showLoading();
                playSound('click');
                
                const initData = tg.initData;
                const response = await fetch('/api/pro/buy', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${initData}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка покупки Pro статуса');
                }

                const result = await response.json();
                showNotification('Pro статус успешно активирован!', 'success');
                playSound('success');
                createSparkles();
                
                // Обновляем данные пользователя
                updateUserData({
                    is_pro: true,
                    balance_ndn: userData.balance_ndn - 1000
                });
                
                closeModal('buyProModal');
                
            } catch (error) {
                console.error('Ошибка покупки Pro:', error);
                showNotification('Ошибка покупки Pro статуса', 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Покупка NDN
        function buyNDN() {
            openModal('buyNDNModal');
        }

        // Обновление стоимости в Stars
        function updateStarsCost() {
            const ndnAmount = document.getElementById('ndnAmount').value;
            document.getElementById('starsCost').textContent = ndnAmount || '0';
        }

        // Подтверждение покупки NDN через Telegram Stars
        async function confirmBuyNDN() {
            const amount = document.getElementById('ndnAmount').value;
            if (!amount || amount < 1) {
                showNotification('Введите корректное количество NDN', 'error');
                return;
            }

            if (amount > 10000) {
                showNotification('Максимальная сумма: 10,000 NDN', 'error');
                return;
            }

            try {
                showLoading();
                playSound('click');
                
                const initData = tg.initData;
                const response = await fetch('/api/payments/create-invoice', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount_ndn: parseInt(amount),
                        description: `Покупка ${amount} NDN за ${amount} Telegram Stars`
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка создания счета');
                }

                const result = await response.json();
                
                if (!result.invoice_link) {
                    throw new Error('Ссылка на счет не получена');
                }
                
                // Открываем счет через Telegram Mini App
                if (typeof tg !== 'undefined' && tg.openInvoice) {
                    tg.openInvoice(result.invoice_link, (status) => {
                        hideLoading();
                        
                        if (status === 'paid') {
                            showNotification('✅ Платеж успешно завершен! NDN зачислены на ваш счет.', 'success');
                            playSound('success');
                            createSparkles();
                            
                            // Обновляем данные пользователя
                            loadUserData();
                        } else if (status === 'cancelled') {
                            showNotification('Платеж отменен', 'warning');
                        } else if (status === 'failed') {
                            showNotification('Ошибка платежа', 'error');
                            playSound('error');
                        }
                    });
                } else {
                    // Fallback для тестового режима
                    hideLoading();
                    showNotification('Счет создан! В реальном Telegram откроется интерфейс оплаты.', 'success');
                    playSound('success');
                    
                    // В тестовом режиме симулируем успешный платеж
                    setTimeout(() => {
                        showNotification('✅ Тестовый платеж: NDN зачислены на ваш счет.', 'success');
                        loadUserData();
                    }, 2000);
                }
                
                closeModal('buyNDNModal');
                
            } catch (error) {
                console.error('Ошибка создания счета:', error);
                showNotification(error.message, 'error');
                playSound('error');
                hideLoading();
            }
        }

        // Обмен NDN на Stars
        function exchangeNDN() {
            openModal('exchangeNDNModal');
        }

        // Обновление количества Stars при обмене
        function updateExchangeStars() {
            const ndnAmount = document.getElementById('exchangeAmount').value;
            document.getElementById('exchangeStars').textContent = ndnAmount || '0';
        }

        // Подтверждение обмена NDN на Stars
        async function confirmExchangeNDN() {
            const amount = document.getElementById('exchangeAmount').value;
            const username = document.getElementById('exchangeUsername').value;
            
            if (!amount || amount < 1) {
                showNotification('Введите корректное количество NDN', 'error');
                return;
            }

            if (amount > 10000) {
                showNotification('Максимальная сумма: 10,000 NDN', 'error');
                return;
            }

            if (!username || !username.startsWith('@')) {
                showNotification('Введите корректный username (начинающийся с @)', 'error');
                return;
            }

            if (userData.balance_ndn < amount) {
                showNotification('Недостаточно NDN на балансе', 'error');
                return;
            }

            try {
                showLoading();
                playSound('click');
                
                const initData = tg.initData;
                const response = await fetch('/api/payments/exchange-request', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount_ndn: parseInt(amount),
                        telegram_username: username,
                        description: `Заявка на обмен ${amount} NDN на ${amount} Telegram Stars`
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка создания заявки');
                }

                const result = await response.json();
                showNotification(result.message, 'success');
                playSound('success');
                createSparkles();
                
                // Обновляем данные пользователя
                loadUserData();
                
                closeModal('exchangeNDNModal');
                
            } catch (error) {
                console.error('Ошибка создания заявки:', error);
                showNotification(error.message, 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Вывод NDN
        function withdrawNDN() {
            openModal('withdrawModal');
        }

        // Подтверждение вывода
        async function confirmWithdraw() {
            const amount = document.getElementById('withdrawAmount').value;
            const recipientId = document.getElementById('recipientId').value;
            
            if (!amount || amount < 100) {
                showNotification('Минимальная сумма вывода: 100 NDN', 'error');
                return;
            }
            
            if (!recipientId) {
                showNotification('Введите ID получателя', 'error');
                return;
            }

            try {
                showLoading();
                playSound('click');
                
                const initData = tg.initData;
                const response = await fetch('/api/user/withdraw', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount_ndn: parseFloat(amount),
                        recipient_telegram_id: recipientId
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка вывода NDN');
                }

                const result = await response.json();
                showNotification('NDN успешно выведены!', 'success');
                playSound('success');
                createSparkles();
                
                // Обновляем данные пользователя
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                updateUserData({
                    balance_ndn: userData.balance_ndn - amount
                });
                
                closeModal('withdrawModal');
                
            } catch (error) {
                console.error('Ошибка вывода NDN:', error);
                showNotification('Ошибка вывода NDN', 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Показать рефералов
        async function showReferrals() {
            if (!userData) {
                showNotification('Сначала загрузите данные пользователя', 'error');
                return;
            }
            
            try {
                showLoading();
                playSound('click');
                
                if (!userData.telegram_id) {
                    throw new Error('Telegram ID не найден');
                }
                
                const response = await fetch(`/api/referrals/${userData.telegram_id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки рефералов');
                }

                const data = await response.json();
                if (data.success) {
                    showReferralsModal(data);
                } else {
                    showNotification('Ошибка загрузки рефералов', 'error');
                }
                
            } catch (error) {
                console.error('Ошибка загрузки рефералов:', error);
                showNotification('Ошибка загрузки рефералов', 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Показать таблицу лидеров
        async function showLeaderboard() {
            try {
                showLoading();
                playSound('click');
                
                const response = await fetch('/api/stats/leaderboard', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки лидерборда');
                }

                const data = await response.json();
                if (data.success) {
                    showLeaderboardModal(data.leaders);
                } else {
                    showNotification('Ошибка загрузки лидерборда', 'error');
                }
                
            } catch (error) {
                console.error('Ошибка загрузки лидерборда:', error);
                showNotification('Ошибка загрузки лидерборда', 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Показать правила
        async function showRules() {
            try {
                showLoading();
                playSound('click');
                
                const response = await fetch('/api/game-rules', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept-Language': currentLanguage
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки правил');
                }

                const data = await response.json();
                if (data.success) {
                    showRulesModal(data.rules);
                } else {
                    showNotification('Ошибка загрузки правил', 'error');
                }
                
            } catch (error) {
                console.error('Ошибка загрузки правил:', error);
                showNotification('Ошибка загрузки правил', 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Показать модальное окно рефералов
        function showReferralsModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            // Используем новые данные из API
            const totalReferrals = data.total_referrals || 0;
            const regularReferrals = data.regular_referrals || 0;
            const proReferrals = data.pro_referrals || 0;
            const allReferrals = data.all_referrals || [];
            const referralsByLevel = data.referrals_by_level || {};
            
            // Подсчитываем общие заработки из статистики
            let totalEarnings = 0;
            if (data.referral_stats) {
                totalEarnings = data.referral_stats.reduce((sum, stat) => sum + (stat.total_earnings || 0), 0);
            }
            
            // Обновляем описание для ясности
            const earningsDescription = totalEarnings > 0 ? 
                `${totalEarnings.toFixed(2)} NDN (только с PRO рефералов)` : 
                '0 NDN (награды за PRO рефералов)';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" data-i18n="buttons.referrals">👥 Мои рефералы</div>
                        <div class="modal-subtitle" data-i18n="referrals.description">Награды начисляются только когда рефералы покупают PRO статус</div>
                    </div>
                    
                    <div class="referral-stats">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">👥</div>
                                <div class="stat-info">
                                    <div class="stat-label" data-i18n="referrals.total">Всего рефералов</div>
                                    <div class="stat-value">${totalReferrals}</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">👤</div>
                                <div class="stat-info">
                                    <div class="stat-label" data-i18n="referrals.regular">Обычных</div>
                                    <div class="stat-value">${regularReferrals}</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">💎</div>
                                <div class="stat-info">
                                    <div class="stat-label" data-i18n="referrals.pro">PRO</div>
                                    <div class="stat-value">${proReferrals}</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">💰</div>
                                <div class="stat-info">
                                    <div class="stat-label" data-i18n="referrals.earnings">Заработано</div>
                                    <div class="stat-value">${earningsDescription}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="referral-levels">
                        <h3 data-i18n="referrals.level_stats">📊 Статистика по уровням:</h3>
                        ${data.referral_stats && data.referral_stats.length > 0 ? 
                            data.referral_stats.filter(stat => stat.total_referrals > 0).map(stat => `
                                <div class="level-item">
                                    <div class="level-info">
                                        <div class="level-number" data-i18n="referrals.level" data-level="${stat.level}">${stat.level} уровень</div>
                                        <div class="level-details">
                                            <div class="level-stats">
                                                <span class="level-count" data-i18n="referrals.referrals_count" data-count="${stat.total_referrals}">${stat.total_referrals} рефералов</span>
                                                <span class="level-reward" data-i18n="referrals.earnings" data-earnings="${stat.total_earnings.toFixed(2)}">+${stat.total_earnings.toFixed(2)} NDN</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') :
                            '<div class="no-referrals" data-i18n="referrals.no_level_stats">Статистика по уровням пока недоступна</div>'
                        }
                    </div>
                    
                    <div class="referrals-content">
                        <h3 data-i18n="referrals.referrals_list">👥 Список рефералов по уровням:</h3>
                        ${Object.keys(referralsByLevel).length > 0 ? 
                            Object.keys(referralsByLevel).sort((a, b) => parseInt(a) - parseInt(b)).filter(level => referralsByLevel[level].length > 0).map(level => `
                                <div class="level-section">
                                    <h4 data-i18n="referrals.level_with_count" data-level="${level}" data-count="${referralsByLevel[level].length}">📊 ${level} уровень (${referralsByLevel[level].length} рефералов):</h4>
                                    ${referralsByLevel[level].map(ref => `
                                        <div class="referral-item">
                                            <div class="referral-info">
                                                <div class="referral-name">
                                                    ${ref.first_name || 'Пользователь'}
                                                    ${ref.is_pro ? ' 💎' : ''}
                                                    ${ref.is_direct ? ' (прямой)' : ''}
                                                </div>
                                                <div class="referral-date">${new Date(ref.created_at).toLocaleDateString('ru-RU')}</div>
                                            </div>
                                            <div class="referral-balance">${ref.balance_ndn || 0} NDN</div>
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('') :
                            '<div class="no-referrals" data-i18n="referrals.no_referrals">У вас пока нет рефералов</div>'
                        }
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="closeModal(this.closest('.modal'))" data-i18n="buttons.back">← Назад</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Обновляем переводы для динамически созданного модального окна
            setTimeout(() => {
                updateModalTranslations();
            }, 100);
            
            playSound('success');
        }

        // Показать модальное окно лидерборда
        function showLeaderboardModal(leaders) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" data-i18n="buttons.leaderboard">🏆 Таблица лидеров</div>
                        <div class="modal-subtitle" data-i18n="leaderboard.description">Топ игроков по балансу NDN</div>
                    </div>
                    <div class="leaderboard-content">
                        ${leaders.map((leader, index) => `
                            <div class="leader-item ${index < 3 ? 'top-' + (index + 1) : ''}">
                                <div class="leader-rank">${leader.rank}</div>
                                <div class="leader-info">
                                    <div class="leader-name">${leader.first_name || 'Пользователь'}</div>
                                </div>
                                <div class="leader-balance">
                                    <div class="balance-ndn">${leader.balance_ndn} NDN</div>
                                    ${leader.is_pro ? '<div class="pro-badge" data-i18n="pro.status">💎 PRO</div>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="closeModal(this.closest('.modal'))" data-i18n="buttons.back">← Назад</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Обновляем переводы для динамически созданного модального окна
            setTimeout(() => {
                updateModalTranslations();
            }, 100);
            playSound('success');
        }

        // Показать модальное окно правил
        function showRulesModal(rules) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content rules-modal">
                    <div class="modal-header">
                        <div class="modal-title" data-i18n="buttons.rules">${rules.title}</div>
                    </div>
                    <div class="modal-body">
                        <div class="rules-content">
                            ${rules.sections.map(section => `
                                <div class="rule-section">
                                    <div class="rule-title">${section.title}</div>
                                    <div class="rule-content">${section.content}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="closeModal(this.closest('.modal'))" data-i18n="buttons.back">← Назад</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Обновляем переводы для динамически созданного модального окна
            setTimeout(() => {
                updateModalTranslations();
            }, 100);
            
            playSound('success');
        }

        // ==================== ДОСТИЖЕНИЯ ====================
        
        async function showAchievements() {
            try {
                if (!userData || !userData.telegram_id) {
                    showNotification('Сначала загрузите данные пользователя', 'error');
                    return;
                }
                
                showModal('achievementsModal');
                showLoading();
                
                const response = await fetch(`/api/achievements/${userData.telegram_id}`);
                const data = await response.json();
                
                if (data.success) {
                    displayAchievements(data.achievements);
                } else {
                    throw new Error('Ошибка загрузки достижений');
                }
            } catch (error) {
                console.error('Error loading achievements:', error);
                showNotification('Ошибка загрузки достижений', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function displayAchievements(achievements) {
            const container = document.getElementById('achievementsList');
            
            if (!achievements || achievements.length === 0) {
                container.innerHTML = '<div class="no-data">Достижения не найдены</div>';
                return;
            }
            
            const groupedAchievements = achievements.reduce((groups, achievement) => {
                const category = achievement.category || 'general';
                if (!groups[category]) {
                    groups[category] = [];
                }
                groups[category].push(achievement);
                return groups;
            }, {});
            
            let html = '';
            for (const [category, categoryAchievements] of Object.entries(groupedAchievements)) {
                const categoryNames = {
                    'trading': '💰 Торговля',
                    'referral': '👥 Рефералы',
                    'special': '⭐ Особые',
                    'social': '💬 Социальные',
                    'general': '🏆 Общие'
                };
                
                html += `
                    <div class="achievement-category">
                        <h3>${categoryNames[category] || category}</h3>
                        <div class="achievement-list">
                            ${categoryAchievements.map(achievement => `
                                <div class="achievement-item ${achievement.is_completed ? 'completed' : ''}">
                                    <div class="achievement-icon">${achievement.icon}</div>
                                    <div class="achievement-info">
                                        <div class="achievement-name">${achievement.name}</div>
                                        <div class="achievement-description">${achievement.description}</div>
                                        <div class="achievement-progress">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${Math.min(100, (achievement.progress / achievement.requirement_value) * 100)}%"></div>
                                            </div>
                                            <span class="progress-text">${achievement.progress}/${achievement.requirement_value}</span>
                                        </div>
                                        ${achievement.is_completed ? `
                                            <div class="achievement-reward">
                                                <span class="reward-ndn">💰 ${achievement.reward_ndn} NDN</span>
                                                <span class="reward-stars">⭐ ${achievement.reward_stars} Stars</span>
                                                ${!achievement.claimed_reward ? `
                                                    <button class="button button-success" onclick="claimAchievement(${achievement.achievement_id})">
                                                        Получить награду
                                                    </button>
                                                ` : '<span class="claimed">✅ Получено</span>'}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        async function claimAchievement(achievementId) {
            try {
                const response = await fetch(`/api/achievements/${userData.telegram_id}/claim?achievement_id=${achievementId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    playSound('success');
                    createSparkles();
                    // Обновляем данные пользователя
                    await loadUserData();
                    // Перезагружаем достижения
                    await showAchievements();
                } else {
                    showNotification(data.message || 'Ошибка получения награды', 'error');
                }
            } catch (error) {
                console.error('Error claiming achievement:', error);
                showNotification('Ошибка получения награды', 'error');
            }
        }
        
        // ==================== МАГАЗИНЫ ====================
        
        async function showShops() {
            try {
                if (!userData || !userData.telegram_id) {
                    showNotification('Сначала загрузите данные пользователя', 'error');
                    return;
                }
                
                showModal('shopsModal');
                showLoading();
                
                const response = await fetch(`/api/shops/${userData.telegram_id}`);
                const data = await response.json();
                
                if (data.success) {
                    displayShops(data.shops);
                } else {
                    throw new Error('Ошибка загрузки магазинов');
                }
            } catch (error) {
                console.error('Error loading shops:', error);
                showNotification('Ошибка загрузки магазинов', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function displayShops(shops) {
            const container = document.getElementById('shopsList');
            
            if (!shops || shops.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">🏪</div>
                        <div class="no-data-title">У вас нет магазинов</div>
                        <div class="no-data-subtitle">Откройте свой первый магазин за 10,000 NDN!</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            shops.forEach(shop => {
                html += `
                    <div class="shop-item">
                        <div class="shop-header">
                            <div class="shop-name">${shop.name}</div>
                            <div class="shop-status ${shop.is_active ? 'active' : 'inactive'}">
                                ${shop.is_active ? '✅ Активен' : '❌ Неактивен'}
                            </div>
                        </div>
                        <div class="shop-description">${shop.description || 'Без описания'}</div>
                        <div class="shop-stats">
                            <div class="shop-stat">
                                <span class="stat-label">Товаров:</span>
                                <span class="stat-value">${shop.items_count}</span>
                            </div>
                            <div class="shop-stat">
                                <span class="stat-label">Продаж:</span>
                                <span class="stat-value">${shop.total_sales}</span>
                            </div>
                            <div class="shop-stat">
                                <span class="stat-label">Категория:</span>
                                <span class="stat-value">${shop.category}</span>
                            </div>
                        </div>
                        <div class="shop-actions">
                            <button class="button button-primary" onclick="showAddItemForm(${shop.shop_id})">
                                📦 Добавить товар
                            </button>
                            <button class="button button-secondary" onclick="viewShopItems(${shop.shop_id})">
                                👀 Просмотреть товары
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showOpenShopForm() {
            closeModal('shopsModal');
            showModal('openShopModal');
        }
        
        async function confirmOpenShop() {
            const name = document.getElementById('shopName').value.trim();
            const description = document.getElementById('shopDescription').value.trim();
            const category = document.getElementById('shopCategory').value;
            
            if (!name) {
                showNotification('Введите название магазина', 'error');
                return;
            }
            
            if (userData.balance_ndn < 10000) {
                showNotification('Недостаточно NDN для открытия магазина (требуется 10,000 NDN)', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/shops/open', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${tg.initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        category: category
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    playSound('success');
                    createSparkles();
                    closeModal('openShopModal');
                    // Обновляем данные пользователя
                    await loadUserData();
                    // Показываем магазины
                    await showShops();
                } else {
                    showNotification(data.message || 'Ошибка открытия магазина', 'error');
                }
            } catch (error) {
                console.error('Error opening shop:', error);
                showNotification('Ошибка открытия магазина', 'error');
            }
        }
        
        function showAddItemForm(shopId) {
            window.currentShopId = shopId;
            closeModal('shopsModal');
            showModal('addItemModal');
        }
        
        async function confirmAddItem() {
            const name = document.getElementById('itemName').value.trim();
            const description = document.getElementById('itemDescription').value.trim();
            const priceNDN = parseFloat(document.getElementById('itemPriceNDN').value) || 0;
            const priceStars = parseFloat(document.getElementById('itemPriceStars').value) || 0;
            const itemType = document.getElementById('itemType').value;
            const category = document.getElementById('itemCategory').value;
            const imageUrl = document.getElementById('itemImageUrl').value.trim();
            const stock = parseInt(document.getElementById('itemStock').value) || -1;
            
            if (!name) {
                showNotification('Введите название товара', 'error');
                return;
            }
            
            if (priceNDN <= 0 && priceStars <= 0) {
                showNotification('Укажите цену в NDN или Stars', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/shops/${window.currentShopId}/items`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${tg.initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        price_ndn: priceNDN,
                        price_stars: priceStars,
                        item_type: itemType,
                        category: category,
                        image_url: imageUrl || null,
                        stock_quantity: stock
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    playSound('success');
                    createSparkles();
                    closeModal('addItemModal');
                    // Очищаем форму
                    document.getElementById('itemName').value = '';
                    document.getElementById('itemDescription').value = '';
                    document.getElementById('itemPriceNDN').value = '';
                    document.getElementById('itemPriceStars').value = '';
                    document.getElementById('itemImageUrl').value = '';
                    document.getElementById('itemStock').value = '-1';
                } else {
                    showNotification(data.message || 'Ошибка добавления товара', 'error');
                }
            } catch (error) {
                console.error('Error adding item:', error);
                showNotification('Ошибка добавления товара', 'error');
            }
        }
        
        function viewShopItems(shopId) {
            // TODO: Реализовать просмотр товаров магазина
            showNotification('Функция просмотра товаров в разработке', 'info');
        }
        
        // Тестовые функции
        function resetTestData() {
            if (confirm('Сбросить все тестовые данные?')) {
                localStorage.removeItem('nodeon_test_user');
                showNotification('Тестовые данные сброшены', 'success');
                playSound('success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }

        function addTestMoney() {
            if (userData) {
                updateUserData({
                    balance_ndn: userData.balance_ndn + 1000 // Добавляем NDN для тестирования
                });
                showNotification('Добавлено 1000 NDN для тестирования!', 'success');
                playSound('success');
                createSparkles();
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM загружен, инициализируем приложение...');
            
            // Проверяем наличие ключевых элементов
            const keyElements = {
                'ndnBalance': document.getElementById('ndnBalance'),
                'userId': document.getElementById('userId'),
                'subtitle': document.querySelector('.subtitle')
            };
            
            console.log('🔍 Проверка элементов DOM:', keyElements);
            
            // Инициализируем игровые данные
            initializeGameData();
            
            createParticles();
            
            // Обработчики событий
            const ndnAmountInput = document.getElementById('ndnAmount');
            if (ndnAmountInput) {
                ndnAmountInput.addEventListener('input', updateStarsCost);
            }
            
            // Загружаем данные пользователя после инициализации DOM
            setTimeout(() => {
                console.log('⏰ Запускаем загрузку данных пользователя...');
                loadUserData();
            }, 500); // Увеличил задержку
            
            // Инициализируем обработчики переводов
            initializeTransferHandlers();
            
            // Закрытие модальных окон по клику вне их
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
        });

        // Функции для работы с приглашениями
        function inviteFriends() {
            console.log('inviteFriends() called');
            console.log('userData:', userData);
            console.log('userData.is_pro:', userData ? userData.is_pro : 'userData is null');
            
            if (!userData) {
                console.log('No userData, showing error notification');
                showNotification('Сначала загрузите данные пользователя!', 'error');
                return;
            }
            
            if (!userData.is_pro) {
                console.log('User is not PRO, showing error notification');
                showNotification('Только PRO пользователи могут приглашать друзей!', 'error');
                return;
            }
            
            console.log('User is PRO, proceeding with invite modal');
            
            // Проверяем, существует ли модальное окно
            const modal = document.getElementById('inviteFriendsModal');
            if (!modal) {
                console.error('inviteFriendsModal not found');
                showNotification('Ошибка: модальное окно не найдено', 'error');
                return;
            }
            
            // Загружаем реферальную ссылку
            loadReferralLink();
            
            // Показываем модальное окно
            showModal('inviteFriendsModal');
            console.log('Invite modal should be visible now');
        }
        
        function loadReferralLink() {
            const linkInput = document.getElementById('referralLinkInput');
            if (!linkInput) {
                console.error('Referral link input not found');
                return;
            }
            
            let referralLink = '';
            
            if (userData && userData.referral_link && userData.referral_link.trim() !== '') {
                // Используем ссылку из базы данных
                referralLink = userData.referral_link;
                console.log('Using referral link from database:', referralLink);
            } else if (userData && userData.id) {
                // Генерируем ссылку на основе игрового ID
                const botUsername = 'pro_stars_bot'; // Имя бота для реферальных ссылок
                referralLink = `https://t.me/${botUsername}?startapp=ref_${userData.id}`;
                console.log('Generated referral link with game ID:', referralLink);
            } else if (userData && userData.telegram_id) {
                // Fallback на Telegram ID
                const botUsername = 'pro_stars_bot';
                referralLink = `https://t.me/${botUsername}?startapp=ref_${userData.telegram_id}`;
                console.log('Generated referral link with Telegram ID:', referralLink);
            } else {
                // Fallback ссылка
                referralLink = 'https://t.me/pro_stars_bot';
                console.log('Using fallback referral link:', referralLink);
            }
            
            linkInput.value = referralLink;
            linkInput.style.color = '#000000';
            linkInput.style.backgroundColor = '#ffffff';
            console.log('Referral link set to:', referralLink);
            
            // Проверяем, что ссылка действительно установлена
            if (linkInput.value !== referralLink) {
                console.error('Failed to set referral link value');
                showNotification('Ошибка загрузки реферальной ссылки', 'error');
            }
        }
        
        async function copyReferralLink() {
            const linkInput = document.getElementById('referralLinkInput');
            if (!linkInput) {
                showNotification('Поле ссылки не найдено', 'error');
                return;
            }
            
            const linkText = linkInput.value.trim();
            if (!linkText) {
                showNotification('Ссылка не загружена. Попробуйте еще раз.', 'error');
                return;
            }
            
            console.log('Копируем ссылку:', linkText);
            
            try {
                // Современный API для копирования
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(linkText);
                    showNotification('Ссылка скопирована в буфер обмена!', 'success');
                    console.log('Ссылка успешно скопирована через Clipboard API');
                } else {
                    // Fallback для старых браузеров
                    linkInput.select();
                    linkInput.setSelectionRange(0, 99999);
                    
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showNotification('Ссылка скопирована в буфер обмена!', 'success');
                        console.log('Ссылка успешно скопирована через execCommand');
                    } else {
                        throw new Error('execCommand failed');
                    }
                }
            } catch (err) {
                console.error('Ошибка копирования:', err);
                showNotification('Не удалось скопировать ссылку. Попробуйте выделить и скопировать вручную.', 'error');
            }
        }
        
        function showLinkModal() {
            const linkInput = document.getElementById('referralLinkInput');
            if (!linkInput || !linkInput.value.trim()) {
                showNotification('Ссылка не загружена', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">🔗 Ваша реферальная ссылка</div>
                        <div class="modal-subtitle">Выделите и скопируйте ссылку вручную</div>
                    </div>
                    <div class="link-display">
                        <div class="link-text" id="linkTextDisplay">${linkInput.value}</div>
                        <div class="link-instructions">
                            <p>📋 Инструкции:</p>
                            <ol>
                                <li>Выделите ссылку выше</li>
                                <li>Нажмите Ctrl+C (или Cmd+C на Mac)</li>
                                <li>Вставьте в нужное место</li>
                            </ol>
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="copyReferralLink()">📋 Копировать автоматически</button>
                        <button class="button button-secondary" onclick="closeModal(this.closest('.modal'))">Закрыть</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Выделяем текст для удобства копирования
            setTimeout(() => {
                const linkText = document.getElementById('linkTextDisplay');
                if (linkText) {
                    const range = document.createRange();
                    range.selectNodeContents(linkText);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }, 100);
        }
        
        function shareViaTelegram() {
            const linkInput = document.getElementById('referralLinkInput');
            if (linkInput && linkInput.value) {
                const message = `🎮 Присоединяйся к NodeOn Crypto!\n\n💰 Зарабатывай NDN и Telegram Stars\n🏆 Открывай достижения и магазины\n👥 Приглашай друзей и получай бонусы\n\n🔗 ${linkInput.value}`;
                
                // Используем Telegram WebApp API для выбора контактов
                if (window.Telegram && window.Telegram.WebApp) {
                    // Открываем диалог выбора контактов
                    window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(linkInput.value)}&text=${encodeURIComponent(message)}`);
                } else {
                    // Fallback для обычных браузеров
                    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(linkInput.value)}&text=${encodeURIComponent(message)}`;
                    window.open(shareUrl, '_blank');
                }
            }
        }
        
        // Функция для выбора контактов из Telegram
        function selectTelegramContacts(callback) {
            // Пока используем простое модальное окно для ввода контакта
            // В будущем можно добавить интеграцию с Telegram API
            showContactInputModal(callback);
        }
        
        // Fallback модальное окно для ввода контакта
        function showContactInputModal(callback) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'contactInputModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">📱 Выберите контакт</div>
                        <div class="modal-subtitle">Введите @username или номер телефона</div>
                    </div>
                    <div class="modal-body">
                        <input type="text" class="form-input" id="contactInput" placeholder="@username или +7XXXXXXXXXX">
                    </div>
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="confirmContactSelection()">Выбрать</button>
                        <button class="button button-secondary" onclick="closeModal('contactInputModal')">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            showModal('contactInputModal');
            
            // Глобальная функция для подтверждения выбора
            window.confirmContactSelection = function() {
                const contactInput = document.getElementById('contactInput');
                const contact = contactInput.value.trim();
                if (contact) {
                    callback({ username: contact, first_name: contact });
                    closeModal('contactInputModal');
                } else {
                    showNotification('Введите контакт', 'error');
                }
            };
        }
        
        // Функция для приглашения через выбор контакта
        function inviteToTelegramContact() {
            const linkInput = document.getElementById('referralLinkInput');
            if (!linkInput || !linkInput.value) {
                showNotification('Сначала загрузите реферальную ссылку', 'error');
                return;
            }
            
            // Копируем ссылку в буфер обмена
            copyReferralLink();
            
            // Открываем Telegram для выбора контакта
            const message = `🎮 Привет! Присоединяйся к NodeOn Crypto!\n\n💰 Зарабатывай NDN и Telegram Stars\n🏆 Открывай достижения и магазины\n👥 Приглашай друзей и получай бонусы\n\n🔗 ${linkInput.value}`;
            
            if (window.Telegram && window.Telegram.WebApp) {
                // Открываем Telegram с сообщением для выбора контакта
                window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(linkInput.value)}&text=${encodeURIComponent(message)}`);
            } else {
                // Fallback для браузера
                const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(linkInput.value)}&text=${encodeURIComponent(message)}`;
                window.open(shareUrl, '_blank');
            }
            
            showNotification('Ссылка скопирована! Выберите контакт в Telegram', 'success');
        }
        
        // Функция для проверки регистрации пользователя
        function checkUserRegistration(contact, callback) {
            // Здесь можно добавить API вызов для проверки регистрации
            // Пока что возвращаем false (не зарегистрирован)
            setTimeout(() => {
                callback(false, null);
            }, 100);
        }
        
        // Функции для работы с переводами NDN
        let selectedRecipient = null;
        
        function transferNDN() {
            // Обновляем баланс в модальном окне
            document.getElementById('transferBalance').textContent = (userData.balance_ndn || 0).toFixed(2);
            
            // Сбрасываем форму
            selectedRecipient = null;
            document.getElementById('recipientInfo').style.display = 'none';
            document.getElementById('recipientInputSection').style.display = 'block';
            document.getElementById('recipientIdInput').value = '';
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferSummary').style.display = 'none';
            document.getElementById('confirmTransferBtn').disabled = true;
            
            showModal('transferNDNModal');
        }
        
        // Функция для поиска игрока по ID
        async function findRecipient() {
            const recipientId = document.getElementById('recipientIdInput').value.trim();
            
            if (!recipientId) {
                showNotification('Введите игровой ID', 'error');
                return;
            }
            
            if (recipientId == userData.id) {
                showNotification('Нельзя переводить самому себе', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // Ищем игрока по ID
                const response = await fetch(`/api/users/find-by-id/${recipientId}`);
                const data = await response.json();
                
                if (data.success && data.user) {
                    // Игрок найден
                    selectedRecipient = data.user;
                    
                    // Обновляем UI
                    document.getElementById('recipientName').textContent = data.user.first_name || 'Неизвестно';
                    document.getElementById('recipientId').textContent = `ID: ${data.user.id}`;
                    
                    document.getElementById('recipientInfo').style.display = 'block';
                    document.getElementById('recipientInputSection').style.display = 'none';
                    
                    // Проверяем, можно ли активировать кнопку перевода
                    updateTransferButton();
                    
                    showNotification(`Найден игрок: ${data.user.first_name}`, 'success');
                } else {
                    showNotification('Игрок с таким ID не найден', 'error');
                }
            } catch (error) {
                console.error('Error finding recipient:', error);
                showNotification('Ошибка поиска игрока', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function changeRecipient() {
            selectedRecipient = null;
            document.getElementById('recipientInfo').style.display = 'none';
            document.getElementById('recipientInputSection').style.display = 'block';
            document.getElementById('recipientIdInput').value = '';
            document.getElementById('transferSummary').style.display = 'none';
            updateTransferButton();
        }
        
        function updateTransferButton() {
            const amount = parseFloat(document.getElementById('transferAmount').value) || 0;
            const hasRecipient = selectedRecipient !== null;
            const hasAmount = amount > 0;
            const hasEnoughBalance = amount <= (userData.balance_ndn || 0);
            
            const canTransfer = hasRecipient && hasAmount && hasEnoughBalance;
            document.getElementById('confirmTransferBtn').disabled = !canTransfer;
            
            // Обновляем сводку перевода
            if (hasRecipient && hasAmount) {
                updateTransferSummary();
            } else {
                document.getElementById('transferSummary').style.display = 'none';
            }
        }
        
        function updateTransferSummary() {
            const amount = parseFloat(document.getElementById('transferAmount').value) || 0;
            const fee = 0; // Комиссия 0% для простоты
            const total = amount + fee;
            
            document.getElementById('summaryRecipient').textContent = `${selectedRecipient.first_name} (ID: ${selectedRecipient.id})`;
            document.getElementById('summaryAmount').textContent = amount.toFixed(2);
            document.getElementById('summaryFee').textContent = fee.toFixed(2);
            document.getElementById('summaryTotal').textContent = total.toFixed(2);
            
            document.getElementById('transferSummary').style.display = 'block';
        }
        
        // Функция для копирования игрового ID
        function copyUserId() {
            if (userData && userData.id) {
                navigator.clipboard.writeText(userData.id.toString()).then(() => {
                    showNotification('ID скопирован в буфер обмена!', 'success');
                }).catch(() => {
                    // Fallback для старых браузеров
                    const textArea = document.createElement('textarea');
                    textArea.value = userData.id.toString();
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('ID скопирован в буфер обмена!', 'success');
                });
            } else {
                showNotification('ID не загружен', 'error');
            }
        }
        
        async function confirmTransfer() {
            if (!selectedRecipient) {
                showNotification('Выберите получателя', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('transferAmount').value);
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму', 'error');
                return;
            }
            
            if (amount > (userData.balance_ndn || 0)) {
                showNotification('Недостаточно средств', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const response = await fetch('/api/transfers/ndn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tg.initData}`
                    },
                    body: JSON.stringify({
                        from_user_id: userData.id,
                        to_user_id: selectedRecipient.id,
                        amount: amount,
                        description: `Перевод игроку ${selectedRecipient.first_name}`
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Перевод ${amount} NDN выполнен!`, 'success');
                    closeModal('transferNDNModal');
                    
                    // Обновляем баланс пользователя
                    if (userData) {
                        userData.balance_ndn = result.from_balance;
                        updateUI();
                    }
                    
                    // Сбрасываем форму
                    document.getElementById('recipientIdInput').value = '';
                    document.getElementById('transferAmount').value = '';
                    selectedRecipient = null;
                    document.getElementById('recipientInfo').style.display = 'none';
                    document.getElementById('recipientInputSection').style.display = 'block';
                    document.getElementById('transferSummary').style.display = 'none';
                    document.getElementById('confirmTransferBtn').disabled = true;
                } else {
                    showNotification(result.message || 'Ошибка перевода', 'error');
                }
            } catch (error) {
                console.error('Transfer error:', error);
                showNotification('Ошибка соединения', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Обработчик изменения суммы перевода
        function initializeTransferHandlers() {
            const transferAmountInput = document.getElementById('transferAmount');
            if (transferAmountInput) {
                transferAmountInput.addEventListener('input', updateTransferButton);
            }
        }
        
        function shareViaOther() {
            const linkInput = document.getElementById('referralLinkInput');
            if (linkInput && linkInput.value) {
                const message = `🎮 Присоединяйся к NodeOn Crypto!\n\n💰 Зарабатывай NDN и Telegram Stars\n🏆 Открывай достижения и магазины\n👥 Приглашай друзей и получай бонусы\n\n🔗 ${linkInput.value}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'NodeOn Crypto - Зарабатывай NDN!',
                        text: message,
                        url: linkInput.value
                    }).catch(err => {
                        console.log('Ошибка при шаринге:', err);
                        copyReferralLink();
                    });
                } else {
                    copyReferralLink();
                }
            }
        }
    </script>
</body>
</html>
