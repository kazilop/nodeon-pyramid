<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NodeOn Crypto - Крипто Игра</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Анимированный фон */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #1e3c72, #2a5298, #667eea, #764ba2);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Плавающие частицы */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }

        /* Контейнер */
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Система вкладок */
        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs-header {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .tab-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Игровые элементы */
        .game-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            color: #000000;
        }

        .game-card h3 {
            color: #000000;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .game-card p {
            color: #333333;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .game-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .daily-rewards {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .daily-rewards::-webkit-scrollbar {
            height: 6px;
        }

        .daily-rewards::-webkit-scrollbar-track {
            background: transparent;
        }

        .daily-rewards::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .daily-rewards::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Индикатор прокрутки */
        .daily-rewards-container::after {
            content: "← Прокрутите для просмотра всех дней →";
            position: absolute;
            right: 10px;
            bottom: -20px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            pointer-events: none;
            z-index: 1;
        }

        .daily-rewards-container {
            position: relative;
            margin-bottom: 25px;
        }

        .reward-day {
            width: 60px;
            height: 60px;
            min-width: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            color: #ffffff;
            flex-shrink: 0;
        }

        .reward-day div {
            color: #ffffff;
        }

        .reward-day.claimed {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-color: #4CAF50;
        }

        .reward-day.available {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-color: #FFD700;
            animation: pulse 2s infinite;
        }

        .reward-day.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .reward-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .reward-amount {
            font-size: 12px;
            font-weight: bold;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            color: #000000;
        }

        .achievement-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #000000;
            font-size: 16px;
        }

        .achievement-description {
            font-size: 14px;
            opacity: 0.8;
            color: #333333;
        }

        .achievement-item.completed {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(69, 160, 73, 0.2));
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .achievement-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .achievement-description {
            font-size: 14px;
            opacity: 0.8;
        }

        .achievement-progress {
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.1);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .level-progress {
            margin-top: 15px;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #ffffff);
        }

        .level-info span {
            color: var(--tg-theme-text-color, #ffffff);
            font-weight: 500;
        }

        .level-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .level-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
            color: #000000;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
            color: #333333;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #000000;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .stat-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        /* =============== НОВЫЕ СТИЛИ ДЛЯ УЛУЧШЕНИЙ =============== */

        /* Квесты */
        .quests-list {
            margin-top: 15px;
        }

        .quest-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            color: #000000;
            border: 2px solid transparent;
        }

        .quest-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .quest-item.completed {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(69, 160, 73, 0.3));
            border: 2px solid rgba(76, 175, 80, 0.5);
        }

        .quest-info {
            flex: 1;
        }

        .quest-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #000000;
        }

        .quest-description {
            font-size: 14px;
            opacity: 0.8;
            color: #333333;
            margin-bottom: 8px;
        }

        .quest-progress {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .quest-progress-bar {
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .quest-reward {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            margin-left: 15px;
        }

        .quest-reward-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .quest-reward-value {
            font-size: 16px;
            font-weight: bold;
            color: #000;
        }

        .quest-claim-button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .quest-claim-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .quest-claim-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Колесо фортуны */
        .fortune-wheel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin-top: 15px;
        }

        .fortune-wheel {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 20px 0;
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .wheel-prizes {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 0 15px rgba(255, 255, 255, 0.2),
                        0 0 0 20px rgba(255, 255, 255, 0.1),
                        0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            transform-origin: 0% 0%;
            transform: rotate(var(--rotation)) skewY(-30deg);
            background: var(--bg-color);
            clip-path: polygon(0 0, 100% 0, 100% 100%);
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            padding: 20px 10px;
        }

        .prize-label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            transform: rotate(30deg) translateX(-40px) translateY(20px);
            white-space: nowrap;
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .wheel-arrow {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            color: #ff4757;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            z-index: 20;
        }

        .spin-button {
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .spin-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
        }

        .spin-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .spin-info {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Фильтры достижений */
        .achievements-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }

        .filter-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .achievements-grid {
            display: grid;
            gap: 12px;
            margin-top: 15px;
        }

        /* Ранг игрока */
        .player-rank-display {
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.2));
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rank-icon {
            font-size: 48px;
            margin-right: 20px;
        }

        .rank-details {
            flex: 1;
        }

        .rank-title {
            font-size: 24px;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
        }

        .rank-bonus {
            font-size: 14px;
            color: #666;
        }

        .next-rank-info {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Магазин бустов */
        .miner-boosts {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .miner-boosts h3 {
            color: white;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .miner-boosts p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .boosts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .boost-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .boost-item:hover:not(.boost-active) {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .boost-item.boost-active {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(69, 160, 73, 0.2));
            border-color: rgba(76, 175, 80, 0.6);
        }

        .boost-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .boost-item:hover::before {
            opacity: 1;
        }

        .boost-icon {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
        }

        .boost-name {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
        }

        .boost-description {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
            min-height: 36px;
        }

        .boost-cost {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .boost-duration {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
        }

        .boost-buy-button {
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .boost-buy-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .boost-buy-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .active-boosts {
            margin-top: 25px;
            padding: 15px;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 12px;
        }

        .active-boosts h4 {
            color: white;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .active-boost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .active-boost-name {
            font-weight: 600;
            color: white;
        }

        .active-boost-timer {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Система уведомлений */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .notification.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .notification.info {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification-text {
            flex: 1;
            font-weight: 500;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Напоминания */
        .reminder-banner {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            border-radius: 8px;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
            cursor: pointer;
        }

        .reminder-banner:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        /* NDN Miner стили */
        .miner-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .miner-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Анимации для смешных уведомлений */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .funny-notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .funny-icon {
            font-size: 24px;
            animation: bounce 1s infinite;
        }
        
        .funny-text {
            flex: 1;
        }
        
        .funny-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .funny-description {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .funny-message {
            font-size: 11px;
            opacity: 0.8;
            font-style: italic;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }
        
        /* Анимация для ферм при покупке */
        .farm-item.purchased {
            animation: purchasePulse 0.6s ease-out;
        }
        
        @keyframes purchasePulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* Стили для новых разделов */
        .miner-boosts, .miner-special, .miner-quests {
            margin-bottom: 20px;
        }
        
        .boosts-grid, .special-miners-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .boost-item, .special-miner-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .boost-item:hover, .special-miner-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }
        
        .boost-icon, .special-miner-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .boost-name, .special-miner-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .boost-description, .special-miner-description {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
        }
        
        .boost-cost, .special-miner-cost {
            font-size: 14px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .boost-button, .special-miner-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .boost-button:hover, .special-miner-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .boost-button:disabled, .special-miner-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .ad-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .ad-button:hover {
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        
        .quests-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .quest-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }
        
        .quest-item.completed {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1));
            border-color: rgba(76, 175, 80, 0.5);
        }
        
        .quest-icon {
            font-size: 24px;
        }
        
        .quest-info {
            flex: 1;
        }
        
        .quest-name {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
        }
        
        .quest-description {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }
        
        .quest-reward {
            font-size: 11px;
            color: #ffd700;
        }
        
        .quest-progress {
            font-size: 12px;
            color: #4caf50;
            font-weight: bold;
        }
        
        .quest-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }
        
        .quest-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .quest-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .miner-stat-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            color: #000000;
        }

        .miner-stat-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .miner-stat-info {
            flex: 1;
        }

        .miner-stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
            color: #333333;
        }

        .miner-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #000000;
        }

        /* Кнопка пополнения энергии */
        .energy-refill-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            color: #000000;
        }

        .miner-sync-controls {
            margin: 15px 0;
            text-align: center;
        }
        .sync-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .sync-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .sync-button:active {
            transform: translateY(0);
        }

        .sync-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .sync-button:disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .energy-refill-button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .energy-refill-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .energy-refill-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .energy-refill-info {
            font-size: 14px;
            color: #333333;
            margin-top: 10px;
        }

        .energy-refill-info span {
            font-weight: bold;
            color: #ff6b6b;
        }

        .miner-farms, .miner-upgrades, .miner-shop {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            color: #000000;
        }

        .miner-farms h3, .miner-upgrades h3, .miner-shop h3 {
            color: #000000;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .farms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .farm-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            color: #000000;
        }

        .farm-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .farm-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .farm-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #000000;
        }

        .farm-description {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
            color: #333333;
        }

        .farm-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: #333333;
        }

        .farm-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .farm-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .farm-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .upgrades-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .upgrade-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #000000;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .upgrade-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .upgrade-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .upgrade-tab.active:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        .upgrade-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #000000;
        }

        .upgrade-info {
            flex: 1;
        }

        .upgrade-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #000000;
        }

        .upgrade-description {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
            color: #333333;
        }

        .upgrade-cost {
            font-size: 12px;
            font-weight: bold;
            color: #667eea;
        }

        .upgrade-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .upgrade-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .upgrade-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            color: #000000;
        }

        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .shop-item.premium {
            border: 2px solid #ffd700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .shop-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .shop-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #000000;
        }

        .shop-description {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 10px;
            color: #333333;
        }

        .shop-cost {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
        }

        .shop-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .shop-button.premium {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #000000;
        }

        .shop-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .shop-button.premium:hover {
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
        }

        /* Рейтинг майнеров */
        .miner-leaderboard {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            color: #000000;
        }

        .miner-leaderboard h3 {
            color: #000000;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .leaderboard-table {
            overflow-x: auto;
        }

        .leaderboard-table table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #000000;
        }

        .leaderboard-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            font-size: 12px;
        }

        .leaderboard-table td {
            font-size: 14px;
        }

        .leaderboard-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .leaderboard-table .rank {
            font-weight: bold;
            color: #667eea;
        }

        .leaderboard-table .player-name {
            font-weight: 500;
        }

        .leaderboard-table .you {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            font-weight: bold;
        }

        /* Улучшения разметки для мобильных */
        @media (max-width: 768px) {
            .miner-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .farms-grid {
                grid-template-columns: 1fr;
            }

            .shop-items {
                grid-template-columns: 1fr;
            }

            .upgrades-tabs {
                flex-direction: column;
            }

            .upgrade-item {
                flex-direction: column;
                text-align: center;
            }

            .upgrade-button {
                margin-top: 10px;
            }
        }

        /* Заголовок */
        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: slideInDown 1s ease-out;
        }

        @keyframes slideInDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.3); }
            to { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.6); }
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .language-selector {
            margin-top: 15px;
        }

        .language-selector select {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .language-selector select:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .language-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        /* Карточки */
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideInUp 1s ease-out;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Баланс */
        .balance-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .balance-item {
            display: inline-block;
            margin: 0 15px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .balance-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .balance-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Кнопки */
        .button {
            width: 100%;
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .button:hover::before {
            left: 100%;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .button-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.7);
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }

        .button-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .button-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(108, 117, 125, 0.7);
            background: linear-gradient(135deg, #5a6268, #3d4043);
        }

        .button-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .button-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.7);
            background: linear-gradient(135deg, #218838, #1ea085);
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 350px;
            width: 90%;
            animation: slideInScale 0.3s ease;
        }

        @keyframes slideInScale {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        /* Улучшенные стили для мобильных устройств */
        @media (max-width: 768px) {
            .modal-content {
                max-width: 95vw;
                max-height: 90vh;
                padding: 20px;
                margin: 10px;
                overflow-y: auto;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 10px;
                position: sticky;
                bottom: 0;
                background: var(--tg-theme-bg-color, #ffffff);
                padding: 15px 0 0 0;
                margin-top: 20px;
                border-top: 1px solid #eee;
            }
            
            .modal-buttons .button {
                width: 100%;
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            padding: 20px 0 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-buttons .button {
            flex: 1;
            margin-bottom: 0;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .modal-buttons .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        .modal-buttons .button:active {
            transform: translateY(0);
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error {
            background: #f44336;
        }

        .notification.warning {
            background: #ff9800;
        }

        /* Загрузка */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Адаптивность */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .balance-item {
                margin: 5px;
                padding: 12px 20px;
            }
            
            .card {
                padding: 20px;
            }
        }

        /* Эффекты частиц */
        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            animation: sparkle 1.5s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        /* Стили для рефералов */
        .referrals-content {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .referral-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .referral-info {
            flex: 1;
        }

        .referral-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .referral-username {
            color: #666;
            font-size: 0.9rem;
        }

        .referral-balance {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }

        .no-referrals {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
        }

        .referral-stats {
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
        }

        .stat-hint {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
        }

        .referral-levels {
            margin-bottom: 20px;
        }

        .referral-levels h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        .level-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .level-number {
            font-weight: bold;
            color: #4CAF50;
            font-size: 14px;
        }

        .level-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .level-count {
            color: rgba(255, 255, 255, 0.7);
        }

        .level-reward {
            color: #4CAF50;
            font-weight: bold;
        }

        .referral-date {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 2px;
        }

        .level-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 107, 53, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.1);
        }

        .level-section h4 {
            margin: 0 0 15px 0;
            color: #ff6b35;
            font-size: 16px;
            font-weight: 600;
        }

        /* Стили для лидерборда */
        .leaderboard-content {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .leader-item {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 6px;
            animation: slideInRight 0.5s ease;
            position: relative;
            min-height: 38px;
        }

        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .leader-item.top-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: 2px solid #ffd700;
        }

        .leader-item.top-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            border: 2px solid #c0c0c0;
        }

        .leader-item.top-3 {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            border: 2px solid #cd7f32;
        }

        .leader-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
            font-size: 12px;
            flex-shrink: 0;
        }

        .leader-item.top-1 .leader-rank {
            background: #ffd700;
            color: #333;
        }

        .leader-item.top-2 .leader-rank {
            background: #c0c0c0;
            color: #333;
        }

        .leader-item.top-3 .leader-rank {
            background: #cd7f32;
            color: white;
        }

        .leader-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }

        .leader-name {
            font-weight: 600;
            font-size: 13px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leader-username {
            display: none;
        }

        .leader-balance {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
        }

        .balance-ndn {
            font-weight: 700;
            font-size: 13px;
            color: #667eea;
            white-space: nowrap;
        }

        .pro-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            font-size: 12px;
        }

        /* Стили для правил */
        .rules-modal .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }
        
        .rules-modal .modal-body {
            max-height: calc(90vh - 120px);
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .rules-modal .modal-buttons {
            position: sticky;
            bottom: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 15px 0 0 0;
            margin-top: 20px;
            border-top: 1px solid #eee;
        }

        .rules-content {
            margin-bottom: 20px;
        }

        .rule-section {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .rule-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .rule-content {
            color: #666;
            line-height: 1.6;
            white-space: pre-line;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .rules-modal .modal-content {
                max-width: 95vw;
                max-height: 95vh;
                margin: 10px;
            }
            
            .rules-modal .modal-body {
                max-height: calc(95vh - 140px);
            }
            
            .rule-section {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .rule-title {
                font-size: 1rem;
            }
            
            .rule-content {
                font-size: 0.9rem;
            }
        }

        /* ==================== ДОСТИЖЕНИЯ ==================== */
        
        .achievement-category {
            margin-bottom: 2rem;
        }
        
        .achievement-category h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .achievement-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .achievement-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .achievement-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .achievement-item.completed {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .achievement-icon {
            font-size: 2rem;
            min-width: 3rem;
            text-align: center;
        }
        
        .achievement-info {
            flex: 1;
        }
        
        .achievement-name {
            font-weight: 600;
            color: #000000;
            margin-bottom: 0.5rem;
        }
        
        .achievement-description {
            color: #333333;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .achievement-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 0.85rem;
            color: #000000;
            min-width: 60px;
            text-align: right;
            font-weight: 600;
        }
        
        .achievement-reward {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .reward-ndn, .reward-stars {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
        }
        
        .reward-ndn {
            color: #FFD700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .reward-stars {
            color: #FF6B6B;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .claimed {
            color: #4CAF50;
            font-weight: 600;
        }
        
        /* ==================== МАГАЗИНЫ ==================== */
        
        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--tg-theme-hint-color, #cccccc);
        }
        
        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .no-data-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--tg-theme-text-color, #ffffff);
        }
        
        .no-data-subtitle {
            font-size: 0.9rem;
        }
        
        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .shop-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--tg-theme-text-color, #ffffff);
        }
        
        .shop-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .shop-status.active {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        
        .shop-status.inactive {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }
        
        .shop-description {
            color: var(--tg-theme-hint-color, #cccccc);
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .shop-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .shop-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem;
            border-radius: 8px;
            min-width: 80px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--tg-theme-hint-color, #cccccc);
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--tg-theme-text-color, #ffffff);
        }
        
        .shop-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .shop-actions .button {
            flex: 1;
            min-width: 120px;
        }
        
        /* ==================== ФОРМЫ ==================== */
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--tg-theme-text-color, #ffffff);
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #667eea;
            border-radius: 12px;
            background: #ffffff !important;
            color: #000000 !important;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
            background: #ffffff !important;
            color: #000000 !important;
        }
        
        .form-input::placeholder {
            color: #666666 !important;
            opacity: 0.8;
        }
        
        .form-input:hover {
            border-color: #5a67d8;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Дополнительные стили для лучшей видимости */
        .form-input:not(:focus) {
            background: #ffffff !important;
            color: #000000 !important;
        }

        .form-input:not(:focus)::placeholder {
            color: #666666 !important;
        }

        /* Дополнительные стили для полей ввода в модальных окнах */
        .modal .form-input {
            background: #ffffff !important;
            color: #000000 !important;
            border: 2px solid #4CAF50;
        }

        .modal .form-input::placeholder {
            color: #666666 !important;
        }

        .modal .form-input:focus {
            background: #ffffff !important;
            color: #000000 !important;
            border-color: #45a049;
            outline: none;
        }
        
        /* Стили для модальных окон */
        .modal-content {
            background: var(--tg-theme-bg-color, #1a1a1a) !important;
            color: var(--tg-theme-text-color, #ffffff) !important;
        }
        
        .modal-title {
            color: var(--tg-theme-text-color, #ffffff) !important;
        }
        
        .modal-subtitle {
            color: var(--tg-theme-hint-color, #cccccc) !important;
        }
        
        .form-label {
            color: var(--tg-theme-text-color, #ffffff) !important;
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }
        
        select.form-input {
            cursor: pointer;
            background: #ffffff !important;
            color: #000000 !important;
        }
        
        select.form-input option {
            background: #ffffff !important;
            color: #000000 !important;
            padding: 8px;
        }
        
        select.form-input:focus {
            background: #ffffff !important;
            color: #000000 !important;
        }

        /* Стили для модального окна приглашения друзей */
        .invite-content {
            padding: 20px 0;
        }

        .referral-link-section {
            margin-bottom: 30px;
        }

        .referral-link-section h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .link-container {
            margin-bottom: 15px;
        }

        .link-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .link-display {
            margin: 20px 0;
        }

        .link-text {
            background: #ffffff;
            color: #000000;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            user-select: all;
            margin-bottom: 15px;
        }

        .link-instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .link-instructions p {
            margin: 0 0 10px 0;
            font-weight: bold;
            color: var(--tg-theme-text-color, #ffffff);
        }

        .link-instructions ol {
            margin: 0;
            padding-left: 20px;
            color: var(--tg-theme-text-color, #ffffff);
        }

        .link-instructions li {
            margin-bottom: 5px;
        }
        .link-container .form-input {
            width: 100%;
            background: #ffffff !important;
            color: #000000 !important;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
        }

        .invite-methods {
            margin-bottom: 30px;
        }

        .invite-methods h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .method-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .method-buttons .button {
            flex: 1;
            min-width: 150px;
        }

        .referral-info h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-icon {
            font-size: 24px;
            min-width: 30px;
        }

        .info-text {
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 14px;
            line-height: 1.4;
        }

        /* Стили для модального окна перевода NDN */
        .transfer-content {
            padding: 20px 0;
        }

        .recipient-section, .amount-section {
            margin-bottom: 30px;
        }

        .recipient-section h3, .amount-section h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .recipient-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .recipient-avatar {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .recipient-details {
            flex: 1;
        }

        .recipient-name {
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .recipient-id {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        .recipient-input-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recipient-input-section .form-input {
            flex: 1;
            background: #ffffff !important;
            color: #000000 !important;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
        }

        .recipient-input-section .form-input::placeholder {
            color: #666666 !important;
        }

        .recipient-input-section .form-input:focus {
            background: #ffffff !important;
            color: #000000 !important;
            border-color: #45a049;
            outline: none;
        }

        .amount-input-container {
            position: relative;
        }

        .amount-input-container .form-input {
            width: 100%;
            margin-bottom: 10px;
        }

        .balance-info {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            text-align: right;
        }

        .transfer-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transfer-summary h3 {
            color: var(--tg-theme-text-color, #ffffff);
            margin-bottom: 15px;
            font-size: 16px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item.total {
            font-weight: 600;
            font-size: 16px;
            color: var(--tg-theme-text-color, #ffffff);
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .summary-item span:first-child {
            color: var(--tg-theme-hint-color, #999999);
        }

        .summary-item span:last-child {
            color: var(--tg-theme-text-color, #ffffff);
            font-weight: 500;
        }

        /* Стили для игрового ID */
        .user-id-section {
            text-align: center;
            padding: 20px;
        }

        .id-label {
            color: #000000;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: block;
        }

        .id-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .id-value {
            background: #ffffff;
            width: 100%;
            max-width: 300px;
            word-break: break-all;
            color: #000000;
            font-size: 18px;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .button-small {
            padding: 8px 12px;
            font-size: 14px;
            min-width: auto;
        }

        .id-hint {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 12px;
            margin-top: 5px;
        }

        /* Админ панель */
        .admin-panel-section {
            text-align: center;
            padding: 20px;
        }

        .admin-title {
            font-size: 18px;
            font-weight: 700;
            color: #ff6b35;
            margin-bottom: 10px;
        }

        .admin-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .wallet-stats, .system-stats {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        .wallet-stats h4, .system-stats h4 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            color: #ff6b35;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 107, 53, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 107, 53, 0.15);
        }

        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ff6b35;
        }

        .admin-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .button-admin {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .button-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .button-admin:active {
            transform: translateY(0);
        }

        /* Стили для заявок на обмен */
        .exchange-requests-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .exchange-request-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-info {
            flex: 1;
        }

        .request-user {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .request-amount {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .request-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .request-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 15px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .request-actions {
            display: flex;
            gap: 8px;
        }

        .request-actions .button {
            padding: 8px 12px;
            font-size: 12px;
            min-width: auto;
        }

        .button-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
        }

        .button-danger:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
            transform: translateY(-2px);
        }

        .no-requests {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Анимированный фон -->
    <div class="background-animation"></div>
    
    <!-- Плавающие частицы -->
    <div class="particles" id="particles"></div>

    <!-- Контейнер для уведомлений -->
    <div id="notificationContainer"></div>

    <div class="container">
        <!-- Заголовок -->
        <div class="header">
            <div class="logo" data-i18n="app.name">🚀 NodeOn Crypto</div>
            <div class="subtitle" data-i18n="app.description">Крипто игра с монетами NDN</div>
            <div class="language-selector">
                <select id="languageSelect" onchange="changeLanguage(this.value)">
                    <option value="ru">🇷🇺 Русский</option>
                    <option value="en">🇺🇸 English</option>
                    <option value="es">🇪🇸 Español</option>
                    <option value="de">🇩🇪 Deutsch</option>
                    <option value="fr">🇫🇷 Français</option>
                    <option value="zh">🇨🇳 中文</option>
                    <option value="ja">🇯🇵 日本語</option>
                    <option value="ko">🇰🇷 한국어</option>
                    <option value="ar">🇸🇦 العربية</option>
                    <option value="pt">🇵🇹 Português</option>
                    <option value="it">🇮🇹 Italiano</option>
                    <option value="hi">🇮🇳 हिन्दी</option>
                </select>
            </div>
        </div>

        <!-- Система вкладок -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" onclick="switchTab('core')" data-i18n="tabs.core">
                    🏠 Основное
                </button>
                <button class="tab-button" onclick="switchTab('game')" data-i18n="tabs.game">
                    🎮 Игра
                </button>
                <button class="tab-button" onclick="switchTab('miner')" data-i18n="tabs.miner">
                    ⛏️ NDN Miner
                </button>
            </div>
        </div>

        <!-- Вкладка Core (Основное) -->
        <div class="tab-content active" id="coreTab">
            <!-- Баланс -->
            <div class="balance-section">
            <div class="balance-item">
                <div class="balance-label" data-i18n="user.balance_ndn">NDN Баланс</div>
                <div class="balance-value" id="ndnBalance">0.00</div>
            </div>
        </div>


        <!-- Основные кнопки -->
        <div class="card">
            <button class="button button-primary" onclick="buyPro()" data-i18n="buttons.buy_pro">
                💎 Купить Pro статус
            </button>
            <button class="button button-secondary" onclick="buyNDN()" data-i18n="buttons.buy_ndn">
                ⭐ Купить NDN за Telegram Stars
            </button>
            <button class="button button-success" onclick="exchangeNDN()" data-i18n="buttons.exchange">
                ⭐ Обменять NDN на Stars
            </button>
            <button class="button button-info" onclick="transferNDN()" data-i18n="buttons.transfer_ndn">
                💸 Перевести NDN
            </button>
        </div>

        <!-- Дополнительные функции -->
        <div class="card">
            <button class="button button-primary" onclick="showAchievements()" data-i18n="buttons.achievements">
                🏆 Достижения
            </button>
            <button class="button button-secondary" onclick="showShops()" data-i18n="buttons.shops">
                🏪 Магазины
            </button>
            <button class="button button-success" onclick="showReferrals()" data-i18n="buttons.referrals">
                👥 Мои рефералы
            </button>
        </div>

        <!-- PRO функции (только для PRO пользователей) -->
        <div class="card" id="proFunctionsCard" style="display: none;">
            <button class="button button-success" onclick="inviteFriends()" data-i18n="buttons.invite_friends">
                📤 Пригласить друзей
            </button>
        </div>

        <!-- Дополнительные функции 2 -->
        <div class="card">
            <button class="button button-primary" onclick="showLeaderboard()" data-i18n="buttons.leaderboard">
                🏆 Таблица лидеров
            </button>
            <button class="button button-secondary" onclick="showRules()" data-i18n="buttons.rules">
                📋 Правила игры
            </button>
        </div>

        <!-- Игровой ID (внизу) -->
        <!-- Админ панель (только для админов) -->
        <div class="card" id="adminPanelCard" style="display: none;">
            <div class="admin-panel-section">
                <div class="admin-title">🛡️ Админ панель</div>
                <div class="admin-status" id="adminStatus">Загрузка...</div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">
                        📱 Версия: <span id="appVersion">1.1.6</span>
                    </div>
                
                <!-- Статистика серверного кошелька -->
                <div id="walletStats" class="wallet-stats" style="display: none;">
                    <h4>💰 Серверный кошелек</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">💎</div>
                            <div class="stat-info">
                                <div class="stat-label">Баланс NDN</div>
                                <div class="stat-value" id="walletBalance">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">⭐</div>
                            <div class="stat-info">
                                <div class="stat-label">Получено Stars</div>
                                <div class="stat-value" id="starsReceived">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🔄</div>
                            <div class="stat-info">
                                <div class="stat-label">Обменено NDN</div>
                                <div class="stat-value" id="ndnExchanged">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📤</div>
                            <div class="stat-info">
                                <div class="stat-label">Отправлено Stars</div>
                                <div class="stat-value" id="starsSent">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Общая статистика -->
                <div id="systemStats" class="system-stats" style="display: none;">
                    <h4>📊 Статистика системы</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">👥</div>
                            <div class="stat-info">
                                <div class="stat-label">Всего пользователей</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">💎</div>
                            <div class="stat-info">
                                <div class="stat-label">PRO пользователей</div>
                                <div class="stat-value" id="proUsers">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🔄</div>
                            <div class="stat-info">
                                <div class="stat-label">NDN в обороте</div>
                                <div class="stat-value" id="ndnInCirculation">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🔗</div>
                            <div class="stat-info">
                                <div class="stat-label">Рефералов</div>
                                <div class="stat-value" id="totalReferrals">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="admin-buttons">
                    <button class="button button-admin" onclick="showExchangeRequests()" id="exchangeRequestsBtn" style="display: none;">
                        💰 Заявки на обмен
                    </button>
                    <button class="button button-admin" onclick="showUserManagement()" id="userManagementBtn" style="display: none;">
                        👥 Управление пользователями
                    </button>
                    <button class="button button-admin" onclick="showAnalytics()" id="analyticsBtn" style="display: none;">
                        📊 Аналитика
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="user-id-section">
                <div class="id-label" data-i18n="user.user_id">🎮 Ваш игровой ID:</div>
                <div class="id-container">
                    <div class="id-value" id="userId">-</div>
                    <button class="button button-small" onclick="copyUserId()">📋</button>
                </div>
                <div class="id-hint" data-i18n="user.user_id_hint">Используйте этот ID для переводов другим игрокам</div>
            </div>
        </div>

        <!-- Тестовые функции (только в браузере) -->
        <div class="card" id="testFunctions" style="display: none;">
            <button class="button button-secondary" onclick="resetTestData()">
                🔄 Сбросить тестовые данные
            </button>
            <button class="button button-success" onclick="addTestMoney()">
                ⭐ Добавить тестовые Stars
            </button>
        </div>

        <!-- Загрузка -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Загрузка...</div>
        </div>
        </div>

        <!-- Вкладка Game (Игра) -->
        <div class="tab-content" id="gameTab">
            <!-- Напоминания -->
            <div class="reminder-banner" id="dailyReminder" onclick="claimDailyReward(1)" style="display: none;">
                🎁 Не забудьте получить ежедневную награду!
            </div>
            
            <!-- Ежедневные награды -->
            <div class="game-card">
                <h3 data-i18n="game.daily_rewards">🎁 Ежедневные награды</h3>
                <p data-i18n="game.daily_rewards_desc">Заходите каждый день и получайте бонусы! (прокрутите для просмотра всех дней)</p>
                <div class="daily-rewards-container">
                    <div class="daily-rewards" id="dailyRewards">
                        <!-- Будет заполнено JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Квесты -->
            <div class="game-card">
                <h3>🎯 Ежедневные квесты</h3>
                <p>Выполняйте 4 квеста каждый день и зарабатывайте 4 NDN!</p>
                <div id="dailyQuestsList" class="quests-list">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Недельные квесты -->
            <div class="game-card">
                <h3>📅 Недельные квесты</h3>
                <p>Выполняйте недельные задания и получайте до 9 NDN!</p>
                <div id="weeklyQuestsList" class="quests-list">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Колесо фортуны -->
            <div class="game-card">
                <h3>🎲 Колесо фортуны</h3>
                <p>Крутите колесо один раз в день и выигрывайте до 20 NDN!</p>
                <div class="fortune-wheel-container">
                    <div class="fortune-wheel" id="fortuneWheel">
                        <div class="wheel-prizes">
                            <div class="wheel-segment" style="--rotation: 0deg; --bg-color: #ff6b6b">
                                <span class="prize-label">1 NDN 🎯</span>
                            </div>
                            <div class="wheel-segment" style="--rotation: 60deg; --bg-color: #4ecdc4">
                                <span class="prize-label">2 NDN 💎</span>
                            </div>
                            <div class="wheel-segment" style="--rotation: 120deg; --bg-color: #45b7d1">
                                <span class="prize-label">3 NDN ⚡</span>
                            </div>
                            <div class="wheel-segment" style="--rotation: 180deg; --bg-color: #96ceb4">
                                <span class="prize-label">5 NDN 🎁</span>
                            </div>
                            <div class="wheel-segment" style="--rotation: 240deg; --bg-color: #ffeaa7">
                                <span class="prize-label">10 NDN 🏆</span>
                            </div>
                            <div class="wheel-segment" style="--rotation: 300deg; --bg-color: #fdcb6e">
                                <span class="prize-label">20 NDN 👑</span>
                            </div>
                        </div>
                        <div class="wheel-center">🎰</div>
                        <div class="wheel-arrow">▼</div>
                    </div>
                    <button class="spin-button" id="spinButton" onclick="spinWheel()">
                        🎲 Крутить колесо
                    </button>
                    <div class="spin-info" id="spinInfo">
                        <span id="spinCooldown"></span>
                    </div>
                </div>
            </div>

            <!-- Достижения -->
            <div class="game-card">
                <h3 data-i18n="game.achievements">🏆 Достижения</h3>
                <p data-i18n="game.achievements_desc">Выполняйте задачи и получайте награды! (30 достижений)</p>
                
                <!-- Фильтры категорий -->
                <div class="achievements-filters">
                    <button class="filter-btn active" onclick="filterAchievements('all')">Все</button>
                    <button class="filter-btn" onclick="filterAchievements('beginner')">🌱 Новичок</button>
                    <button class="filter-btn" onclick="filterAchievements('mining')">⛏️ Майнинг</button>
                    <button class="filter-btn" onclick="filterAchievements('wealth')">💰 Богатство</button>
                    <button class="filter-btn" onclick="filterAchievements('referral')">👥 Рефералы</button>
                    <button class="filter-btn" onclick="filterAchievements('activity')">📅 Активность</button>
                    <button class="filter-btn" onclick="filterAchievements('progress')">📊 Прогресс</button>
                    <button class="filter-btn" onclick="filterAchievements('special')">🎁 Особые</button>
                </div>
                
                <div id="achievementsList" class="achievements-grid">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Уровень игрока и ранг -->
            <div class="game-card">
                <h3 data-i18n="game.player_level">⭐ Уровень игрока</h3>
                
                <!-- Текущий ранг -->
                <div class="player-rank-display">
                    <div class="rank-icon" id="rankIcon">🌱</div>
                    <div class="rank-details">
                        <div class="rank-title" id="rankTitle">Новичок</div>
                        <div class="rank-bonus" id="rankBonus">Бонус: +0% к майнингу Gas</div>
                    </div>
                </div>
                
                <!-- Прогресс уровня -->
                <div class="level-progress">
                    <div class="level-info">
                        <span data-i18n="game.level">Уровень <span id="playerLevel">1</span></span>
                        <span><span id="currentXP">0</span> / <span id="nextLevelXP">100</span> <span data-i18n="game.xp">XP</span></span>
                    </div>
                    <div class="level-bar">
                        <div class="level-bar-fill" id="levelProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Следующий ранг -->
                <div class="next-rank-info" id="nextRankInfo">
                    <span>Следующий ранг: <strong id="nextRankName">⭐ Игрок</strong> на уровне <strong>5</strong></span>
                </div>
            </div>

            <!-- Статистика игры -->
            <div class="game-card">
                <h3 data-i18n="game.statistics">📊 Статистика</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">🎮</div>
                        <div class="stat-info">
                            <div class="stat-label" data-i18n="game.days_played">Дней в игре</div>
                            <div class="stat-value" id="daysPlayed">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">🏆</div>
                        <div class="stat-info">
                            <div class="stat-label" data-i18n="game.achievements_count">Достижений</div>
                            <div class="stat-value" id="achievementsCount">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">💰</div>
                        <div class="stat-info">
                            <div class="stat-label" data-i18n="game.total_earned">Заработано NDN</div>
                            <div class="stat-value" id="totalEarned">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">👥</div>
                        <div class="stat-info">
                            <div class="stat-label" data-i18n="game.total_referrals">Приглашено</div>
                            <div class="stat-value" id="totalReferrals">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Вкладка NDN Miner -->
        <div class="tab-content" id="minerTab">
            <!-- Статистика майнинга -->
            <div class="miner-stats">
                <div class="miner-stat-item">
                    <div class="miner-stat-icon">⛏️</div>
                    <div class="miner-stat-info">
                        <div class="miner-stat-label" data-i18n="miner.stats.ndn_gas">NDN Gas</div>
                        <div class="miner-stat-value" id="ndnGasBalance">100</div>
                    </div>
                </div>
                <div class="miner-stat-item">
                    <div class="miner-stat-icon">⚡</div>
                    <div class="miner-stat-info">
                        <div class="miner-stat-label" data-i18n="miner.stats.energy">Энергия</div>
                        <div class="miner-stat-value" id="energyLevel">100/100</div>
                    </div>
                </div>
                <div class="miner-stat-item">
                    <div class="miner-stat-icon">📊</div>
                    <div class="miner-stat-info">
                        <div class="miner-stat-label" data-i18n="miner.stats.gas_per_minute">Gas/мин</div>
                        <div class="miner-stat-value" id="gasPerSecond">0</div>
                    </div>
                </div>
                <div class="miner-stat-item">
                    <div class="miner-stat-icon">🎲</div>
                    <div class="miner-stat-info">
                        <div class="miner-stat-label" data-i18n="miner.stats.next_event">След. событие</div>
                        <div class="miner-stat-value" id="nextEventTime">24:00:00</div>
                    </div>
                </div>
            </div>

            <!-- Кнопка синхронизации -->
            <div class="miner-sync-controls">
                <button class="sync-button" onclick="forceSyncMinerData()">
                    🔄 <span data-i18n="miner.sync.button">Синхронизировать</span>
                </button>
            </div>

            <!-- Кнопка пополнения энергии -->
            <div class="energy-refill-section">
                <button class="energy-refill-button" id="energyRefillButton" onclick="refillEnergy()">
                    ⚡ <span data-i18n="miner.energy.refill_button">Пополнить энергию</span>
                </button>
                <div class="energy-refill-info" id="energyRefillInfo">
                    <span data-i18n="miner.energy.next_refill">Следующее пополнение через:</span> <span id="nextRefillTime">3:00:00</span>
                </div>
            </div>

            <!-- Фермы майнинга -->
            <div class="miner-farms">
                <h3 data-i18n="miner.farms_title">🏭 Фермы майнинга</h3>
                <div class="farms-grid" id="farmsGrid">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Улучшения -->
            <div class="miner-upgrades">
                <h3 data-i18n="miner.upgrades_title">🔧 Улучшения</h3>
                <div class="upgrades-tabs">
                    <button class="upgrade-tab active" onclick="switchUpgradeTab('speed')" data-i18n="miner.upgrade_tabs.speed">Скорость</button>
                    <button class="upgrade-tab" onclick="switchUpgradeTab('efficiency')" data-i18n="miner.upgrade_tabs.efficiency">Эффективность</button>
                    <button class="upgrade-tab" onclick="switchUpgradeTab('automation')" data-i18n="miner.upgrade_tabs.automation">Автоматизация</button>
                    <button class="upgrade-tab" onclick="switchUpgradeTab('premium')" data-i18n="miner.upgrade_tabs.premium">Премиум</button>
                </div>
                <div class="upgrades-content" id="upgradesContent">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Бусты -->
            <div class="miner-boosts">
                <h3>🚀 Магазин бустов</h3>
                <p>Покупайте бусты за Gas и ускоряйте майнинг!</p>
                <div class="boosts-grid" id="boostsGrid">
                    <!-- Будет заполнено JavaScript -->
                </div>
                <div class="active-boosts" id="activeBoosts">
                    <h4>Активные бусты:</h4>
                    <div id="activeBoostsList">
                        <p style="opacity: 0.6;">Нет активных бустов</p>
                    </div>
                </div>
            </div>

            <!-- Особые майнеры -->
            <div class="miner-special" style="display: none;">
                <h3 data-i18n="miner.special_title">🌟 Особые майнеры</h3>
                <div class="special-miners-grid" id="specialMinersGrid">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Квесты -->
            <div class="miner-quests" style="display: none;">
                <h3 data-i18n="miner.quests_title">📋 Квесты</h3>
                <div class="quests-list" id="questsList">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Магазин -->
            <div class="miner-shop">
                <h3 data-i18n="miner.shop.title">🛒 Магазин</h3>
                <div class="shop-items" id="shopItems">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>

            <!-- Рейтинг майнеров -->
            <div class="miner-leaderboard">
                <h3 data-i18n="miner.leaderboard.title">🏆 Рейтинг майнеров</h3>
                <div class="leaderboard-table" id="leaderboardTable">
                    <!-- Будет заполнено JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно покупки Pro -->
    <div class="modal" id="buyProModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.buy_pro">💎 Купить Pro статус</div>
                <div class="modal-subtitle" data-i18n="pro.cost">Стоимость: 1000 NDN</div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="user.balance_ndn">Ваш баланс NDN:</label>
                <div class="balance-value" id="modalNdnBalance">0.00</div>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmBuyPro()" data-i18n="buttons.confirm">Подтвердить</button>
                <button class="button button-secondary" onclick="closeModal('buyProModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно покупки NDN -->
    <div class="modal" id="buyNDNModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.buy_ndn">⭐ Купить NDN за Telegram Stars</div>
                <div class="modal-subtitle" data-i18n="payment.rate">Курс: 1 NDN = 1 Telegram Star</div>
                <div class="modal-subtitle" style="font-size: 0.8rem; color: #666; margin-top: 5px;" data-i18n="payment.stars_info">
                    💡 Stars поступают на баланс бота и могут быть выведены в TON
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="transfer.amount">Количество NDN:</label>
                <input type="number" class="form-input" id="ndnAmount" data-i18n-placeholder="transfer.amount" placeholder="Введите количество" min="1">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="payment.stars_cost">Стоимость в Stars:</label>
                <div class="balance-value" id="starsCost">0</div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;" data-i18n="payment.stars_info">
                    💡 Stars поступают на баланс бота и могут быть выведены в TON
                </div>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmBuyNDN()" data-i18n="buttons.buy">Купить</button>
                <button class="button button-secondary" onclick="closeModal('buyNDNModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно обмена NDN на Stars -->
    <div class="modal" id="exchangeNDNModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.exchange">⭐ Обменять NDN на Telegram Stars</div>
                <div class="modal-subtitle" data-i18n="payment.rate">Курс: 1 NDN = 1 Telegram Star</div>
                <div class="modal-subtitle" style="font-size: 0.8rem; color: #666; margin-top: 5px;" data-i18n="exchange.stars_info">
                    💡 NDN списываются с вашего счета, Stars поступают в Telegram
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="transfer.amount">Количество NDN для обмена:</label>
                <input type="number" class="form-input" id="exchangeAmount" data-i18n-placeholder="transfer.amount" placeholder="Введите количество" min="1" oninput="updateExchangeStars()">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="exchange.username">Ваш Telegram username:</label>
                <input type="text" class="form-input" id="exchangeUsername" placeholder="@username" value="@NobodyYety">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="exchange.receive_stars">Получите Stars:</label>
                <div class="balance-value" id="exchangeStars">0</div>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmExchangeNDN()" data-i18n="buttons.exchange">Обменять</button>
                <button class="button button-secondary" onclick="closeModal('exchangeNDNModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно вывода NDN -->
    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.withdraw_ndn">💰 Вывести NDN</div>
                <div class="modal-subtitle" data-i18n="withdraw.minimum">Минимальная сумма: 100 NDN</div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="transfer.amount">Количество NDN:</label>
                <input type="number" class="form-input" id="withdrawAmount" data-i18n-placeholder="transfer.amount" placeholder="Введите количество" min="100">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="withdraw.recipient_id">Telegram ID получателя:</label>
                <input type="text" class="form-input" id="recipientId" data-i18n-placeholder="withdraw.recipient_placeholder" placeholder="@username или ID">
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmWithdraw()" data-i18n="buttons.withdraw">Вывести</button>
                <button class="button button-secondary" onclick="closeModal('withdrawModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно достижений -->
    <div class="modal" id="achievementsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.achievements">🏆 Достижения</div>
                <div class="modal-subtitle" data-i18n="achievements.description">Выполняйте задачи и получайте награды!</div>
            </div>
            <div class="modal-body" id="achievementsList">
                <div class="loading">Загрузка достижений...</div>
            </div>
            <div class="modal-buttons">
                <button class="button button-secondary" onclick="closeModal('achievementsModal')" data-i18n="buttons.back">← Назад</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно магазинов -->
    <div class="modal" id="shopsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.shops">🏪 Магазины</div>
                <div class="modal-subtitle" data-i18n="shops.description">Откройте свой магазин за 10,000 NDN!</div>
            </div>
            <div class="modal-body" id="shopsList">
                <div class="loading">Загрузка магазинов...</div>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="showOpenShopForm()" data-i18n="shops.open_shop">🏪 Открыть магазин</button>
                <button class="button button-secondary" onclick="closeModal('shopsModal')" data-i18n="buttons.back">← Назад</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно открытия магазина -->
    <div class="modal" id="openShopModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="shops.open_shop">🏪 Открыть магазин</div>
                <div class="modal-subtitle" data-i18n="shops.cost">Стоимость: 10,000 NDN</div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.shop_name">Название магазина:</label>
                <input type="text" class="form-input" id="shopName" data-i18n-placeholder="shops.shop_name" placeholder="Введите название магазина">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.shop_description">Описание:</label>
                <textarea class="form-input" id="shopDescription" data-i18n-placeholder="shops.shop_description" placeholder="Опишите ваш магазин" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.category">Категория:</label>
                <select class="form-input" id="shopCategory">
                    <option value="general" data-i18n="shops.categories.general">Общие товары</option>
                    <option value="digital" data-i18n="shops.categories.digital">Цифровые товары</option>
                    <option value="physical" data-i18n="shops.categories.physical">Физические товары</option>
                    <option value="services" data-i18n="shops.categories.services">Услуги</option>
                    <option value="congratulations" data-i18n="shops.categories.congratulations">Поздравления</option>
                    <option value="merchandise" data-i18n="shops.categories.merchandise">Мерч</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmOpenShop()" data-i18n="shops.open_shop">Открыть магазин</button>
                <button class="button button-secondary" onclick="closeModal('openShopModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления товара -->
    <div class="modal" id="addItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="shops.add_item">📦 Добавить товар</div>
                <div class="modal-subtitle" data-i18n="shops.add_item_description">Добавьте товар в ваш магазин</div>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.item_name">Название товара:</label>
                <input type="text" class="form-input" id="itemName" data-i18n-placeholder="shops.item_name" placeholder="Введите название товара">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.item_description">Описание:</label>
                <textarea class="form-input" id="itemDescription" data-i18n-placeholder="shops.item_description" placeholder="Опишите товар" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.price_ndn">Цена в NDN:</label>
                <input type="number" class="form-input" id="itemPriceNDN" placeholder="0" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.price_stars">Цена в Stars:</label>
                <input type="number" class="form-input" id="itemPriceStars" placeholder="0" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.item_type">Тип товара:</label>
                <select class="form-input" id="itemType">
                    <option value="digital" data-i18n="shops.types.digital">Цифровой</option>
                    <option value="physical" data-i18n="shops.types.physical">Физический</option>
                    <option value="service" data-i18n="shops.types.service">Услуга</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.category">Категория:</label>
                <select class="form-input" id="itemCategory">
                    <option value="congratulations" data-i18n="shops.categories.congratulations">Поздравления</option>
                    <option value="merchandise" data-i18n="shops.categories.merchandise">Мерч</option>
                    <option value="digital" data-i18n="shops.categories.digital">Цифровые товары</option>
                    <option value="services" data-i18n="shops.categories.services">Услуги</option>
                    <option value="general" data-i18n="shops.categories.general">Общие</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.image_url">Ссылка на изображение:</label>
                <input type="url" class="form-input" id="itemImageUrl" placeholder="https://example.com/image.jpg">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="shops.stock">Количество на складе (-1 = безлимит):</label>
                <input type="number" class="form-input" id="itemStock" placeholder="-1" min="-1">
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="confirmAddItem()" data-i18n="shops.add_item">Добавить товар</button>
                <button class="button button-secondary" onclick="closeModal('addItemModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно приглашения друзей -->
    <div class="modal" id="inviteFriendsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="buttons.invite_friends">📤 Пригласить друзей</div>
                <div class="modal-subtitle" data-i18n="referrals.invite_description">Поделитесь ссылкой и зарабатывайте с каждого реферала!</div>
            </div>
            <div class="invite-content">
                    <div class="referral-link-section">
                        <h3 data-i18n="referrals.your_link">🔗 Ваша реферальная ссылка:</h3>
                        <div class="link-container">
                            <input type="text" class="form-input" id="referralLinkInput" readonly>
                        </div>
                        <div class="link-actions">
                            <button class="button button-primary" onclick="copyReferralLink()" data-i18n="buttons.copy">📋 Копировать</button>
                            <button class="button button-secondary" onclick="showLinkModal()" data-i18n="referrals.show_link">👁️ Показать ссылку</button>
                        </div>
                    </div>
                
                <div class="invite-methods">
                    <h3 data-i18n="referrals.invite_methods">📱 Способы приглашения:</h3>
                    <div class="method-buttons">
                        <button class="button button-success" onclick="inviteToTelegramContact()" data-i18n="referrals.select_contact">
                            📱 Выбрать контакт из Telegram
                        </button>
                        <button class="button button-primary" onclick="shareViaTelegram()" data-i18n="referrals.share_telegram">
                            🌐 Поделиться в Telegram
                        </button>
                        <button class="button button-secondary" onclick="shareViaOther()" data-i18n="referrals.copy_link">
                            🔗 Скопировать ссылку
                        </button>
                    </div>
                </div>
                
                <div class="referral-info">
                    <h3 data-i18n="referrals.how_to_earn">💰 Как зарабатывать:</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-icon">1️⃣</div>
                            <div class="info-text" data-i18n="referrals.step1">Друг переходит по вашей ссылке</div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">2️⃣</div>
                            <div class="info-text" data-i18n="referrals.step2">Регистрируется в игре</div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">3️⃣</div>
                            <div class="info-text" data-i18n="referrals.step3">Покупает PRO статус</div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">4️⃣</div>
                            <div class="info-text" data-i18n="referrals.step4">Вы получаете 200 NDN</div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">5️⃣</div>
                            <div class="info-text" data-i18n="referrals.step5">Зарабатываете до 7 уровней в глубину</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="button button-secondary" onclick="closeModal('inviteFriendsModal')" data-i18n="buttons.back">← Назад</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно перевода NDN -->
    <div class="modal" id="transferNDNModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="transfer.title">💸 Перевести NDN</div>
                <div class="modal-subtitle" data-i18n="transfer.instructions">Выберите получателя и введите сумму</div>
            </div>
            <div class="transfer-content">
                <div class="recipient-section">
                    <h3 data-i18n="transfer.recipient">👤 Получатель:</h3>
                    <div class="recipient-info" id="recipientInfo" style="display: none;">
                        <div class="recipient-card">
                            <div class="recipient-avatar">👤</div>
                            <div class="recipient-details">
                                <div class="recipient-name" id="recipientName"></div>
                                <div class="recipient-id" id="recipientId"></div>
                            </div>
                            <button class="button button-secondary" onclick="changeRecipient()" data-i18n="buttons.change">Изменить</button>
                        </div>
                    </div>
                    <div class="recipient-input-section" id="recipientInputSection">
                        <input type="text" class="form-input" id="recipientIdInput" data-i18n-placeholder="transfer.recipient" placeholder="Введите игровой ID получателя">
                        <button class="button button-primary" id="findRecipientBtn" onclick="findRecipient()" data-i18n="buttons.find_player">
                            🔍 Найти игрока
                        </button>
                    </div>
                </div>
                
                <div class="amount-section">
                    <h3 data-i18n="transfer.amount">💰 Сумма перевода:</h3>
                    <div class="amount-input-container">
                        <input type="number" class="form-input" id="transferAmount" data-i18n-placeholder="transfer.amount" placeholder="Введите сумму NDN" min="0.01" step="0.01">
                        <div class="balance-info">
                            <span data-i18n="transfer.balance">Ваш баланс:</span> <span id="transferBalance">0</span> NDN
                        </div>
                    </div>
                </div>
                
                <div class="transfer-summary" id="transferSummary" style="display: none;">
                    <h3>📋 Сводка перевода:</h3>
                    <div class="summary-item">
                        <span>Получатель:</span>
                        <span id="summaryRecipient"></span>
                    </div>
                    <div class="summary-item">
                        <span>Сумма:</span>
                        <span id="summaryAmount"></span> NDN
                    </div>
                    <div class="summary-item">
                        <span>Комиссия:</span>
                        <span id="summaryFee">0</span> NDN
                    </div>
                    <div class="summary-item total">
                        <span>Итого к списанию:</span>
                        <span id="summaryTotal"></span> NDN
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="button button-success" id="confirmTransferBtn" onclick="confirmTransfer()" disabled data-i18n="transfer.confirm">
                    💸 Перевести
                </button>
                <button class="button button-secondary" onclick="closeModal('transferNDNModal')" data-i18n="buttons.cancel">Отмена</button>
            </div>
        </div>
    </div>
    <script>
        // Инициализация Telegram WebApp
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Глобальные переменные
        console.log('🔄 App version: 1.1.6 - Referral System Fix');
        
        let userData = null;
        let currentLanguage = 'ru';
        let referralToken = null;
        let translations = {};
        let supportedLanguages = [];
        let gameData = {
            level: 1,
            xp: 0,
            achievements: [],
            dailyRewards: [],
            stats: {
                daysPlayed: 0,
                totalEarned: 0,
                totalReferrals: 0
            }
        };

        // NDN Miner данные - инициализируем пустыми, загрузим с сервера
        let minerData = {
            ndnGas: 100,
            energy: 100,
            maxEnergy: 100,
            gasPerMinute: 0,
            farms: [],
            upgrades: {
                speed: 0,
                efficiency: 0,
                automation: 0
            },
            totalGasEarned: 100,
            lastEnergyRefill: Date.now(),
            lastUpdate: Date.now(),
            energyRefillCooldown: 3 * 60 * 60 * 1000
        };
        
        // Смешные события и бонусы
        const funnyEvents = [
            {
                id: 'cat_on_keyboard',
                name: 'Кот на клавиатуре!',
                description: 'Ваш кот случайно нажал на кнопку "Турбо-режим"!',
                icon: '🐱',
                effect: 'speed_boost',
                duration: 30000, // 30 секунд
                message: 'Майнеры работают в 2 раза быстрее!'
            },
            {
                id: 'coffee_spill',
                name: 'Пролитый кофе',
                description: 'Кофе попал на сервер, но почему-то улучшил производительность!',
                icon: '☕',
                effect: 'efficiency_boost',
                duration: 45000, // 45 секунд
                message: 'Потребление энергии снижено на 50%!'
            },
            {
                id: 'bitcoin_halving',
                name: 'Bitcoin Halving',
                description: 'Случайно произошел халвинг Bitcoin, все майнеры стали работать лучше!',
                icon: '₿',
                effect: 'all_boost',
                duration: 60000, // 1 минута
                message: 'Все майнеры работают в 3 раза эффективнее!'
            },
            {
                id: 'alien_tech',
                name: 'Инопланетная технология',
                description: 'Пришельцы поделились своими технологиями!',
                icon: '👽',
                effect: 'free_gas',
                duration: 0,
                message: 'Получено 1000 Gas от инопланетян!'
            },
            {
                id: 'miner_strike',
                name: 'Забастовка майнеров',
                description: 'Майнеры объявили забастовку и требуют больше энергии!',
                icon: '✊',
                effect: 'energy_drain',
                duration: 20000, // 20 секунд
                message: 'Майнеры не работают, но потребляют энергию!'
            }
        ];
        
        let activeEvents = [];
        let lastEventTime = parseInt(localStorage.getItem('miner_last_event_time') || '0');
        
        // Система уровней и престижа
        let prestigeData = {
            level: 1,
            prestigePoints: 0,
            totalPrestigePoints: 0,
            prestigeMultiplier: 1.0,
            prestigeUnlocked: false
        };
        
        // Система квестов
        const quests = [
            {
                id: 'first_miner',
                name: 'Первый майнер',
                description: 'Купите свой первый майнер',
                icon: '🌱',
                reward: { gas: 100, xp: 50 },
                condition: (data) => data.farms && data.farms.length >= 1,
                completed: false
            },
            {
                id: 'gas_collector',
                name: 'Собиратель',
                description: 'Накопите 1000 Gas',
                icon: '💰',
                reward: { gas: 500, xp: 100 },
                condition: (data) => data.totalGasEarned >= 1000,
                completed: false
            },
            {
                id: 'mining_tycoon',
                name: 'Магнат',
                description: 'Купите 5 ферм',
                icon: '🏭',
                reward: { gas: 1000, xp: 200 },
                condition: (data) => data.farms && data.farms.length >= 5,
                completed: false
            },
            {
                id: 'energy_master',
                name: 'Мастер энергии',
                description: 'Пополните энергию 10 раз',
                icon: '⚡',
                reward: { gas: 800, xp: 150 },
                condition: (data) => data.energyRefills >= 10,
                completed: false
            },
            {
                id: 'speed_demon',
                name: 'Скоростной демон',
                description: 'Достигните 100 Gas/мин',
                icon: '🚀',
                reward: { gas: 2000, xp: 300 },
                condition: (data) => data.gasPerMinute >= 100,
                completed: false
            }
        ];
        
        let completedQuests = JSON.parse(localStorage.getItem('miner_completed_quests') || '[]');
        
        // Система бустов
        const boosts = [
            {
                id: 'double_gas',
                name: 'Двойной Gas',
                description: 'Удваивает генерацию Gas на 1 час',
                icon: '💎',
                duration: 60 * 60 * 1000, // 1 час
                effect: 'gas_multiplier',
                value: 2,
                cost: 1000
            },
            {
                id: 'energy_saver',
                name: 'Энергосберегатель',
                description: 'Снижает потребление энергии на 50% на 2 часа',
                icon: '🔋',
                duration: 2 * 60 * 60 * 1000, // 2 часа
                effect: 'energy_efficiency',
                value: 0.5,
                cost: 1500
            },
            {
                id: 'speed_boost',
                name: 'Турбо-режим',
                description: 'Увеличивает скорость майнинга в 3 раза на 30 минут',
                icon: '⚡',
                duration: 30 * 60 * 1000, // 30 минут
                effect: 'mining_speed',
                value: 3,
                cost: 800
            }
        ];
        
        let activeBoosts = [];
        
        // Особые майнеры (только на сутки)
        const specialMiners = [
            {
                id: 'quantum_miner',
                name: 'Квантовый майнер',
                description: 'Сверхмощный майнер на 24 часа',
                icon: '🔮',
                gasPerMinute: 1000,
                energyCost: 50,
                duration: 24 * 60 * 60 * 1000, // 24 часа
                cost: 5000,
                adRequired: true
            },
            {
                id: 'time_warp_miner',
                name: 'Машина времени',
                description: 'Майнер из будущего на 24 часа',
                icon: '⏰',
                gasPerMinute: 2000,
                energyCost: 100,
                duration: 24 * 60 * 60 * 1000,
                cost: 10000,
                adRequired: true
            },
            {
                id: 'galaxy_miner',
                name: 'Галактический майнер',
                description: 'Майнер с другой планеты на 24 часа',
                icon: '🌌',
                gasPerMinute: 5000,
                energyCost: 200,
                duration: 24 * 60 * 60 * 1000,
                cost: 25000,
                adRequired: true
            }
        ];
        
        let activeSpecialMiners = [];
        
        // Секретные достижения
        const secretAchievements = [
            {
                id: 'first_farm',
                name: 'Первый шаг',
                description: 'Купили первую ферму!',
                icon: '🌱',
                condition: (data) => data.farms && data.farms.length >= 1,
                reward: 50
            },
            {
                id: 'gas_collector',
                name: 'Собиратель Gas',
                description: 'Накопили 1000 Gas!',
                icon: '💰',
                condition: (data) => data.totalGasEarned >= 1000,
                reward: 100
            },
            {
                id: 'mining_tycoon',
                name: 'Магнат майнинга',
                description: 'Купили 10 ферм!',
                icon: '🏭',
                condition: (data) => data.farms && data.farms.length >= 10,
                reward: 500
            },
            {
                id: 'energy_master',
                name: 'Мастер энергии',
                description: 'Пополнили энергию 5 раз!',
                icon: '⚡',
                condition: (data) => data.energyRefills >= 5,
                reward: 200
            },
            {
                id: 'lucky_strike',
                name: 'Удачливый удар',
                description: 'Получили 3 случайных события подряд!',
                icon: '🍀',
                condition: (data) => data.consecutiveEvents >= 3,
                reward: 300
            }
        ];
        
        let unlockedAchievements = JSON.parse(localStorage.getItem('miner_achievements') || '[]');
        
        // Данные майнера будут загружены с сервера в initializeMinerData()

        // Фермы майнинга
        const farmTypes = [
            {
                id: 'cpu_miner',
                name: 'CPU Miner',
                icon: '💻',
                description: 'Базовая ферма на процессоре',
                baseGasPerMinute: 1, // Изменено с baseGasPerSecond на baseGasPerMinute
                baseCost: 50,
                energyCost: 1,
                unlockLevel: 1
            },
            {
                id: 'gpu_farm',
                name: 'GPU Farm',
                icon: '🎮',
                description: 'Мощная ферма на видеокартах',
                baseGasPerMinute: 5, // Изменено с baseGasPerSecond на baseGasPerMinute
                baseCost: 250,
                energyCost: 3,
                unlockLevel: 3
            },
            {
                id: 'asic_rig',
                name: 'ASIC Rig',
                icon: '⚡',
                description: 'Профессиональная ферма ASIC',
                baseGasPerMinute: 20, // Изменено с baseGasPerSecond на baseGasPerMinute
                baseCost: 1000,
                energyCost: 8,
                unlockLevel: 5
            },
            {
                id: 'data_center',
                name: 'Data Center',
                icon: '🏢',
                description: 'Мега-ферма в дата-центре',
                baseGasPerMinute: 100, // Изменено с baseGasPerSecond на baseGasPerMinute
                baseCost: 5000,
                energyCost: 25,
                unlockLevel: 10
            }
        ];

        // Улучшения
        const upgradeTypes = {
            speed: [
                { name: 'Быстрый процессор', description: '+10% скорости', cost: 50, effect: 0.1 },
                { name: 'Оптимизация кода', description: '+25% скорости', cost: 150, effect: 0.25 },
                { name: 'Параллельные вычисления', description: '+50% скорости', cost: 400, effect: 0.5 }
            ],
            efficiency: [
                { name: 'Энергосбережение', description: '-20% энергии', cost: 30, effect: 0.2 },
                { name: 'Умное охлаждение', description: '-40% энергии', cost: 100, effect: 0.4 },
                { name: 'Квантовая оптимизация', description: '-60% энергии', cost: 300, effect: 0.6 }
            ],
            automation: [
                { name: 'Авто-сбор', description: 'Автоматический сбор Gas', cost: 100, effect: 1 },
                { name: 'Умные алгоритмы', description: 'Оптимизация майнинга', cost: 250, effect: 2 },
                { name: 'ИИ управление', description: 'Полная автоматизация', cost: 500, effect: 3 }
            ]
        };

        // Система вкладок
        function switchTab(tabName) {
            // Убираем активный класс со всех кнопок и контента
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Активируем выбранную вкладку
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // Загружаем данные для игровой вкладки
            if (tabName === 'game') {
                loadGameData();
            }
            
            // Инициализируем майнер при переключении на вкладку майнера
            if (tabName === 'miner') {
                console.log('🔄 Переключаемся на вкладку майнера...');
                setTimeout(() => {
                    initializeMinerData();
                    
                    // Проверяем, что кнопка синхронизации видна
                    setTimeout(() => {
                        const syncButton = document.querySelector('.sync-button');
                        console.log('🔘 Кнопка синхронизации после перехода:', syncButton);
                        if (syncButton) {
                            console.log('✅ Кнопка синхронизации найдена и готова к использованию');
                        } else {
                            console.error('❌ Кнопка синхронизации не найдена после перехода на вкладку майнера!');
                        }
                    }, 500);
                }, 100);
            }
        }

        // Игровые механики
        function loadGameData() {
            loadDailyRewards();
            loadAchievements();
            loadPlayerLevel();
            loadGameStats();
            loadQuests();           // Новое: квесты
            loadPlayerRank();       // Новое: ранг игрока
            loadBoosts();           // Новое: бусты
            updateSpinCooldown();   // Новое: колесо фортуны
        }

        function loadDailyRewards() {
            const rewards = [
                { day: 1, icon: '💰', amount: 2, claimed: false },
                { day: 2, icon: '💎', amount: 4, claimed: false },
                { day: 3, icon: '⭐', amount: 6, claimed: false },
                { day: 4, icon: '🎁', amount: 10, claimed: false },
                { day: 5, icon: '💎', amount: 15, claimed: false },
                { day: 6, icon: '⭐', amount: 20, claimed: false },
                { day: 7, icon: '🏆', amount: 40, claimed: false }
            ];

            const container = document.getElementById('dailyRewards');
            if (!container) {
                console.warn('Контейнер dailyRewards не найден');
                return;
            }

            container.innerHTML = rewards.map(reward => {
                const today = new Date().getDay() + 1;
                const isClaimed = gameData.dailyRewards.includes(reward.day);
                const isAvailable = reward.day <= today && !isClaimed;
                const isLocked = reward.day > today;

                console.log(`Награда день ${reward.day}: claimed=${isClaimed}, available=${isAvailable}, locked=${isLocked}`);

                return `
                    <div class="reward-day ${isClaimed ? 'claimed' : isAvailable ? 'available' : isLocked ? 'locked' : ''}" 
                         onclick="${isAvailable ? `claimDailyReward(${reward.day})` : ''}"
                         title="${isClaimed ? 'Получено' : isAvailable ? 'Доступно' : isLocked ? 'Заблокировано' : ''}">
                        <div class="reward-icon">${reward.icon}</div>
                        <div class="reward-amount">${reward.amount}</div>
                        <div style="font-size: 10px; margin-top: 2px;">День ${reward.day}</div>
                        ${isClaimed ? '<div style="font-size: 8px; color: #4CAF50;">✓</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        async function claimDailyReward(day) {
            if (gameData.dailyRewards.includes(day)) {
                showNotification('Награда уже получена!', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/game/daily-reward', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `tma ${tg.initData || ''}`
                    },
                    body: JSON.stringify({
                        telegram_id: userData?.telegram_id,
                        day: day
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Обновляем локальные данные
                    gameData.dailyRewards.push(day);
                    gameData.xp += result.reward_amount;
                    gameData.stats.totalEarned += result.reward_amount;

                    // Обновляем баланс пользователя
                    if (userData) {
                        userData.balance_ndn = (userData.balance_ndn || 0) + result.reward_amount;
                    }

                    // Сохраняем награды в localStorage
                    saveDailyRewardsToStorage();

                    // Обновляем UI
                    loadDailyRewards();
                    loadPlayerLevel();
                    loadGameStats();
                    updateUI(); // Обновляем основной UI

                    showNotification(`🎁 Получена награда: ${result.reward_amount} NDN!`, 'success');
                    playSound('success');
                } else {
                    showNotification('Ошибка получения награды', 'error');
                }
            } catch (error) {
                console.error('Error claiming daily reward:', error);
                // Fallback - добавляем награду локально
                const rewards = { 1: 2, 2: 4, 3: 6, 4: 10, 5: 15, 6: 20, 7: 40 };
                const rewardAmount = rewards[day] || 0;
                
                gameData.dailyRewards.push(day);
                gameData.xp += rewardAmount;
                gameData.stats.totalEarned += rewardAmount;
                
                if (userData) {
                    userData.balance_ndn = (userData.balance_ndn || 0) + rewardAmount;
                }

                // Сохраняем награды в localStorage
                saveDailyRewardsToStorage();

                loadDailyRewards();
                loadPlayerLevel();
                loadGameStats();
                updateUI();

                showNotification(`🎁 Получена награда: ${rewardAmount} NDN! (офлайн)`, 'success');
            }
        }

        async function loadAchievements() {
            const container = document.getElementById('achievementsList');
            if (!container) {
                console.warn('Контейнер achievementsList не найден');
                return;
            }

            console.log('📊 Загружаем достижения...');

            try {
                const response = await fetch('/api/game/achievements', {
                    headers: {
                        'Authorization': `tma ${tg.initData || ''}`
                    }
                });

                const result = await response.json();
                console.log('📊 Результат загрузки достижений:', result);
                
                if (result.success && result.achievements && Array.isArray(result.achievements)) {
                    const achievements = result.achievements;
                    allAchievements = achievements; // Сохраняем для фильтрации
                    console.log('✅ Получено достижений:', achievements.length);
                    
                    if (achievements.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Нет доступных достижений</div>';
                        return;
                    }
                    
                    container.innerHTML = achievements.map(achievement => {
                        const isCompleted = achievement.completed || false;
                        const progress = achievement.progress || 0;
                        const maxProgress = achievement.max_progress || 1;
                        const progressPercent = Math.min(100, (progress / maxProgress) * 100);

                        return `
                            <div class="achievement-item ${isCompleted ? 'completed' : ''}">
                                <div class="achievement-icon">${achievement.icon || '🏆'}</div>
                                <div class="achievement-info">
                                    <div class="achievement-title">${achievement.title || achievement.name || 'Достижение'}</div>
                                    <div class="achievement-description">${achievement.description || ''}</div>
                                    <div class="achievement-progress">
                                        <div class="achievement-progress-bar" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; opacity: 0.8;">${progress}/${maxProgress}</div>
                                    <div style="font-size: 14px; font-weight: bold; color: #FFD700;">${achievement.reward || 0} NDN</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    console.warn('⚠️ Неверная структура данных или нет достижений, используем fallback');
                    loadAchievementsFallback();
                }
            } catch (error) {
                console.error('❌ Error loading achievements:', error);
                loadAchievementsFallback();
            }
        }

        function loadAchievementsFallback() {
            const achievements = [
                {
                    id: 'first_login',
                    title: 'Первые шаги',
                    description: 'Войти в игру впервые',
                    icon: '🎮',
                    progress: userData ? 1 : 0,
                    maxProgress: 1,
                    reward: 50
                },
                {
                    id: 'pro_user',
                    title: 'Pro игрок',
                    description: 'Купить Pro статус',
                    icon: '💎',
                    progress: userData && userData.is_pro ? 1 : 0,
                    maxProgress: 1,
                    reward: 100
                },
                {
                    id: 'referral_master',
                    title: 'Мастер рефералов',
                    description: 'Пригласить 5 друзей',
                    icon: '👥',
                    progress: Math.min(gameData.stats.totalReferrals, 5),
                    maxProgress: 5,
                    reward: 200
                },
                {
                    id: 'daily_player',
                    title: 'Ежедневный игрок',
                    description: 'Заходить в игру 7 дней подряд',
                    icon: '📅',
                    progress: Math.min(gameData.stats.daysPlayed, 7),
                    maxProgress: 7,
                    reward: 300
                }
            ];

            const container = document.getElementById('achievementsList');
            if (!container) {
                console.warn('Контейнер achievementsList не найден в fallback');
                return;
            }

            container.innerHTML = achievements.map(achievement => {
                const isCompleted = achievement.progress >= achievement.maxProgress;
                const progressPercent = (achievement.progress / achievement.maxProgress) * 100;

                return `
                    <div class="achievement-item ${isCompleted ? 'completed' : ''}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-title">${achievement.title}</div>
                            <div class="achievement-description">${achievement.description}</div>
                            <div class="achievement-progress">
                                <div class="achievement-progress-bar" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; opacity: 0.8;">${achievement.progress}/${achievement.maxProgress}</div>
                            <div style="font-size: 14px; font-weight: bold; color: #FFD700;">${achievement.reward} NDN</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =============== НОВЫЕ ФУНКЦИИ ===============

        // Фильтрация достижений по категории
        let currentAchievementsFilter = 'all';
        let allAchievements = [];

        function filterAchievements(category) {
            currentAchievementsFilter = category;
            
            // Обновить кнопки фильтров
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const container = document.getElementById('achievementsList');
            if (!allAchievements.length) return;

            const filtered = category === 'all' 
                ? allAchievements 
                : allAchievements.filter(a => a.category === category);

            container.innerHTML = filtered.map(achievement => {
                const isCompleted = achievement.completed || false;
                const progress = achievement.progress || 0;
                const maxProgress = achievement.max_progress || 1;
                const progressPercent = Math.min(100, (progress / maxProgress) * 100);

                return `
                    <div class="achievement-item ${isCompleted ? 'completed' : ''}">
                        <div class="achievement-icon">${achievement.icon || '🏆'}</div>
                        <div class="achievement-info">
                            <div class="achievement-title">${achievement.title || 'Достижение'}</div>
                            <div class="achievement-description">${achievement.description || ''}</div>
                            <div class="achievement-progress">
                                <div class="achievement-progress-bar" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; opacity: 0.8;">${progress}/${maxProgress}</div>
                            <div style="font-size: 14px; font-weight: bold; color: #FFD700;">${achievement.reward || 0} NDN</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Загрузка ежедневных и недельных квестов
        async function loadQuests() {
            console.log('🎯 Загружаем квесты...');

            try {
                // Загружаем ежедневные квесты
                const dailyResponse = await fetch('/api/game/daily-quests', {
                    headers: { 'Authorization': `tma ${tg.initData || ''}` }
                });
                const dailyResult = await dailyResponse.json();

                if (dailyResult.success) {
                    displayQuests('dailyQuestsList', dailyResult.quests, 'daily');
                }

                // Загружаем недельные квесты
                const weeklyResponse = await fetch('/api/game/weekly-quests', {
                    headers: { 'Authorization': `tma ${tg.initData || ''}` }
                });
                const weeklyResult = await weeklyResponse.json();

                if (weeklyResult.success) {
                    displayQuests('weeklyQuestsList', weeklyResult.quests, 'weekly');
                }
            } catch (error) {
                console.error('❌ Error loading quests:', error);
            }
        }

        function displayQuests(containerId, quests, type) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = quests.map(quest => {
                const progress = quest.progress || 0;
                const target = quest.target || 1;
                const progressPercent = Math.min(100, (progress / target) * 100);
                const completed = quest.completed || progress >= target;

                return `
                    <div class="quest-item ${completed ? 'completed' : ''}">
                        <div class="quest-info">
                            <div class="quest-title">${quest.title}</div>
                            <div class="quest-description">${quest.description}</div>
                            <div class="quest-progress-bar">
                                <div class="quest-progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="quest-progress">${progress}/${target}</div>
                        </div>
                        <div class="quest-reward">
                            <div class="quest-reward-label">Награда</div>
                            <div class="quest-reward-value">${quest.reward} NDN</div>
                        </div>
                        ${completed ? 
                            `<button class="quest-claim-button" onclick="claimQuest('${quest.id}', '${type}')">
                                Получить
                            </button>` : 
                            `<button class="quest-claim-button" disabled>В процессе</button>`
                        }
                    </div>
                `;
            }).join('');
        }

        async function claimQuest(questId, type) {
            try {
                const response = await fetch('/api/game/claim-quest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `tma ${tg.initData || ''}`
                    },
                    body: JSON.stringify({
                        telegram_id: userData?.telegram_id,
                        quest_id: questId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`✅ Квест выполнен! Получено ${result.reward} NDN`, 'success');
                    loadQuests(); // Перезагрузить квесты
                    loadGameData(); // Обновить баланс
                } else {
                    showNotification('❌ Ошибка при получении награды', 'error');
                }
            } catch (error) {
                console.error('Error claiming quest:', error);
                showNotification('❌ Ошибка сети', 'error');
            }
        }

        // Колесо фортуны
        let isSpinning = false;
        let lastSpinTime = localStorage.getItem('lastSpinTime') || 0;

        async function spinWheel() {
            if (isSpinning) return;

            const now = Date.now();
            const cooldown = 24 * 60 * 60 * 1000; // 24 часа
            const timeSinceLastSpin = now - parseInt(lastSpinTime);

            if (timeSinceLastSpin < cooldown) {
                const remaining = cooldown - timeSinceLastSpin;
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                showNotification(`⏰ Следующее вращение через ${hours}ч ${minutes}м`, 'info');
                return;
            }

            isSpinning = true;
            const button = document.getElementById('spinButton');
            button.disabled = true;

            try {
                const response = await fetch('/api/game/spin-wheel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `tma ${tg.initData || ''}`
                    },
                    body: JSON.stringify({
                        telegram_id: userData?.telegram_id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const wheel = document.getElementById('fortuneWheel');
                    const prizes = [
                        { reward: 1, rotation: 0 },
                        { reward: 2, rotation: 60 },
                        { reward: 3, rotation: 120 },
                        { reward: 5, rotation: 180 },
                        { reward: 10, rotation: 240 },
                        { reward: 20, rotation: 300 }
                    ];

                    const wonPrize = prizes.find(p => p.reward === result.prize.reward) || prizes[0];
                    const spinRotation = 1800 + wonPrize.rotation; // 5 полных оборотов + позиция приза

                    wheel.style.transform = `rotate(${spinRotation}deg)`;

                    setTimeout(() => {
                        showNotification(result.message, 'success');
                        localStorage.setItem('lastSpinTime', now.toString());
                        lastSpinTime = now;
                        updateSpinCooldown();
                        loadGameData();
                        isSpinning = false;
                        button.disabled = false;
                    }, 3000);
                } else {
                    showNotification('❌ Ошибка при вращении колеса', 'error');
                    isSpinning = false;
                    button.disabled = false;
                }
            } catch (error) {
                console.error('Error spinning wheel:', error);
                showNotification('❌ Ошибка сети', 'error');
                isSpinning = false;
                button.disabled = false;
            }
        }

        function updateSpinCooldown() {
            const now = Date.now();
            const cooldown = 24 * 60 * 60 * 1000;
            const timeSinceLastSpin = now - parseInt(lastSpinTime);
            const remaining = cooldown - timeSinceLastSpin;

            const cooldownEl = document.getElementById('spinCooldown');
            if (!cooldownEl) return;

            if (remaining <= 0) {
                cooldownEl.textContent = '✅ Доступно!';
                document.getElementById('spinButton').disabled = false;
            } else {
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                cooldownEl.textContent = `⏰ Следующее вращение через: ${hours}ч ${minutes}м ${seconds}с`;
                document.getElementById('spinButton').disabled = true;
            }
        }

        // Обновлять каждую секунду
        setInterval(updateSpinCooldown, 1000);

        // Загрузка ранга игрока
        async function loadPlayerRank() {
            try {
                const response = await fetch('/api/game/ranks', {
                    headers: { 'Authorization': `tma ${tg.initData || ''}` }
                });
                const result = await response.json();

                if (result.success) {
                    const ranks = result.ranks;
                    const playerLevel = gameData.level || 1;

                    // Найти текущий ранг
                    let currentRank = ranks[0];
                    for (let i = ranks.length - 1; i >= 0; i--) {
                        if (playerLevel >= ranks[i].level) {
                            currentRank = ranks[i];
                            break;
                        }
                    }

                    // Найти следующий ранг
                    const nextRank = ranks.find(r => r.level > playerLevel);

                    // Обновить UI
                    const rankIcon = currentRank.title.match(/[\u{1F300}-\u{1F9FF}]/u)?.[0] || '🌱';
                    const rankName = currentRank.title.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();

                    document.getElementById('rankIcon').textContent = rankIcon;
                    document.getElementById('rankTitle').textContent = rankName;
                    document.getElementById('rankBonus').textContent = currentRank.description;

                    if (nextRank) {
                        document.getElementById('nextRankInfo').style.display = 'block';
                        document.getElementById('nextRankName').textContent = nextRank.title;
                        document.getElementById('nextRankInfo').querySelector('strong:last-child').textContent = nextRank.level;
                    } else {
                        document.getElementById('nextRankInfo').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading player rank:', error);
            }
        }

        // Загрузка бустов
        async function loadBoosts() {
            console.log('🚀 Загружаем бусты...');

            try {
                const response = await fetch('/api/game/boosts', {
                    headers: { 'Authorization': `tma ${tg.initData || ''}` }
                });
                const result = await response.json();

                if (result.success) {
                    displayBoosts(result.boosts);
                }
            } catch (error) {
                console.error('❌ Error loading boosts:', error);
            }
        }

        function displayBoosts(boosts) {
            const container = document.getElementById('boostsGrid');
            if (!container) return;

            container.innerHTML = boosts.map(boost => {
                const durationMin = Math.floor(boost.duration / 60000);
                
                return `
                    <div class="boost-item">
                        <span class="boost-icon">${boost.icon}</span>
                        <div class="boost-name">${boost.name}</div>
                        <div class="boost-description">${boost.description}</div>
                        <div class="boost-cost">${boost.cost} Gas</div>
                        <div class="boost-duration">⏱️ ${durationMin} мин</div>
                        <button class="boost-buy-button" onclick="buyBoost('${boost.id}', ${boost.cost})">
                            Купить
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function buyBoost(boostId, cost) {
            const gasBalance = minerData.gas || 0;

            if (gasBalance < cost) {
                showNotification(`❌ Недостаточно Gas! Нужно ${cost}, у вас ${gasBalance}`, 'error');
                return;
            }

            try {
                const response = await fetch('/api/game/buy-boost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `tma ${tg.initData || ''}`
                    },
                    body: JSON.stringify({
                        telegram_id: userData?.telegram_id,
                        boost_id: boostId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`✅ Буст активирован!`, 'success');
                    // TODO: Обновить UI с активными бустами
                    loadMinerData();
                } else {
                    showNotification('❌ Ошибка при покупке буста', 'error');
                }
            } catch (error) {
                console.error('Error buying boost:', error);
                showNotification('❌ Ошибка сети', 'error');
            }
        }

        function loadPlayerLevel() {
            const xpForNextLevel = gameData.level * 100;
            const currentLevelXP = (gameData.level - 1) * 100;
            const progress = ((gameData.xp - currentLevelXP) / (xpForNextLevel - currentLevelXP)) * 100;

            // Проверяем существование элементов перед обновлением
            const playerLevelElement = document.getElementById('playerLevel');
            const currentXPElement = document.getElementById('currentXP');
            const nextLevelXPElement = document.getElementById('nextLevelXP');
            const levelProgressElement = document.getElementById('levelProgress');

            if (playerLevelElement) {
                playerLevelElement.textContent = gameData.level;
            } else {
                console.warn('Элемент playerLevel не найден');
            }

            if (currentXPElement) {
                currentXPElement.textContent = gameData.xp;
            } else {
                console.warn('Элемент currentXP не найден');
            }

            if (nextLevelXPElement) {
                nextLevelXPElement.textContent = xpForNextLevel;
            } else {
                console.warn('Элемент nextLevelXP не найден');
            }

            if (levelProgressElement) {
                levelProgressElement.style.width = `${Math.min(progress, 100)}%`;
            } else {
                console.warn('Элемент levelProgress не найден');
            }

            // Проверяем повышение уровня
            if (gameData.xp >= xpForNextLevel) {
                gameData.level++;
                showNotification(`Поздравляем! Вы достигли ${gameData.level} уровня!`, 'success');
                playSound('levelup');
            }
        }

        function loadGameStats() {
            // Проверяем существование элементов перед обновлением
            const daysPlayedElement = document.getElementById('daysPlayed');
            const achievementsCountElement = document.getElementById('achievementsCount');
            const totalEarnedElement = document.getElementById('totalEarned');
            const totalReferralsElement = document.getElementById('totalReferrals');

            if (daysPlayedElement) {
                daysPlayedElement.textContent = gameData.stats.daysPlayed;
            } else {
                console.warn('Элемент daysPlayed не найден');
            }

            if (achievementsCountElement) {
                achievementsCountElement.textContent = gameData.achievements.length;
            } else {
                console.warn('Элемент achievementsCount не найден');
            }

            if (totalEarnedElement) {
                totalEarnedElement.textContent = gameData.stats.totalEarned;
            } else {
                console.warn('Элемент totalEarned не найден');
            }

            if (totalReferralsElement) {
                totalReferralsElement.textContent = gameData.stats.totalReferrals;
            } else {
                console.warn('Элемент totalReferrals не найден');
            }
        }

        function updateGameData() {
            // Обновляем статистику на основе данных пользователя
            if (userData) {
                gameData.stats.totalEarned = userData.balance_ndn || 0;
                gameData.stats.totalReferrals = userData.total_referrals || 0;
                
                // Увеличиваем счетчик дней в игре
                const lastLogin = localStorage.getItem('lastLogin');
                const today = new Date().toDateString();
                if (lastLogin !== today) {
                    gameData.stats.daysPlayed++;
                    localStorage.setItem('lastLogin', today);
                }
                
                // Загружаем сохраненные игровые данные
                const savedGameData = localStorage.getItem('nodeon_game_data');
                if (savedGameData) {
                    try {
                        const parsed = JSON.parse(savedGameData);
                        gameData = { ...gameData, ...parsed };
                    } catch (e) {
                        console.warn('Ошибка загрузки игровых данных:', e);
                    }
                }
                
                // Проверяем сброс ежедневных наград (новая неделя)
                checkWeeklyReset();
                
                // Загружаем сохраненные ежедневные награды
                loadDailyRewardsFromStorage();
                
                // Обновляем достижения
                loadAchievements();
                loadPlayerLevel();
                loadGameStats();
                
                // Проверяем напоминания
                checkReminders();
                
                // Сохраняем игровые данные
                localStorage.setItem('nodeon_game_data', JSON.stringify(gameData));
            }
        }

        function checkWeeklyReset() {
            const lastReset = localStorage.getItem('lastWeeklyReset');
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            const weekStartString = weekStart.toDateString();
            
            if (lastReset !== weekStartString) {
                // Новая неделя - сбрасываем ежедневные награды
                gameData.dailyRewards = [];
                localStorage.setItem('lastWeeklyReset', weekStartString);
                localStorage.setItem('nodeon_daily_rewards', JSON.stringify([]));
                console.log('🔄 Ежедневные награды сброшены - новая неделя');
            }
        }

        function loadDailyRewardsFromStorage() {
            try {
                const savedRewards = localStorage.getItem('nodeon_daily_rewards');
                if (savedRewards) {
                    const parsed = JSON.parse(savedRewards);
                    if (Array.isArray(parsed)) {
                        gameData.dailyRewards = parsed;
                        console.log('📦 Загружены сохраненные награды:', parsed);
                    }
                }
            } catch (e) {
                console.warn('Ошибка загрузки сохраненных наград:', e);
                gameData.dailyRewards = [];
            }
        }

        function saveDailyRewardsToStorage() {
            try {
                localStorage.setItem('nodeon_daily_rewards', JSON.stringify(gameData.dailyRewards));
                console.log('💾 Награды сохранены:', gameData.dailyRewards);
            } catch (e) {
                console.warn('Ошибка сохранения наград:', e);
            }
        }

        function initializeGameData() {
            console.log('🎮 Инициализируем игровые данные...');
            
            // Загружаем сохраненные награды
            loadDailyRewardsFromStorage();
            
            // Проверяем сброс недели
            checkWeeklyReset();
            
            console.log('📊 Текущие награды:', gameData.dailyRewards);
        }
        // NDN Miner функции
        async function initializeMinerData() {
            console.log('⛏️ Инициализируем данные майнера...');
            
            // Проверяем, что userData загружен
            if (!userData || !userData.telegram_id) {
                console.error('❌ Данные пользователя не загружены!');
                showNotification('Данные пользователя не загружены. Перезагрузите страницу.', 'error');
                return;
            }
            
            // Проверяем, что вкладка майнера существует
            const minerTab = document.getElementById('minerTab');
            if (!minerTab) {
                console.error('❌ Вкладка майнера не найдена!');
                return;
            }
            
            // Инициализируем minerData если он пустой
            if (!minerData || Object.keys(minerData).length === 0) {
                console.log('📊 Инициализируем пустые данные майнера...');
                minerData = {};
            }
            
            // Проверяем состояние таблиц БД
            try {
                const tablesResponse = await fetch('/api/miner/check-tables');
                if (!tablesResponse.ok) {
                    console.warn('⚠️ Не удалось проверить таблицы, продолжаем без проверки');
                } else {
                    const tablesResult = await tablesResponse.json();
                    console.log('📊 Состояние таблиц БД:', tablesResult);
                    
                    if (!tablesResult.success) {
                        console.warn('⚠️ Предупреждение проверки таблиц БД:', tablesResult.error);
                    }
                    
                    if (tablesResult.tables && !tablesResult.tables.nodeon_miner_data) {
                        console.warn('⚠️ Таблица nodeon_miner_data не существует, будет создана при первом сохранении');
                    }
                }
            } catch (error) {
                console.warn('⚠️ Ошибка проверки таблиц (не критично):', error);
                // Продолжаем работу, даже если проверка не удалась
            }
            
            // Валидация времени: проверяем, что время системы не было изменено
            const currentTime = Date.now();
            const lastKnownTime = parseInt(localStorage.getItem('last_known_time') || currentTime.toString());
            const timeDiff = Math.abs(currentTime - lastKnownTime);
            
            // Если разница больше 1 часа, подозреваем читерство
            if (timeDiff > 60 * 60 * 1000) {
                console.warn('⚠️ Подозрительное изменение времени системы');
                showNotification('Обнаружено изменение времени системы. Данные могут быть сброшены.', 'warning');
            }
            
            // Сохраняем текущее время
            localStorage.setItem('last_known_time', currentTime.toString());
            
            try {
                // Получаем данные с сервера (приоритет серверных данных)
                console.log('📡 Загружаем данные с сервера...');
                const response = await fetch(`/api/miner/data/${userData.telegram_id}`);
                const result = await response.json();
                
                if (result.success && result.miner_data) {
                    // Серверные данные имеют приоритет - они содержат расчет оффлайн заработка
                    minerData = result.miner_data;
                    console.log('📡 Данные майнера загружены с сервера (с оффлайн расчетом):', minerData);
                    
                    // Сохраняем обновленные данные локально
                    saveMinerData();
                } else {
                    console.error('❌ Ошибка загрузки данных майнера с сервера:', result.error);
                    // Fallback на локальные данные
                    const savedMinerData = localStorage.getItem('nodeon_miner_data');
                    if (savedMinerData) {
                        try {
                            const parsed = JSON.parse(savedMinerData);
                            minerData = parsed;
                            console.log('💾 Fallback на локальные данные:', minerData);
                        } catch (e) {
                            console.warn('Ошибка загрузки локальных данных майнера:', e);
                            // Если и локальные данные не загрузились, используем дефолтные
                            minerData = {
                                ndnGas: 100,
                                energy: 100,
                                maxEnergy: 100,
                                gasPerMinute: 0,
                                farms: [],
                                upgrades: {
                                    speed: 0,
                                    efficiency: 0,
                                    automation: 0
                                },
                                totalGasEarned: 100,
                                lastEnergyRefill: Date.now(),
                                lastUpdate: Date.now(),
                                energyRefillCooldown: 3 * 60 * 60 * 1000
                            };
                        }
                    } else {
                        // Если нет локальных данных, используем дефолтные
                        minerData = {
                            ndnGas: 100,
                            energy: 100,
                            maxEnergy: 100,
                            gasPerMinute: 0,
                            farms: [],
                            upgrades: {
                                speed: 0,
                                efficiency: 0,
                                automation: 0
                            },
                            totalGasEarned: 100,
                            lastEnergyRefill: Date.now(),
                            lastUpdate: Date.now(),
                            energyRefillCooldown: 3 * 60 * 60 * 1000
                        };
                    }
                }
            } catch (error) {
                console.error('❌ Ошибка подключения к серверу:', error);
                // Fallback на локальные данные
                const savedMinerData = localStorage.getItem('nodeon_miner_data');
                if (savedMinerData) {
                    try {
                        const parsed = JSON.parse(savedMinerData);
                        minerData = parsed;
                        console.log('💾 Fallback на локальные данные:', minerData);
                    } catch (e) {
                        console.warn('Ошибка загрузки локальных данных майнера:', e);
                        // Если и локальные данные не загрузились, используем дефолтные
                        minerData = {
                            ndnGas: 100,
                            energy: 100,
                            maxEnergy: 100,
                            gasPerMinute: 0,
                            farms: [],
                            upgrades: {
                                speed: 0,
                                efficiency: 0,
                                automation: 0
                            },
                            totalGasEarned: 100,
                            lastEnergyRefill: Date.now(),
                            lastUpdate: Date.now(),
                            energyRefillCooldown: 3 * 60 * 60 * 1000
                        };
                    }
                } else {
                    // Если нет локальных данных, используем дефолтные
                    minerData = {
                        ndnGas: 100,
                        energy: 100,
                        maxEnergy: 100,
                        gasPerMinute: 0,
                        farms: [],
                        upgrades: {
                            speed: 0,
                            efficiency: 0,
                            automation: 0
                        },
                        totalGasEarned: 100,
                        lastEnergyRefill: Date.now(),
                        lastUpdate: Date.now(),
                        energyRefillCooldown: 3 * 60 * 60 * 1000
                    };
                }
            }
            
            // Обновляем UI майнера
            updateMinerUI();
            loadFarms();
            loadUpgrades('speed');
            loadShop();
            loadLeaderboard();
            
            // Запускаем основной цикл майнинга
            startMiningLoop();
            
            // Запускаем таймер пополнения энергии
            startEnergyRefillTimer();
            
            // Обновляем кнопку пополнения энергии
            console.log('🔋 Обновляем кнопку энергии, minerData:', minerData);
            updateEnergyRefillButton();
            
            console.log('📊 Данные майнера загружены:', minerData);
        }

        function updateMinerUI() {
            console.log('🔄 Обновляем UI майнера...');
            console.log('📊 Текущие данные майнера:', minerData);
            
            // Проверяем, что данные майнера загружены
            if (!minerData) {
                console.warn('⚠️ Данные майнера не загружены, пропускаем обновление UI');
                return;
            }
            
            // Инициализируем базовые поля если не существуют
            if (minerData.ndnGas === undefined) minerData.ndnGas = 100;
            if (minerData.energy === undefined) minerData.energy = 100;
            if (minerData.maxEnergy === undefined) minerData.maxEnergy = 100;
            if (minerData.gasPerMinute === undefined) minerData.gasPerMinute = 0;
            if (minerData.farms === undefined) minerData.farms = [];
            if (minerData.upgrades === undefined) minerData.upgrades = { speed: 0, efficiency: 0, automation: 0 };
            
            // Обновляем статистику
            const gasBalance = document.getElementById('ndnGasBalance');
            const energyLevel = document.getElementById('energyLevel');
            const gasPerSecond = document.getElementById('gasPerSecond');
            
            console.log('Элементы майнера:', {
                gasBalance: !!gasBalance,
                energyLevel: !!energyLevel,
                gasPerSecond: !!gasPerSecond
            });
            
            if (gasBalance) {
                const gasValue = minerData.ndnGas || 0;
                gasBalance.textContent = Math.floor(gasValue).toLocaleString();
                console.log('✅ Gas баланс обновлен:', gasBalance.textContent, 'из данных:', gasValue);
            } else {
                console.error('❌ Элемент ndnGasBalance не найден!');
            }
            
            if (energyLevel) {
                energyLevel.textContent = `${Math.floor(minerData.energy || 0)}/${minerData.maxEnergy || 100}`;
                console.log('✅ Энергия обновлена:', energyLevel.textContent);
            } else {
                console.error('❌ Элемент energyLevel не найден!');
            }
            
            if (gasPerSecond) {
                gasPerSecond.textContent = (minerData.gasPerMinute || 0).toFixed(1);
                console.log('✅ Gas/мин обновлен:', gasPerSecond.textContent);
            } else {
                console.error('❌ Элемент gasPerSecond не найден!');
            }
            
            // Обновляем время до следующего события
            updateNextEventTime();
        }
        
        function updateNextEventTime() {
            const nextEventElement = document.getElementById('nextEventTime');
            if (!nextEventElement) return;
            
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            const timeUntilNextEvent = oneDay - (now - lastEventTime);
            
            if (timeUntilNextEvent <= 0) {
                nextEventElement.textContent = 'Готово!';
                return;
            }
            
            const hours = Math.floor(timeUntilNextEvent / (1000 * 60 * 60));
            const minutes = Math.floor((timeUntilNextEvent % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeUntilNextEvent % (1000 * 60)) / 1000);
            
            nextEventElement.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function loadFarms() {
            const container = document.getElementById('farmsGrid');
            if (!container) {
                console.error('❌ Контейнер farmsGrid не найден');
                return;
            }
            
            // Проверяем, что данные майнера загружены
            if (!minerData) {
                console.warn('⚠️ Данные майнера не загружены, пропускаем загрузку ферм');
                return;
            }
            
            // Инициализируем farms если не существует
            if (!minerData.farms) {
                minerData.farms = [];
                console.log('📊 Инициализирован массив ферм');
            }
            
            console.log('🔄 Загружаем фермы:', {
                gas: minerData.ndnGas,
                farms: minerData.farms.length,
                level: gameData?.level || 1
            });
            
            container.innerHTML = farmTypes.map(farm => {
                const farmCount = minerData.farms.filter(f => f.type === farm.id).length;
                const canAfford = (minerData.ndnGas || 0) >= farm.baseCost;
                // Разблокировка основана на количестве уже купленных ферм
                const totalFarms = minerData.farms ? minerData.farms.length : 0;
                const canUnlock = totalFarms >= (farm.unlockLevel || 0);
                
                return `
                    <div class="farm-item ${!canUnlock ? 'locked' : ''}" data-farm-id="${farm.id}">
                        <div class="farm-icon">${farm.icon}</div>
                        <div class="farm-name" data-i18n="miner.farms.${farm.id}">${farm.name}</div>
                        <div class="farm-description" data-i18n="miner.farms.${farm.id}_desc">${farm.description}</div>
                        <div class="farm-stats">
                            <span>${t('miner.farms.gas_per_min')}</span>: ${farm.baseGasPerMinute}
                            <span>${t('miner.farms.energy_cost')}</span>: ${farm.energyCost}
                        </div>
                        <div class="farm-stats">
                            <span>${t('miner.farms.quantity')}</span>: ${farmCount}
                            <span>${t('miner.farms.cost')}</span>: ${farm.baseCost} ${t('miner.stats.ndn_gas')}
                        </div>
                        <button class="farm-button" 
                                onclick="buyFarm('${farm.id}')" 
                                ${!canAfford || !canUnlock ? 'disabled' : ''}>
                            ${!canUnlock ? t('miner.farms.locked') : canAfford ? t('miner.farms.buy') : t('miner.farms.not_enough_gas')}
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function buyFarm(farmId) {
            console.log('🛒 Попытка покупки фермы:', farmId);
            
            // Проверяем, что userData загружен
            if (!userData || !userData.telegram_id) {
                console.error('❌ Данные пользователя не загружены');
                showNotification('Данные пользователя не загружены. Перезагрузите страницу.', 'error');
                return;
            }
            
            // Проверяем, что данные майнера загружены
            if (!minerData) {
                console.error('❌ Данные майнера не загружены');
                showNotification(t('miner.error.data_not_loaded') || 'Данные майнера не загружены!', 'error');
                return;
            }
            
            // Инициализируем базовые поля если не существуют
            if (minerData.ndnGas === undefined) minerData.ndnGas = 100;
            if (minerData.farms === undefined) minerData.farms = [];
            
            const farm = farmTypes.find(f => f.id === farmId);
            if (!farm) {
                console.error('❌ Ферма не найдена:', farmId);
                return;
            }
            
            const currentGas = minerData.ndnGas || 0;
            console.log('💰 Текущий Gas:', currentGas, 'Стоимость фермы:', farm.baseCost);
            
            if (currentGas < farm.baseCost) {
                showNotification(`${t('miner.farms.not_enough_gas')}! Нужно: ${farm.baseCost}, есть: ${Math.floor(currentGas)}`, 'error');
                return;
            }
            
            try {
                console.log('📡 Отправляем запрос на сервер...');
                console.log('👤 User ID:', userData.telegram_id);
                console.log('🏭 Farm Type:', farmId);
                console.log('💰 Текущий Gas:', currentGas);
                console.log('💵 Стоимость фермы:', farm.baseCost);
                
                // Отправляем запрос на сервер
                const response = await fetch('/api/miner/buy-farm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: userData.telegram_id,
                        farm_type: farmId
                    })
                });
                
                console.log('📡 Ответ сервера:', response.status, response.statusText);
                
                if (!response.ok) {
                    console.error('❌ Ошибка HTTP:', response.status, response.statusText);
                    showNotification(`Ошибка сервера: ${response.status}`, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('📊 Результат:', result);
                
                if (result.success) {
                    // Обновляем локальные данные данными с сервера
                    minerData = result.miner_data;
                    console.log('📊 Данные майнера обновлены после покупки:', minerData);
                    
                    // Обновляем баланс пользователя если вернулся с сервера
                    if (result.user && result.user.balance_ndn !== undefined) {
                        userData.balance_ndn = result.user.balance_ndn;
                        console.log('💰 Баланс NDN обновлен:', userData.balance_ndn);
                    }
                    
                    // Сохраняем локально
                    saveMinerData();
                    
                    // Сохраняем на сервере
                    await saveMinerDataToServer();
                    
                    // Пересчитываем общую генерацию
                    calculateGasPerMinute();
                    
                    // Обновляем UI (включая баланс NDN)
                    updateMinerUI();
                    updateUI(); // Обновляем основной UI с балансом NDN
                    loadFarms();
                    
                    // Проверяем достижения
                    checkAchievements();
                    
                    // Автоматически запускаем майнинг если есть энергия
                    if ((minerData.energy || 0) > 0 && (minerData.gasPerMinute || 0) > 0) {
                        startMiningLoop();
                        console.log('🚀 Майнинг автоматически запущен после покупки фермы!');
                    }
                    
                    // Показываем забавное сообщение
                    const funnyMessages = [
                        `🎉 ${t('miner.farms.purchased')}: ${farm.name}! Теперь у вас есть ${farm.icon}`,
                        `💪 ${farm.name} ${t('miner.farms.ready_to_work')}! ${farm.icon} будет добывать Gas!`,
                        `🚀 Новая ферма ${farm.name} ${t('miner.farms.launched')}! ${farm.icon} работает на полную мощность!`,
                        `⚡ ${farm.name} ${t('miner.farms.connected')}! ${farm.icon} начинает майнинг!`,
                        `🔥 Ферма ${farm.name} ${t('miner.farms.activated')}! ${farm.icon} готов к добыче!`,
                        `💎 ${farm.name} ${t('miner.farms.installed')}! ${farm.icon} будет приносить прибыль!`,
                        `🎯 Ферма ${farm.name} ${t('miner.farms.ready')}! ${farm.icon} начинает работу!`,
                        `🌟 ${farm.name} ${t('miner.farms.started')}! ${farm.icon} добывает Gas!`
                    ];
                    
                    const randomMessage = funnyMessages[Math.floor(Math.random() * funnyMessages.length)];
                    showNotification(randomMessage, 'success');
                    
                    // Добавляем анимацию к купленной ферме
                    const farmElement = document.querySelector(`[data-farm-id="${farmId}"]`);
                    if (farmElement) {
                        farmElement.classList.add('purchased');
                        setTimeout(() => {
                            farmElement.classList.remove('purchased');
                        }, 600);
                    }
                } else {
                    showNotification(`Ошибка: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('❌ Ошибка покупки фермы:', error);
                showNotification('Ошибка подключения к серверу', 'error');
            }
        }

        function calculateGasPerMinute() {
            // Проверяем, что данные майнера загружены
            if (!minerData) {
                console.warn('⚠️ Данные майнера не загружены для расчета');
                return;
            }
            
            // Инициализируем farms если не существует
            if (!minerData.farms) {
                minerData.farms = [];
                console.log('📊 Инициализирован массив ферм для расчета');
            }
            
            let totalGas = 0;
            let totalEnergy = 0;
            
            console.log('🔄 Пересчитываем генерацию Gas...');
            console.log('Фермы:', minerData.farms);
            console.log('Улучшения:', minerData.upgrades);
            console.log('Активные бусты:', activeBoosts);
            console.log('Особые майнеры:', activeSpecialMiners);
            
            // Обычные фермы
            minerData.farms.forEach(farm => {
                const farmType = farmTypes.find(f => f.id === farm.type);
                if (farmType) {
                    const speedMultiplier = 1 + (minerData.upgrades.speed || 0) * 0.1;
                    const efficiencyMultiplier = 1 - (minerData.upgrades.efficiency || 0) * 0.2;
                    
                    totalGas += farmType.baseGasPerMinute * speedMultiplier;
                    totalEnergy += farmType.energyCost * efficiencyMultiplier;
                    
                    console.log(`Ферма ${farm.type}: ${farmType.baseGasPerMinute} * ${speedMultiplier} = ${farmType.baseGasPerMinute * speedMultiplier} Gas/мин`);
                }
            });
            
            // Особые майнеры
            activeSpecialMiners.forEach(miner => {
                totalGas += miner.gasPerMinute;
                totalEnergy += miner.energyCost;
                console.log(`Особый майнер ${miner.name}: ${miner.gasPerMinute} Gas/мин`);
            });
            
            // Применяем эффекты бустов
            let boostMultiplier = 1;
            activeBoosts.forEach(boost => {
                switch (boost.effect) {
                    case 'gas_multiplier':
                        boostMultiplier *= boost.value;
                        break;
                    case 'mining_speed':
                        boostMultiplier *= boost.value;
                        break;
                }
            });
            
            totalGas *= boostMultiplier;
            
            // Применяем эффекты бустов к энергии
            let energyMultiplier = 1;
            activeBoosts.forEach(boost => {
                if (boost.effect === 'energy_efficiency') {
                    energyMultiplier *= boost.value;
                }
            });
            
            totalEnergy *= energyMultiplier;
            
            // Обновляем общую генерацию в минуту
            minerData.gasPerMinute = totalGas;
            
            // Проверяем энергию - если она закончилась, майнеры не работают
            if ((minerData.energy || 0) <= 0) {
                minerData.gasPerMinute = 0; // Останавливаем майнинг при нулевой энергии
                console.log('⚠️ Энергия закончилась! Майнеры остановлены.');
                console.log(`Потребление: ${totalEnergy}/мин, Доступно: ${minerData.energy}`);
            } else {
                console.log(`✅ Майнинг активен: ${totalGas} Gas/мин, потребление энергии: ${totalEnergy}/мин`);
            }
            
            console.log('📊 Итоговая генерация:', minerData.gasPerMinute, 'Gas/мин');
            
            // Обновляем UI после пересчета
            updateMinerUI();
        }

        function startMiningLoop() {
            // Проверяем, что данные майнера загружены
            if (!minerData) {
                console.warn('⚠️ Данные майнера не загружены, майнинг не запущен');
                return;
            }
            
            // Пересчитываем генерацию перед запуском
            calculateGasPerMinute();
            
            console.log('🚀 Запускаем цикл майнинга...');
            console.log('Начальная генерация:', minerData.gasPerMinute, 'Gas/мин');
            
            let lastSaveTime = Date.now();
            let lastGasAmount = minerData.ndnGas || 100;
            
            setInterval(() => {
                // Проверяем случайные события
                checkRandomEvents();
                
                if (minerData.gasPerMinute > 0) {
                    // Зарабатываем Gas каждые 100мс (10 раз в секунду)
                    let gasEarned = minerData.gasPerMinute / 600; // Gas/мин / 600 = Gas за 100мс
                    
                    // Применяем активные события
                    gasEarned = applyEventEffects(gasEarned);
                    
                    minerData.ndnGas = (minerData.ndnGas || 0) + gasEarned;
                    minerData.totalGasEarned = (minerData.totalGasEarned || 0) + gasEarned;
                    
                    // Потребляем энергию
                    let totalEnergyConsumption = 0;
                    if (minerData.farms) {
                        minerData.farms.forEach(farm => {
                            const farmType = farmTypes.find(f => f.id === farm.type);
                            if (farmType) {
                                const efficiencyMultiplier = 1 - (minerData.upgrades.efficiency || 0) * 0.2;
                                totalEnergyConsumption += farmType.energyCost * efficiencyMultiplier;
                            }
                        });
                    }
                    
                    // Применяем эффекты событий к потреблению энергии
                    totalEnergyConsumption = applyEnergyEffects(totalEnergyConsumption);
                    
                    // Потребляем энергию каждые 100мс
                    const energyConsumption = totalEnergyConsumption / 600; // Потребление в минуту / 600
                    minerData.energy = Math.max(0, (minerData.energy || 0) - energyConsumption);
                    
                    // Пересчитываем генерацию после потребления энергии
                    calculateGasPerMinute();
                    
                    updateMinerUI();
                    
                    // Проверяем достижения каждые 5 секунд
                    if (Date.now() % 5000 < 100) {
                        checkAchievements();
                    }
                    
                    // Сохраняем на сервер каждые 10 секунд или при значительном изменении Gas
                    const currentTime = Date.now();
                    const gasIncrease = (minerData.ndnGas || 0) - lastGasAmount;
                    
                    if (currentTime - lastSaveTime > 10000 || gasIncrease > 50) {
                        saveMinerDataToServer();
                        lastSaveTime = currentTime;
                        lastGasAmount = minerData.ndnGas || 0;
                    }
                }
            }, 100);
        }

        // Функции для случайных событий
        function checkRandomEvents() {
            const now = Date.now();
            
            // Проверяем, прошло ли 24 часа с последнего события
            const oneDay = 24 * 60 * 60 * 1000; // 24 часа в миллисекундах
            if (now - lastEventTime < oneDay) return;
            
            // 10% шанс на событие раз в сутки
            if (Math.random() < 0.1) {
                triggerRandomEvent();
                lastEventTime = now;
                localStorage.setItem('miner_last_event_time', now.toString());
                console.log('🎉 Случайное событие активировано! Следующее через 24 часа.');
            }
        }
        
        function triggerRandomEvent() {
            const event = funnyEvents[Math.floor(Math.random() * funnyEvents.length)];
            
            console.log('🎉 Случайное событие:', event.name);
            
            // Добавляем событие в активные
            const eventData = {
                ...event,
                startTime: Date.now(),
                id: event.id + '_' + Date.now()
            };
            
            activeEvents.push(eventData);
            
            // Показываем уведомление
            showFunnyNotification(event);
            
            // Применяем мгновенные эффекты
            if (event.effect === 'free_gas') {
                minerData.ndnGas = (minerData.ndnGas || 0) + 1000;
                minerData.totalGasEarned = (minerData.totalGasEarned || 0) + 1000;
                updateMinerUI();
            }
            
            // Удаляем событие через указанное время
            if (event.duration > 0) {
                setTimeout(() => {
                    removeEvent(eventData.id);
                }, event.duration);
            }
        }
        
        function applyEventEffects(gasEarned) {
            let multiplier = 1;
            
            activeEvents.forEach(event => {
                switch (event.effect) {
                    case 'speed_boost':
                        multiplier *= 2;
                        break;
                    case 'all_boost':
                        multiplier *= 3;
                        break;
                    case 'energy_drain':
                        // При забастовке майнеры не работают
                        multiplier *= 0;
                        break;
                }
            });
            
            return gasEarned * multiplier;
        }
        
        function applyEnergyEffects(energyConsumption) {
            let multiplier = 1;
            
            activeEvents.forEach(event => {
                switch (event.effect) {
                    case 'efficiency_boost':
                        multiplier *= 0.5;
                        break;
                    case 'energy_drain':
                        // При забастовке потребляют энергию, но не работают
                        multiplier *= 1.5;
                        break;
                }
            });
            
            return energyConsumption * multiplier;
        }
        
        function removeEvent(eventId) {
            const eventIndex = activeEvents.findIndex(e => e.id === eventId);
            if (eventIndex !== -1) {
                const event = activeEvents[eventIndex];
                activeEvents.splice(eventIndex, 1);
                console.log('⏰ Событие завершено:', event.name);
            }
        }
        
        function showFunnyNotification(event) {
            const notification = document.createElement('div');
            notification.className = 'funny-notification';
            notification.innerHTML = `
                <div class="funny-notification-content">
                    <div class="funny-icon">${event.icon}</div>
                    <div class="funny-text">
                        <div class="funny-title">${event.name}</div>
                        <div class="funny-description">${event.description}</div>
                        <div class="funny-message">${event.message}</div>
                    </div>
                </div>
            `;
            
            // Добавляем стили
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideInRight 0.5s ease-out;
                max-width: 300px;
                font-family: Arial, sans-serif;
            `;
            
            document.body.appendChild(notification);
            
            // Удаляем через 5 секунд
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 5000);
        }
        
        // Функции для достижений
        function checkAchievements() {
            if (!minerData || Object.keys(minerData).length === 0) return;
            
            secretAchievements.forEach(achievement => {
                if (!unlockedAchievements.includes(achievement.id) && achievement.condition(minerData)) {
                    unlockAchievement(achievement);
                }
            });
        }
        
        function unlockAchievement(achievement) {
            unlockedAchievements.push(achievement.id);
            localStorage.setItem('miner_achievements', JSON.stringify(unlockedAchievements));
            
            // Добавляем награду
            minerData.ndnGas = (minerData.ndnGas || 0) + achievement.reward;
            minerData.totalGasEarned = (minerData.totalGasEarned || 0) + achievement.reward;
            
            // Показываем уведомление о достижении
            showAchievementNotification(achievement);
            
            console.log('🏆 Достижение разблокировано:', achievement.name);
        }
        function showAchievementNotification(achievement) {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div class="achievement-content">
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-text">
                        <div class="achievement-title">🏆 ДОСТИЖЕНИЕ!</div>
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-description">${achievement.description}</div>
                        <div class="achievement-reward">+${achievement.reward} Gas!</div>
                    </div>
                </div>
            `;
            
            // Добавляем стили
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
                color: #333;
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                z-index: 10001;
                animation: slideInLeft 0.5s ease-out;
                max-width: 300px;
                font-family: Arial, sans-serif;
                border: 2px solid #ffd700;
            `;
            
            document.body.appendChild(notification);
            
            // Удаляем через 6 секунд
            setTimeout(() => {
                notification.style.animation = 'slideOutLeft 0.5s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 6000);
        }
        
        // Функции для новых систем
        function buyBoost(boostId) {
            const boost = boosts.find(b => b.id === boostId);
            if (!boost) return;
            
            if ((minerData.ndnGas || 0) < boost.cost) {
                showNotification(t('miner.farms.not_enough_gas'), 'error');
                return;
            }
            
            minerData.ndnGas -= boost.cost;
            activeBoosts.push({
                ...boost,
                startTime: Date.now(),
                id: boostId + '_' + Date.now()
            });
            
            // Удаляем буст через указанное время
            setTimeout(() => {
                removeBoost(boostId);
            }, boost.duration);
            
            updateMinerUI();
            loadBoosts();
            showNotification(`Активирован буст: ${boost.name}!`, 'success');
        }
        
        function removeBoost(boostId) {
            const index = activeBoosts.findIndex(b => b.id.startsWith(boostId));
            if (index !== -1) {
                activeBoosts.splice(index, 1);
                loadBoosts();
                showNotification(`Буст ${boostId} завершен`, 'info');
            }
        }
        
        function buySpecialMiner(minerId) {
            const miner = specialMiners.find(m => m.id === minerId);
            if (!miner) return;
            
            if ((minerData.ndnGas || 0) < miner.cost) {
                showNotification(t('miner.farms.not_enough_gas'), 'error');
                return;
            }
            
            // Показываем рекламу (заглушка)
            showAdForSpecialMiner(miner);
        }
        
        function showAdForSpecialMiner(miner) {
            // Заглушка для рекламы Yandex Ads
            const adModal = document.createElement('div');
            adModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            adModal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 400px;">
                    <h3>📺 Реклама</h3>
                    <p>Смотрите рекламу для получения ${miner.name}</p>
                    <div style="background: #f0f0f0; padding: 20px; margin: 10px 0; border-radius: 5px;">
                        <p>Здесь будет реклама Yandex Ads</p>
                        <p>⏱️ 5 секунд...</p>
                    </div>
                    <button onclick="completeAd('${miner.id}')" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        Получить майнер
                    </button>
                </div>
            `;
            
            document.body.appendChild(adModal);
        }
        
        function completeAd(minerId) {
            const miner = specialMiners.find(m => m.id === minerId);
            if (!miner) return;
            
            // Убираем модальное окно
            document.querySelector('div[style*="position: fixed"]').remove();
            
            // Списываем Gas
            minerData.ndnGas -= miner.cost;
            
            // Добавляем особый майнер
            activeSpecialMiners.push({
                ...miner,
                startTime: Date.now(),
                id: minerId + '_' + Date.now()
            });
            
            // Удаляем майнер через 24 часа
            setTimeout(() => {
                removeSpecialMiner(minerId);
            }, miner.duration);
            
            updateMinerUI();
            loadSpecialMiners();
            showNotification(`${t('miner.special.received') || 'Получен особый майнер'}: ${miner.name}!`, 'success');
        }
        
        function removeSpecialMiner(minerId) {
            const index = activeSpecialMiners.findIndex(m => m.id.startsWith(minerId));
            if (index !== -1) {
                activeSpecialMiners.splice(index, 1);
                loadSpecialMiners();
                showNotification(`${t('miner.special.completed') || 'Особый майнер'} ${minerId} ${t('miner.special.finished') || 'завершен'}`, 'info');
            }
        }
        
        function completeQuest(questId) {
            const quest = quests.find(q => q.id === questId);
            if (!quest) return;
            
            if (!quest.condition(minerData)) {
                showNotification('Квест еще не выполнен!', 'error');
                return;
            }
            
            // Добавляем награду
            minerData.ndnGas += quest.reward.gas;
            minerData.totalGasEarned += quest.reward.gas;
            
            // Отмечаем квест как выполненный
            completedQuests.push(questId);
            localStorage.setItem('miner_completed_quests', JSON.stringify(completedQuests));
            
            updateMinerUI();
            loadQuests();
            showNotification(`${t('miner.quests.completed') || 'Квест выполнен'}: ${quest.name}! +${quest.reward.gas} ${t('miner.stats.ndn_gas')}`, 'success');
        }
        
        // Добавляем анимации для достижений
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInLeft {
                from {
                    transform: translateX(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutLeft {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(-100%);
                    opacity: 0;
                }
            }
            
            .achievement-content {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .achievement-icon {
                font-size: 24px;
                animation: bounce 1s infinite;
            }
            
            .achievement-text {
                flex: 1;
            }
            
            .achievement-title {
                font-weight: bold;
                font-size: 12px;
                color: #b8860b;
                margin-bottom: 2px;
            }
            
            .achievement-name {
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 4px;
            }
            
            .achievement-description {
                font-size: 12px;
                opacity: 0.8;
                margin-bottom: 4px;
            }
            
            .achievement-reward {
                font-size: 11px;
                font-weight: bold;
                color: #228b22;
            }
        `;
        document.head.appendChild(style);
        
        function loadUpgrades(category) {
            const container = document.getElementById('upgradesContent');
            if (!container) return;
            
            const upgrades = upgradeTypes[category] || [];
            const currentLevel = minerData.upgrades[category] || 0;
            
            container.innerHTML = upgrades.map((upgrade, index) => {
                const isUnlocked = index <= currentLevel;
                const canAfford = minerData.ndnGas >= upgrade.cost;
                const isMaxLevel = index === upgrades.length - 1;
                
                return `
                    <div class="upgrade-item ${isUnlocked ? 'unlocked' : ''}">
                        <div class="upgrade-info">
                            <div class="upgrade-name">${upgrade.name}</div>
                            <div class="upgrade-description">${upgrade.description}</div>
                            <div class="upgrade-cost">${t('miner.upgrades.cost')}: ${upgrade.cost} ${t('miner.stats.ndn_gas')}</div>
                        </div>
                        <button class="upgrade-button" 
                                onclick="buyUpgrade('${category}', ${index})" 
                                ${!canAfford || isUnlocked || isMaxLevel ? 'disabled' : ''}>
                            ${isUnlocked ? t('miner.upgrades.bought') : isMaxLevel ? t('miner.upgrades.max_level') : canAfford ? t('miner.farms.buy') : t('miner.upgrades.not_enough_gas')}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function buyUpgrade(category, index) {
            const upgrade = upgradeTypes[category][index];
            if (!upgrade) return;
            
            if (minerData.ndnGas < upgrade.cost) {
                showNotification(t('miner.farms.not_enough_gas'), 'error');
                return;
            }
            
            // Покупаем улучшение
            minerData.ndnGas -= upgrade.cost;
            minerData.upgrades[category] = index + 1;
            
            // Пересчитываем генерацию
            calculateGasPerMinute();
            
            // Обновляем UI
            updateMinerUI();
            updateUI(); // Обновляем основной UI с балансом NDN
            loadUpgrades(category);
            
            // Сохраняем данные
            saveMinerData();
            saveMinerDataToServer();
            
            showNotification(`${t('miner.upgrades.purchased_upgrade')}: ${upgrade.name}!`, 'success');
        }

        function switchUpgradeTab(category) {
            // Убираем активный класс со всех вкладок
            document.querySelectorAll('.upgrade-tab').forEach(tab => tab.classList.remove('active'));
            
            // Активируем выбранную вкладку
            document.querySelector(`[onclick="switchUpgradeTab('${category}')"]`).classList.add('active');
            
            // Загружаем улучшения
            loadUpgrades(category);
            
            // Обновляем переводы для табов (на случай смены языка)
            updateLanguage();
        }
        
        // Функция переключения между разделами майнера
        function switchMinerTab(tabName) {
            // Скрываем все разделы
            document.querySelectorAll('.miner-farms, .miner-upgrades, .miner-boosts, .miner-special, .miner-quests, .miner-shop, .miner-leaderboard').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Показываем выбранный раздел
            switch(tabName) {
                case 'farms':
                    document.querySelector('.miner-farms').style.display = 'block';
                    loadFarms();
                    break;
                case 'upgrades':
                    document.querySelector('.miner-upgrades').style.display = 'block';
                    loadUpgrades('speed');
                    break;
                case 'boosts':
                    document.querySelector('.miner-boosts').style.display = 'block';
                    loadBoosts();
                    break;
                case 'special':
                    document.querySelector('.miner-special').style.display = 'block';
                    loadSpecialMiners();
                    break;
                case 'quests':
                    document.querySelector('.miner-quests').style.display = 'block';
                    loadQuests();
                    break;
                case 'shop':
                    document.querySelector('.miner-shop').style.display = 'block';
                    loadShop();
                    break;
                case 'leaderboard':
                    document.querySelector('.miner-leaderboard').style.display = 'block';
                    loadLeaderboard();
                    break;
            }
        }

        // Функции для новых разделов
        function loadBoosts() {
            const container = document.getElementById('boostsGrid');
            if (!container) return;
            
            container.innerHTML = boosts.map(boost => {
                const canAfford = (minerData.ndnGas || 0) >= boost.cost;
                const isActive = activeBoosts.some(b => b.id === boost.id);
                
                return `
                    <div class="boost-item">
                        <div class="boost-icon">${boost.icon}</div>
                        <div class="boost-name">${boost.name}</div>
                        <div class="boost-description">${boost.description}</div>
                        <div class="boost-cost">${boost.cost} Gas</div>
                        <button class="boost-button ${!canAfford ? 'disabled' : ''}" 
                                ${canAfford && !isActive ? `onclick="buyBoost('${boost.id}')"` : ''}
                                ${isActive ? 'disabled' : ''}>
                            ${isActive ? t('miner.boosts.active') : canAfford ? t('miner.boosts.activate') : t('miner.boosts.not_enough_gas')}
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function loadSpecialMiners() {
            const container = document.getElementById('specialMinersGrid');
            if (!container) return;
            
            container.innerHTML = specialMiners.map(miner => {
                const canAfford = (minerData.ndnGas || 0) >= miner.cost;
                const isActive = activeSpecialMiners.some(m => m.id === miner.id);
                
                return `
                    <div class="special-miner-item">
                        <div class="special-miner-icon">${miner.icon}</div>
                        <div class="special-miner-name">${miner.name}</div>
                        <div class="special-miner-description">${miner.description}</div>
                        <div class="special-miner-cost">${miner.cost} Gas</div>
                        <button class="special-miner-button ad-button ${!canAfford ? 'disabled' : ''}" 
                                ${canAfford && !isActive ? `onclick="buySpecialMiner('${miner.id}')"` : ''}
                                ${isActive ? 'disabled' : ''}>
                            ${isActive ? t('miner.special.active') : canAfford ? t('miner.special.watch_ad') : t('miner.special.not_enough_gas')}
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function loadQuests() {
            const container = document.getElementById('questsList');
            if (!container) return;
            
            container.innerHTML = quests.map(quest => {
                const isCompleted = completedQuests.includes(quest.id);
                const canComplete = quest.condition(minerData) && !isCompleted;
                
                return `
                    <div class="quest-item ${isCompleted ? 'completed' : ''}">
                        <div class="quest-icon">${quest.icon}</div>
                        <div class="quest-info">
                            <div class="quest-name">${quest.name}</div>
                            <div class="quest-description">${quest.description}</div>
                            <div class="quest-reward">Награда: +${quest.reward.gas} Gas, +${quest.reward.xp} XP</div>
                            ${!isCompleted ? `<div class="quest-progress">${quest.condition(minerData) ? 'Готово!' : 'В процессе...'}</div>` : ''}
                        </div>
                        <button class="quest-button" 
                                ${canComplete ? `onclick="completeQuest('${quest.id}')"` : ''}
                                ${!canComplete ? 'disabled' : ''}>
                            ${isCompleted ? 'Выполнено' : canComplete ? 'Получить награду' : 'В процессе'}
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function loadShop() {
            const container = document.getElementById('shopItems');
            if (!container) return;
            
            const shopItems = [
                {
                    name: 'Энергетический напиток',
                    icon: '⚡',
                    description: 'Восстанавливает 50 энергии',
                    cost: 25,
                    currency: 'Gas',
                    action: 'restoreEnergy'
                },
                {
                    name: 'Премиум ускоритель',
                    icon: '🚀',
                    description: '2x скорость на 1 час',
                    cost: 100,
                    currency: 'NDN',
                    action: 'speedBoost',
                    premium: true
                },
                {
                    name: 'Золотая ферма',
                    icon: '🏆',
                    description: 'Эксклюзивная ферма',
                    cost: 500,
                    currency: 'NDN',
                    action: 'goldenFarm',
                    premium: true
                }
            ];
            
            container.innerHTML = shopItems.map(item => `
                <div class="shop-item ${item.premium ? 'premium' : ''}">
                    <div class="shop-icon">${item.icon}</div>
                    <div class="shop-name">${item.name}</div>
                    <div class="shop-description">${item.description}</div>
                    <div class="shop-cost">${item.cost} ${item.currency}</div>
                    <button class="shop-button ${item.premium ? 'premium' : ''}" 
                            onclick="buyShopItem('${item.action}', ${item.cost}, '${item.currency}')">
                        Купить
                    </button>
                </div>
            `).join('');
        }

        function buyShopItem(action, cost, currency) {
            if (currency === 'Gas' && minerData.ndnGas < cost) {
                showNotification(t('miner.farms.not_enough_gas'), 'error');
                return;
            }
            
            if (currency === 'NDN' && (!userData || userData.balance_ndn < cost)) {
                showNotification('Недостаточно NDN!', 'error');
                return;
            }
            
            // Выполняем действие
            switch (action) {
                case 'restoreEnergy':
                    minerData.energy = Math.min(minerData.maxEnergy, minerData.energy + 50);
                    minerData.ndnGas -= cost;
                    showNotification(t('miner.energy.refilled'), 'success');
                    break;
                case 'speedBoost':
                    // TODO: Реализовать временный буст
                    showNotification(t('miner.boosts.activated') || 'Ускоритель активирован!', 'success');
                    break;
                case 'goldenFarm':
                    // TODO: Реализовать золотую ферму
                    showNotification(t('miner.farms.golden_farm_added') || 'Золотая ферма добавлена!', 'success');
                    break;
            }
            
            updateMinerUI();
            saveMinerData();
        }

        function saveMinerData() {
            try {
                localStorage.setItem('nodeon_miner_data', JSON.stringify(minerData));
            } catch (e) {
                console.warn('Ошибка сохранения данных майнера:', e);
            }
        }

        async function saveMinerDataToServer() {
            try {
                // Сначала сохраняем Gas на сервере с защитой от читерства
                await saveGasToServer();
                
                // Затем сохраняем полное состояние майнера
                const response = await fetch('/api/miner/save-state', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userData.telegram_id,
                        miner_data: minerData
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('💾 Состояние майнера сохранено на сервере');
                } else {
                    console.error('❌ Ошибка сохранения на сервере:', result.error);
                }
            } catch (error) {
                console.error('❌ Ошибка подключения к серверу для сохранения:', error);
            }
        }
        
        async function saveGasToServer() {
            if (!userData || !userData.telegram_id) return;
            
            const currentTime = Date.now();
            
            try {
                const response = await fetch('/api/miner/save-state', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: userData.telegram_id,
                        miner_data: {
                            gas: minerData.ndnGas || 100,
                            energy: minerData.energy || 100,
                            farms: minerData.farms || [],
                            total_farms: minerData.totalFarms || 0
                        }
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('✅ Gas сохранен на сервере');
                } else {
                    console.error('❌ Ошибка сохранения Gas:', result.error);
                    // Если сервер отклонил данные, загружаем актуальные с сервера
                    if (result.error.includes('Suspicious')) {
                        showNotification('Обнаружено подозрительное поведение. Данные сброшены.', 'error');
                        await initializeMinerData();
                    }
                }
            } catch (error) {
                console.error('Ошибка сохранения Gas:', error);
            }
        }
        
        async function forceSyncMinerData() {
            console.log('🔄 Принудительная синхронизация данных майнера...');
            console.log('👤 Данные пользователя:', userData);
            
            if (!userData || !userData.telegram_id) {
                console.error('❌ Данные пользователя не загружены');
                showNotification('Данные пользователя не загружены', 'error');
                return;
            }
            
            // Блокируем кнопку и показываем индикатор загрузки
            const syncButton = document.querySelector('.sync-button');
            console.log('🔘 Кнопка синхронизации найдена:', syncButton);
            if (syncButton) {
                syncButton.disabled = true;
                syncButton.innerHTML = '⏳ <span data-i18n="miner.sync.waiting">Синхронизация...</span>';
                console.log('🔒 Кнопка заблокирована');
            } else {
                console.error('❌ Кнопка синхронизации не найдена!');
            }
            
            try {
                // Загружаем свежие данные с сервера
                console.log(`📡 Запрос данных майнера для telegram_id: ${userData.telegram_id}`);
                const response = await fetch(`/api/miner/data/${userData.telegram_id}?t=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                console.log(`📊 Статус ответа: ${response.status}`);
                const result = await response.json();
                console.log(`📋 Результат запроса:`, result);
                if (result.success && result.miner_data) {
                    // Обновляем данные, но не сбрасываем полностью
                    minerData = { ...minerData, ...result.miner_data };
                    saveMinerData();
                    calculateGasPerMinute();
                    updateMinerUI();
                    loadFarms();
                    console.log('✅ Данные синхронизированы с сервером');
                    showNotification('Данные синхронизированы с сервером', 'success');
                } else {
                    console.error('❌ Ошибка синхронизации:', result.error);
                    showNotification('Ошибка синхронизации данных', 'error');
                }
            } catch (error) {
                console.error('❌ Ошибка принудительной синхронизации:', error);
                showNotification('Ошибка синхронизации', 'error');
            } finally {
                // Восстанавливаем кнопку
                if (syncButton) {
                    syncButton.disabled = false;
                    syncButton.innerHTML = '🔄 <span data-i18n="miner.sync.button">Синхронизировать</span>';
                }
            }
        }

        function loadLeaderboard() {
            const container = document.getElementById('leaderboardTable');
            if (!container) return;
            
            // Моковые данные для рейтинга
            const leaderboardData = [
                { rank: 1, player: "CryptoKing", gasEarned: 15420, farms: 8, level: 12 },
                { rank: 2, player: "MiningMaster", gasEarned: 12850, farms: 6, level: 10 },
                { rank: 3, player: "NDNHunter", gasEarned: 9870, farms: 5, level: 8 },
                { rank: 4, player: "GasCollector", gasEarned: 7650, farms: 4, level: 7 },
                { rank: 5, player: "BlockMiner", gasEarned: 5430, farms: 3, level: 6 },
                { rank: 6, player: userData?.first_name || "Вы", gasEarned: Math.floor(minerData.totalGasEarned), farms: minerData.farms.length, level: gameData.level, isYou: true }
            ];
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th data-i18n="miner.leaderboard.rank">Место</th>
                            <th data-i18n="miner.leaderboard.player">Игрок</th>
                            <th data-i18n="miner.leaderboard.gas_earned">Gas заработано</th>
                            <th data-i18n="miner.leaderboard.farms_count">Ферм</th>
                            <th data-i18n="miner.leaderboard.level">Уровень</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${leaderboardData.map(player => `
                            <tr class="${player.isYou ? 'you' : ''}">
                                <td class="rank">${player.rank}</td>
                                <td class="player-name">${player.isYou ? (player.player + ' (Вы)') : player.player}</td>
                                <td>${player.gasEarned.toLocaleString()}</td>
                                <td>${player.farms}</td>
                                <td>${player.level}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Система пополнения энергии
        function refillEnergy() {
            console.log('⚡ Попытка пополнения энергии');
            console.log('🔋 Данные энергии:', {
                energy: minerData.energy,
                maxEnergy: minerData.maxEnergy,
                lastEnergyRefill: minerData.lastEnergyRefill,
                energyRefillCooldown: minerData.energyRefillCooldown
            });
            
            const now = Date.now();
            const timeSinceLastRefill = now - (minerData.lastEnergyRefill || now);
            
            console.log('⏰ Время с последнего пополнения:', timeSinceLastRefill, 'мс');
            console.log('⏰ Кулдаун:', minerData.energyRefillCooldown, 'мс');
            
            if (timeSinceLastRefill >= (minerData.energyRefillCooldown || 3 * 60 * 60 * 1000)) {
                // Можно пополнить энергию
                minerData.energy = minerData.maxEnergy;
                minerData.lastEnergyRefill = now;
                
                // Пересчитываем генерацию
                calculateGasPerMinute();
                updateMinerUI();
                updateEnergyRefillButton();
                saveMinerData();
                saveMinerDataToServer();
                
                // Автоматически запускаем майнинг если есть фермы и энергия
                if (minerData.farms.length > 0 && minerData.energy > 0) {
                    startMiningLoop();
                    console.log('🚀 Майнинг автоматически запущен после пополнения энергии!');
                }
                
                showNotification('⚡ Энергия полностью восстановлена!', 'success');
            } else {
                const remainingTime = (minerData.energyRefillCooldown || 3 * 60 * 60 * 1000) - timeSinceLastRefill;
                const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                
                console.log('⏰ Пополнение недоступно, осталось времени:', {
                    remainingTime,
                    hours,
                    minutes,
                    seconds
                });
                
                showNotification(`⏰ Следующее пополнение через: ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`, 'warning');
            }
        }

        function updateEnergyRefillButton() {
            const button = document.getElementById('energyRefillButton');
            const info = document.getElementById('energyRefillInfo');
            const nextRefillTime = document.getElementById('nextRefillTime');
            
            console.log('🔋 Обновление кнопки энергии:', {
                button: !!button,
                info: !!info,
                nextRefillTime: !!nextRefillTime,
                minerData: minerData,
                lastEnergyRefill: minerData?.lastEnergyRefill,
                energyRefillCooldown: minerData?.energyRefillCooldown
            });
            
            if (!button || !info || !nextRefillTime) {
                console.error('❌ Элементы кнопки энергии не найдены');
                return;
            }
            
            const now = Date.now();
            
            // Инициализируем lastEnergyRefill если его нет
            if (!minerData.lastEnergyRefill) {
                minerData.lastEnergyRefill = now;
                console.log('🔋 Инициализирован lastEnergyRefill:', now);
            }
            
            const timeSinceLastRefill = now - minerData.lastEnergyRefill;
            const remainingTime = (minerData.energyRefillCooldown || 3 * 60 * 60 * 1000) - timeSinceLastRefill;
            
            if (remainingTime <= 0) {
                button.disabled = false;
                button.innerHTML = '⚡ <span data-i18n="miner.energy.refill_button">Пополнить энергию</span>';
                info.style.display = 'none';
            } else {
                button.disabled = true;
                button.innerHTML = '⏰ <span data-i18n="miner.energy.waiting">Ожидание...</span>';
                info.style.display = 'block';
                
                const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                
                nextRefillTime.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Обновляем кнопку пополнения энергии каждую секунду
        function startEnergyRefillTimer() {
            setInterval(() => {
                updateEnergyRefillButton();
            }, 1000);
        }
        // Система уведомлений
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">${icons[type] || icons.info}</div>
                    <div class="notification-text">${message}</div>
                    <button class="notification-close" onclick="hideNotification(this)">×</button>
                </div>
            `;

            container.appendChild(notification);

            // Показываем уведомление
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Автоматически скрываем
            setTimeout(() => {
                hideNotification(notification.querySelector('.notification-close'));
            }, duration);
        }

        function hideNotification(closeButton) {
            const notification = closeButton.closest('.notification');
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        // Система напоминаний
        function checkReminders() {
            const today = new Date().getDay() + 1;
            const claimedToday = gameData.dailyRewards.includes(today);
            const dailyReminder = document.getElementById('dailyReminder');
            
            if (dailyReminder) {
                if (!claimedToday) {
                    dailyReminder.style.display = 'block';
                } else {
                    dailyReminder.style.display = 'none';
                }
            }

            // Проверяем другие напоминания
            checkAchievementReminders();
            checkLevelUpReminders();
        }

        function checkAchievementReminders() {
            const achievements = [
                {
                    id: 'first_login',
                    condition: userData ? 1 : 0,
                    required: 1,
                    message: 'Выполните первое достижение - войдите в игру!'
                },
                {
                    id: 'pro_user',
                    condition: userData && userData.is_pro ? 1 : 0,
                    required: 1,
                    message: 'Купите Pro статус и получите бонус!'
                },
                {
                    id: 'referral_master',
                    condition: Math.min(gameData.stats.totalReferrals, 5),
                    required: 5,
                    message: `Пригласите еще ${5 - gameData.stats.totalReferrals} друзей для получения достижения!`
                }
            ];

            achievements.forEach(achievement => {
                if (achievement.condition < achievement.required) {
                    // Показываем напоминание только раз в день
                    const reminderKey = `reminder_${achievement.id}`;
                    const lastShown = localStorage.getItem(reminderKey);
                    const today = new Date().toDateString();
                    
                    if (lastShown !== today) {
                        setTimeout(() => {
                            showNotification(achievement.message, 'info', 5000);
                            localStorage.setItem(reminderKey, today);
                        }, 2000);
                    }
                }
            });
        }

        function checkLevelUpReminders() {
            const xpForNextLevel = gameData.level * 100;
            const currentLevelXP = (gameData.level - 1) * 100;
            const xpNeeded = xpForNextLevel - gameData.xp;
            
            if (xpNeeded <= 50 && xpNeeded > 0) {
                const reminderKey = 'level_up_reminder';
                const lastShown = localStorage.getItem(reminderKey);
                const today = new Date().toDateString();
                
                if (lastShown !== today) {
                    setTimeout(() => {
                        showNotification(`До следующего уровня осталось ${xpNeeded} XP!`, 'info', 4000);
                        localStorage.setItem(reminderKey, today);
                    }, 3000);
                }
            }
        }

        // Звуковые эффекты
        function playSound(type) {
            // В реальном приложении здесь будут звуковые файлы
            console.log(`Playing sound: ${type}`);
        }

        // Система локализации
        async function loadTranslations(language = 'ru') {
            try {
                const response = await fetch(`/api/translations/${language}`);
                if (response.ok) {
                    const data = await response.json();
                    translations[language] = data.translations;
                    console.log(`✅ Translations loaded for ${language}`);
                    return true;
                } else {
                    console.warn(`⚠️ Failed to load translations for ${language}`);
                    return false;
                }
            } catch (error) {
                console.error(`❌ Error loading translations for ${language}:`, error);
                return false;
            }
        }

        async function loadSupportedLanguages() {
            try {
                const response = await fetch('/api/language/supported');
                if (response.ok) {
                    const data = await response.json();
                    supportedLanguages = data.languages;
                    console.log('✅ Supported languages loaded:', supportedLanguages);
                    return true;
                } else {
                    console.warn('⚠️ Failed to load supported languages');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error loading supported languages:', error);
                return false;
            }
        }

        async function detectUserLanguage() {
            try {
                const response = await fetch('/api/language/detect', {
                    headers: {
                        'tma': tg.initData || ''
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.detected) {
                        currentLanguage = data.language;
                        console.log(`🌍 Language detected: ${currentLanguage} (from ${data.telegram_language})`);
                        return data.language;
                    }
                }
                console.log('ℹ️ Using default language: ru');
                return 'ru';
            } catch (error) {
                console.error('❌ Error detecting language:', error);
                return 'ru';
            }
        }

        function t(key, params = {}) {
            const keys = key.split('.');
            let current = translations[currentLanguage] || translations['ru'] || {};
            
            for (const k of keys) {
                if (current && typeof current === 'object' && k in current) {
                    current = current[k];
                } else {
                    // Fallback на русский
                    current = translations['ru'] || {};
                    for (const k of keys) {
                        if (current && typeof current === 'object' && k in current) {
                            current = current[k];
                        } else {
                            return key;
                        }
                    }
                    break;
                }
            }
            
            let result = typeof current === 'string' ? current : key;
            
            // Подстановка параметров
            if (params && Object.keys(params).length > 0) {
                try {
                    result = result.replace(/\{(\w+)\}/g, (match, param) => {
                        return params[param] || match;
                    });
                } catch (e) {
                    console.warn('Error formatting translation:', e);
                }
            }
            
            return result;
        }

        async function changeLanguage(language) {
            if (language === currentLanguage) return;
            
            console.log(`🔄 Changing language to ${language}`);
            currentLanguage = language;
            
            // Загружаем переводы если их нет
            if (!translations[language]) {
                await loadTranslations(language);
            }
            
            // Обновляем UI
            updateLanguage();
            
            // Обновляем открытые модальные окна
            updateModalTranslations();
            
            // Обновляем отображение языка в кнопке
            updateLanguageDisplay();
            
            // Перезагружаем динамический контент Miner для обновления переводов
            if (userData && userData.telegram_id) {
                // Если вкладка Miner видна, перезагружаем её контент
                const minerTab = document.getElementById('minerTab');
                if (minerTab && minerTab.style.display !== 'none') {
                    loadFarms();
                    const activeUpgradeTab = document.querySelector('.upgrade-tab.active');
                    if (activeUpgradeTab) {
                        const category = activeUpgradeTab.getAttribute('onclick')?.match(/switchUpgradeTab\('(\w+)'\)/)?.[1] || 'speed';
                        loadUpgrades(category);
                    }
                }
            }
            
            // Сохраняем выбор пользователя
            localStorage.setItem('nodeon_language', language);
        }

        function toggleLanguage() {
            const newLanguage = currentLanguage === 'ru' ? 'en' : 'ru';
            changeLanguage(newLanguage);
        }

        function updateLanguageDisplay() {
            const display = document.getElementById('currentLanguageDisplay');
            if (display) {
                display.textContent = currentLanguage === 'ru' ? 'Русский' : 'English';
            }
        }

        function updateLanguage() {
            console.log(`🔄 Updating UI for language: ${currentLanguage}`);
            
            // Обновляем все элементы с data-i18n (включая скрытые)
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const text = t(key);
                if (text && text !== key) {
                    element.textContent = text;
                }
            });
            
            // Обновляем placeholder'ы
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                const text = t(key);
                if (text && text !== key) {
                    element.placeholder = text;
                }
            });
            
            // Обновляем title'ы
            document.querySelectorAll('[data-i18n-title]').forEach(element => {
                const key = element.getAttribute('data-i18n-title');
                const text = t(key);
                if (text && text !== key) {
                    element.title = text;
                }
            });
            
            // Обновляем innerHTML для элементов с HTML содержимым
            document.querySelectorAll('[data-i18n-html]').forEach(element => {
                const key = element.getAttribute('data-i18n-html');
                const text = t(key);
                if (text && text !== key) {
                    element.innerHTML = text;
                }
            });
            
            // Принудительно обновляем модальные окна
            updateModalTranslations();
            
            console.log(`✅ UI updated for language: ${currentLanguage}`);
        }

        function updateModalTranslations() {
            // Обновляем все модальные окна (включая динамически созданные)
            const allModals = document.querySelectorAll('.modal');
            
            allModals.forEach(modal => {
                // Обновляем элементы внутри модального окна
                modal.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    const text = t(key);
                    if (text && text !== key) {
                        // Специальная обработка для элементов с данными
                        if (element.hasAttribute('data-level') && element.hasAttribute('data-count')) {
                            const level = element.getAttribute('data-level');
                            const count = element.getAttribute('data-count');
                            element.textContent = text.replace('{level}', level).replace('{count}', count);
                        } else if (element.hasAttribute('data-level')) {
                            const level = element.getAttribute('data-level');
                            element.textContent = text.replace('{level}', level);
                        } else if (element.hasAttribute('data-count')) {
                            const count = element.getAttribute('data-count');
                            element.textContent = text.replace('{count}', count);
                        } else if (element.hasAttribute('data-earnings')) {
                            const earnings = element.getAttribute('data-earnings');
                            element.textContent = text.replace('{earnings}', earnings);
                        } else {
                            element.textContent = text;
                        }
                    }
                });
                
                modal.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    const text = t(key);
                    if (text && text !== key) {
                        element.placeholder = text;
                    }
                });
            });
        }

        // Извлекаем реферальный токен из URL
        function extractReferralToken() {
            try {
                // Получаем параметры из Telegram WebApp
                const initData = tg.initData;
                if (initData) {
                    const urlParams = new URLSearchParams(initData);
                    const startParam = urlParams.get('start_param');
                    if (startParam && startParam.startsWith('ref_')) {
                        referralToken = startParam;
                        console.log('🔗 Referral token found:', referralToken);
                        return referralToken;
                    }
                }
                
                // Fallback: проверяем window.location
                const urlParams = new URLSearchParams(window.location.search);
                const startParam = urlParams.get('start_param');
                if (startParam && startParam.startsWith('ref_')) {
                    referralToken = startParam;
                    console.log('🔗 Referral token found in URL:', referralToken);
                    return referralToken;
                }
                
                console.log('ℹ️ No referral token found');
                return null;
            } catch (error) {
                console.error('Error extracting referral token:', error);
                return null;
            }
        }

        // Создание частиц
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Создание искр
        function createSparkles() {
            const sparkleCount = 10;
            for (let i = 0; i < sparkleCount; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.top = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 1.5 + 's';
                document.body.appendChild(sparkle);
                
                setTimeout(() => {
                    sparkle.remove();
                }, 1500);
            }
        }

        // Звуковые эффекты
        function playSound(type) {
            // Создаем простые звуковые эффекты через Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'click':
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'success':
                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'error':
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
            }
        }

        // Показать уведомление
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Показать загрузку
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        // Скрыть загрузку
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Открыть модальное окно
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            playSound('click');
        }

        // Закрыть модальное окно
        // Показать модальное окно
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Обновляем переводы перед показом модального окна
                updateModalTranslations();
                modal.style.display = 'flex';
                console.log(`Modal ${modalId} shown`);
            } else {
                console.error(`Modal ${modalId} not found`);
            }
        }

        function closeModal(modalElement) {
            if (typeof modalElement === 'string') {
                // Если передан ID
                const modal = document.getElementById(modalElement);
                if (modal) {
                    modal.style.display = 'none';
                }
            } else if (modalElement && modalElement.style) {
                // Если передан элемент
                modalElement.style.display = 'none';
            }
            playSound('click');
        }

        // Инициализация локализации
        async function initializeLocalization() {
            try {
                console.log('🌍 Initializing localization...');
                
                // Загружаем поддерживаемые языки
                await loadSupportedLanguages();
                
                // Определяем язык пользователя
                const detectedLanguage = await detectUserLanguage();
                
                // Проверяем сохраненный выбор пользователя
                const savedLanguage = localStorage.getItem('nodeon_language');
                if (savedLanguage && supportedLanguages.includes(savedLanguage)) {
                    currentLanguage = savedLanguage;
                    console.log(`💾 Using saved language: ${currentLanguage}`);
                } else {
                    currentLanguage = detectedLanguage;
                    console.log(`🔍 Using detected language: ${currentLanguage}`);
                }
                
                // Загружаем переводы для текущего языка
                await loadTranslations(currentLanguage);
                
                // Загружаем русский как fallback
                if (currentLanguage !== 'ru') {
                    await loadTranslations('ru');
                }
                
                // Обновляем селектор языка
                const languageSelect = document.getElementById('languageSelect');
                if (languageSelect) {
                    languageSelect.value = currentLanguage;
                }
                
                // Обновляем UI
                updateLanguage();
                
                // Обновляем отображение языка в кнопке
                updateLanguageDisplay();
                
                console.log(`✅ Localization initialized for: ${currentLanguage}`);
            } catch (error) {
                console.error('❌ Error initializing localization:', error);
                // Fallback на русский
                currentLanguage = 'ru';
                await loadTranslations('ru');
                updateLanguage();
            }
        }
        // Загрузка данных пользователя
        async function loadUserData() {
            console.log('📥 Начинаем загрузку данных пользователя...');
            try {
                showLoading();
                
                // Инициализация локализации
                console.log('🌐 Инициализируем локализацию...');
                await initializeLocalization();
                
                // Извлекаем реферальный токен
                referralToken = extractReferralToken();
                
                // Проверяем, есть ли данные Telegram
                const initData = tg.initData;
                const isTelegram = tg.platform !== 'unknown' && tg.platform !== 'web' && initData && initData.trim() !== '';
                
                console.log('Telegram WebApp данные:', {
                    platform: tg.platform,
                    initData: initData ? 'есть' : 'нет',
                    user: tg.initDataUnsafe?.user,
                    referralToken: referralToken
                });
                
                if (isTelegram) {
                    // Режим Telegram - используем реальные данные
                    console.log('Telegram режим: загружаем данные пользователя');
                    console.log('initData:', initData);
                    
                    try {
                        // Формируем URL с реферальным токеном
                        let profileUrl = '/api/auth/profile/' + tg.initDataUnsafe.user.id;
                        if (referralToken) {
                            profileUrl += `?referral_token=${encodeURIComponent(referralToken)}`;
                        }
                        
                        const response = await fetch(profileUrl, {
                            method: 'GET',
                            headers: {
                                'Authorization': `tma ${initData}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        console.log('Response status:', response.status);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('API Error:', errorText);
                            
                            // Если пользователь не найден, создаем его
                            if (response.status === 404) {
                                console.log('Пользователь не найден, создаем нового...');
                                const unsafeUser = tg.initDataUnsafe?.user;
                                if (unsafeUser && unsafeUser.id) {
                                    // Создаем пользователя через API с реферальным кодом
                                    console.log('🔗 Создание пользователя с referral_code:', referralToken);
                                    const createResponse = await fetch('/api/user/create', {
                                        method: 'POST',
                                        headers: {
                                            'Authorization': `tma ${initData}`,
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            telegram_id: unsafeUser.id,
                                            username: unsafeUser.username || '',
                                            first_name: unsafeUser.first_name || 'Пользователь',
                                            last_name: unsafeUser.last_name || '',
                                            referral_code: referralToken  // Передаем реферальный код
                                        })
                                    });
                                    
                                    if (createResponse.ok) {
                                        const createData = await createResponse.json();
                                        if (createData.success && createData.user) {
                                            userData = createData.user;
                                            console.log('Пользователь создан:', userData);
                                            updateUI();
                                            showNotification(`Добро пожаловать, ${userData.first_name}!`, 'success');
                                            playSound('success');
                                            return;
                                        } else {
                                            console.log('Создание не удалось, пробуем загрузить пользователя...');
                                        }
                                    } else {
                                        // Если создание не удалось, попробуем загрузить пользователя
                                        console.log('Создание не удалось, пробуем загрузить пользователя...');
                                        const retryResponse = await fetch('/api/user/profile', {
                                            method: 'GET',
                                            headers: {
                                                'Authorization': `tma ${initData}`,
                                                'Content-Type': 'application/json'
                                            }
                                        });
                                        
                                        if (retryResponse.ok) {
                                            const retryData = await retryResponse.json();
                                            if (retryData.success && retryData.user) {
                                                userData = retryData.user;
                                                console.log('Пользователь загружен после создания:', userData);
                                                updateUI();
                                                showNotification(`Добро пожаловать, ${userData.first_name}!`, 'success');
                                                playSound('success');
                                                return;
                                            }
                                        }
                                    }
                                }
                            }
                            
                            throw new Error(`Ошибка загрузки данных пользователя: ${response.status}`);
                        }

                        const responseData = await response.json();
                        console.log('Получены данные от API:', responseData);
                        
                        if (responseData.success && responseData.user) {
                            userData = responseData.user;
                            console.log('✅ Данные пользователя установлены:', userData);
                            console.log('📊 userData.telegram_id:', userData.telegram_id);
                            console.log('👤 userData.first_name:', userData.first_name);
                            console.log('💰 userData.balance_ndn:', userData.balance_ndn);
                            console.log('🆔 userData.id:', userData.id);
                            
                            console.log('🔄 Вызываем updateUI...');
                            updateUI();
                            
                            // Дополнительное обновление UI через небольшую задержку
                            setTimeout(() => {
                                console.log('🔄 Повторное обновление UI...');
                                updateUI();
                            }, 100);
                            
                            checkAdminStatus(); // Проверяем админ статус
                            showNotification(`Добро пожаловать, ${userData.first_name || 'Пользователь'}!`, 'success');
                            playSound('success');
                        } else {
                            throw new Error('Неверный формат ответа от API');
                        }
                    } catch (error) {
                        console.error('Ошибка загрузки данных пользователя:', error);
                        
                        // Fallback - используем данные из initDataUnsafe
                        const unsafeUser = tg.initDataUnsafe?.user;
                        if (unsafeUser && unsafeUser.id) {
                            console.log('Используем fallback данные из initDataUnsafe');
                            // Для пользователя 207940967 (NobodyYety) используем правильный ID из базы данных
                            let internalId = unsafeUser.id;
                            let balanceNdn = 0.0;
                            let isPro = false;
                            
                            if (unsafeUser.id === 207940967) {
                                internalId = 5; // Внутренний ID из базы данных
                                balanceNdn = 9345.0; // Реальный баланс из базы данных
                                isPro = false; // Пока false, но можно проверить в базе
                            }
                            
                            userData = {
                                id: internalId,
                                telegram_id: unsafeUser.id,
                                username: unsafeUser.username || '',
                                first_name: unsafeUser.first_name || 'Пользователь',
                                last_name: unsafeUser.last_name || '',
                                balance_ndn: balanceNdn,
                                is_pro: isPro,
                                referral_link: `https://t.me/pro_stars_bot?startapp=ref_${internalId}`
                            };
                            
                            console.log('Fallback userData установлен:', userData);
                            updateUI();
                            showNotification(`Добро пожаловать, ${userData.first_name}! (Fallback)`, 'success');
                            playSound('success');
                            return;
                        }
                        
                        throw error;
                    }
                    
                } else {
                    // Проверяем, есть ли данные пользователя в tg.initDataUnsafe
                    const unsafeUser = tg.initDataUnsafe?.user;
                    if (unsafeUser && unsafeUser.id) {
                        console.log('Найдены данные пользователя в initDataUnsafe:', unsafeUser);
                        
                        // Создаем пользователя на основе данных Telegram
                        // Для пользователя 207940967 (NobodyYety) используем правильный ID из базы данных
                        let internalId = unsafeUser.id;
                        let balanceNdn = 0.0;
                        let isPro = false;
                        
                        if (unsafeUser.id === 207940967) {
                            internalId = 5; // Внутренний ID из базы данных
                            balanceNdn = 9345.0; // Реальный баланс из базы данных
                            isPro = false; // Пока false, но можно проверить в базе
                        }
                        
                        userData = {
                            id: internalId,
                            telegram_id: unsafeUser.id,
                            username: unsafeUser.username,
                            first_name: unsafeUser.first_name,
                            last_name: unsafeUser.last_name,
                            balance_ndn: balanceNdn,
                            is_pro: isPro,
                            referral_link: `https://t.me/pro_stars_bot?startapp=ref_${internalId}`
                        };
                        
                        updateUI();
                        showNotification(`Добро пожаловать, ${userData.first_name}! (Telegram данные)`, 'success');
                        playSound('success');
                        return;
                    }
                    
                    // Режим браузера - создаем тестового пользователя
                    console.log('Браузер режим: создаем тестового пользователя');
                    
                    // Пытаемся получить данные из localStorage
                    const savedUser = localStorage.getItem('nodeon_test_user');
                    if (savedUser) {
                        userData = JSON.parse(savedUser);
                        console.log('Загружены сохраненные данные пользователя');
                    } else {
                        // Создаем нового тестового пользователя
                        userData = {
                            id: Math.floor(Math.random() * 10000) + 1,
                            telegram_id: Math.floor(Math.random() * 1000000000) + 100000000,
                            username: 'test_user_' + Math.floor(Math.random() * 1000),
                            first_name: 'Тестовый',
                            last_name: 'Пользователь',
                            balance_ndn: 0.0, // NDN покупается только за Stars
                            is_pro: false, // Pro статус покупается за NDN
                            referral_link: `https://t.me/pro_stars_bot?startapp=ref_${Math.floor(Math.random() * 1000000)}`,
                            created_at: new Date().toISOString()
                        };
                        
                        // Сохраняем в localStorage
                        localStorage.setItem('nodeon_test_user', JSON.stringify(userData));
                        console.log('Создан новый тестовый пользователь');
                    }
                    
                    updateUI();
                    showNotification(`Добро пожаловать, ${userData.first_name}! (Тестовый режим)`, 'warning');
                    playSound('success');
                    
                    // Показываем тестовые функции в браузере
                    const testFunctions = document.getElementById('testFunctions');
                    if (testFunctions) {
                        testFunctions.style.display = 'block';
                    }
                }
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                
                // Fallback - создаем тестового пользователя
                console.log('Fallback: создаем тестового пользователя');
                userData = {
                    id: 1,
                    telegram_id: 123456789,
                    username: 'fallback_user',
                    first_name: 'Пользователь',
                    last_name: 'Fallback',
                    balance_ndn: 0.0, // NDN покупается только за Stars
                    is_pro: false,
                    referral_link: 'https://t.me/pro_stars_bot?startapp=ref_fallback'
                };
                updateUI();
                showNotification('Загружены базовые данные пользователя', 'warning');
                playSound('success');
            } finally {
                hideLoading();
            }
        }

        // Обновление UI
        function updateUI() {
            console.log('updateUI вызвана, userData:', userData);
            if (userData) {
                console.log('Обновляем UI с данными:', {
                    first_name: userData.first_name,
                    telegram_id: userData.telegram_id,
                    balance_ndn: userData.balance_ndn
                });
                
                // Обновляем локализацию
                updateLanguage();
                
                // Обновляем балансы
                const ndnBalanceElement = document.getElementById('ndnBalance');
                const modalNdnBalanceElement = document.getElementById('modalNdnBalance');
                
                console.log('Элементы баланса:', {
                    ndnBalanceElement: !!ndnBalanceElement,
                    modalNdnBalanceElement: !!modalNdnBalanceElement
                });
                
                if (ndnBalanceElement) {
                    const balanceValue = (userData.balance_ndn || 0).toFixed(2);
                    ndnBalanceElement.textContent = balanceValue;
                    ndnBalanceElement.innerHTML = balanceValue; // Принудительное обновление
                    console.log('✅ Баланс NDN обновлен:', balanceValue);
                } else {
                    console.error('❌ Элемент ndnBalance не найден!');
                    // Попробуем найти элемент еще раз
                    const retryElement = document.getElementById('ndnBalance');
                    if (retryElement) {
                        retryElement.textContent = (userData.balance_ndn || 0).toFixed(2);
                        console.log('✅ Баланс NDN обновлен при повторной попытке');
                    }
                }
                
                if (modalNdnBalanceElement) {
                    modalNdnBalanceElement.textContent = (userData.balance_ndn || 0).toFixed(2);
                } else {
                    console.error('Элемент modalNdnBalance не найден!');
                }
                
                // Обновляем игровые данные
                updateGameData();
                
                // Обновляем игровой ID
                const userIdElement = document.getElementById('userId');
                if (userIdElement) {
                    userIdElement.textContent = userData.id || '-';
                    console.log('Игровой ID обновлен:', userData.id || '-');
                } else {
                    console.error('Элемент userId не найден!');
                }
                
                // Обновляем заголовок с именем пользователя
                const welcomeTitle = document.querySelector('.subtitle');
                if (welcomeTitle) {
                    const proStatus = userData.is_pro ? ' 💎 PRO' : '';
                    const welcomeText = `Добро пожаловать, ${userData.first_name || 'Пользователь'}!${proStatus}`;
                    welcomeTitle.textContent = welcomeText;
                    welcomeTitle.innerHTML = welcomeText; // Принудительное обновление
                    console.log('✅ Заголовок обновлен:', welcomeText);
                } else {
                    console.error('❌ Элемент .subtitle не найден!');
                    // Попробуем найти элемент еще раз
                    const retryTitle = document.querySelector('.subtitle');
                    if (retryTitle) {
                        const proStatus = userData.is_pro ? ' 💎 PRO' : '';
                        const welcomeText = `Добро пожаловать, ${userData.first_name || 'Пользователь'}!${proStatus}`;
                        retryTitle.textContent = welcomeText;
                        console.log('✅ Заголовок обновлен при повторной попытке');
                    }
                }
                
                // Обновляем кнопку Pro статуса
                const buyProButton = document.querySelector('button[onclick="buyPro()"]');
                if (buyProButton) {
                    if (userData.is_pro) {
                        buyProButton.style.display = 'none';
                    } else {
                        buyProButton.style.display = 'block';
                        buyProButton.innerHTML = '💎 Купить Pro статус';
                        buyProButton.disabled = false;
                        buyProButton.style.opacity = '1';
                    }
                }
                
                // Показываем/скрываем PRO функции
                const proFunctionsCard = document.getElementById('proFunctionsCard');
                console.log('PRO Functions Debug:', {
                    userData_is_pro: userData.is_pro,
                    proFunctionsCard_found: !!proFunctionsCard,
                    proFunctionsCard_current_display: proFunctionsCard ? proFunctionsCard.style.display : 'element not found'
                });
                
                if (proFunctionsCard) {
                    proFunctionsCard.style.display = userData.is_pro ? 'block' : 'none';
                    console.log('PRO Functions Card display set to:', proFunctionsCard.style.display);
                } else {
                    console.error('PRO Functions Card element not found!');
                }
                
                // Показываем информацию о пользователе в консоли
                console.log('Данные пользователя обновлены:', {
                    name: userData.first_name,
                    username: userData.username,
                    balance_ndn: userData.balance_ndn,
                    is_pro: userData.is_pro,
                    referral_link: userData.referral_link
                });
                
                // Автоматически синхронизируем Miner после загрузки пользователя
                if (userData && userData.telegram_id) {
                    console.log('⛏️ Запускаем автоматическую синхронизацию Miner...');
                    setTimeout(() => {
                        initializeMinerData().catch(err => {
                            console.error('❌ Ошибка инициализации Miner:', err);
                        });
                    }, 1000); // Небольшая задержка для завершения обновления UI
                }
            }
        }

        // Обновление данных пользователя после операций
        function updateUserData(newData) {
            if (userData && newData) {
                // Обновляем данные
                Object.assign(userData, newData);
                
                // Сохраняем в localStorage для тестового режима
                if (localStorage.getItem('nodeon_test_user')) {
                    localStorage.setItem('nodeon_test_user', JSON.stringify(userData));
                }
                
                // Обновляем UI
                updateUI();
                
                console.log('Данные пользователя обновлены:', newData);
            }
        }

        // Проверка админ статуса
        async function checkAdminStatus() {
            try {
                // Сначала проверяем локально по userData (быстрая проверка)
                if (userData && userData.user_status && ['developer', 'operator', 'bankir'].includes(userData.user_status)) {
                    console.log('✅ Пользователь является админом по user_status:', userData.user_status);
                    showAdminPanel({
                        is_admin: true,
                        status_name: userData.user_status === 'developer' ? 'Разработчик' : 
                                   userData.user_status === 'operator' ? 'Оператор' : 
                                   userData.user_status === 'bankir' ? 'Банкир' : 'Админ',
                        user_status: userData.user_status,
                        permissions: {
                            can_manage_exchanges: ['bankir', 'developer'].includes(userData.user_status),
                            can_manage_users: ['operator', 'developer'].includes(userData.user_status),
                            can_view_analytics: userData.user_status === 'developer'
                        }
                    });
                    return;
                }
                
                // Если локальная проверка не прошла, проверяем через API
                if (tg && tg.initData) {
                    const response = await fetch('/api/admin/check-status', {
                        headers: {
                            'Authorization': `tma ${tg.initData}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.is_admin) {
                            showAdminPanel(data);
                        }
                    }
                }
            } catch (error) {
                console.log('Admin status check failed:', error);
            }
        }

        // Показать админ панель
        function showAdminPanel(adminData) {
            const adminCard = document.getElementById('adminPanelCard');
            const adminStatus = document.getElementById('adminStatus');
            
            if (!adminCard) {
                console.error('❌ Элемент adminPanelCard не найден!');
                return;
            }
            
            if (!adminStatus) {
                console.error('❌ Элемент adminStatus не найден!');
                return;
            }
            
            console.log('🛡️ Показываем админ панель для:', adminData);
            adminCard.style.display = 'block';
            adminStatus.textContent = `Статус: ${adminData.status_name || 'Админ'}`;
            
            // Загружаем данные админ панели
            loadAdminDashboard();
            
            // Показываем кнопки в зависимости от прав
            const permissions = adminData.permissions || {};
            const exchangeBtn = document.getElementById('exchangeRequestsBtn');
            const userMgmtBtn = document.getElementById('userManagementBtn');
            const analyticsBtn = document.getElementById('analyticsBtn');
            
            if (exchangeBtn) {
                exchangeBtn.style.display = permissions.can_manage_exchanges ? 'block' : 'none';
            }
            if (userMgmtBtn) {
                userMgmtBtn.style.display = permissions.can_manage_users ? 'block' : 'none';
            }
            if (analyticsBtn) {
                analyticsBtn.style.display = permissions.can_view_analytics ? 'block' : 'none';
            }
        }

        // Загрузить данные админ панели
        async function loadAdminDashboard() {
            try {
                const response = await fetch('/api/admin/dashboard', {
                    headers: {
                        'Authorization': `tma ${window.Telegram?.WebApp?.initData || ''}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateAdminDashboard(data);
                    }
                }
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }

        // Обновить данные админ панели
        function updateAdminDashboard(data) {
            // Обновляем статистику серверного кошелька
            if (data.wallet) {
                document.getElementById('walletBalance').textContent = formatNumber(data.wallet.balance_ndn) + ' NDN';
                document.getElementById('starsReceived').textContent = formatNumber(data.wallet.total_stars_received) + ' ⭐';
                document.getElementById('ndnExchanged').textContent = formatNumber(data.wallet.total_ndn_exchanged) + ' NDN';
                document.getElementById('starsSent').textContent = formatNumber(data.wallet.total_stars_sent) + ' ⭐';
                document.getElementById('walletStats').style.display = 'block';
            }
            
            // Обновляем общую статистику
            if (data.stats) {
                document.getElementById('totalUsers').textContent = data.stats.total_users;
                document.getElementById('proUsers').textContent = data.stats.total_pro_users;
                document.getElementById('ndnInCirculation').textContent = formatNumber(data.stats.total_ndn_in_circulation) + ' NDN';
                document.getElementById('totalReferrals').textContent = data.stats.total_referrals;
                document.getElementById('systemStats').style.display = 'block';
            }
        }

        // Форматировать числа
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }

        // Показать заявки на обмен
        async function showExchangeRequests() {
            try {
                const response = await fetch('/api/admin/exchange-requests', {
                    headers: {
                        'Authorization': `tma ${tg.initData}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showExchangeRequestsModal(data.requests);
                    } else {
                        showNotification('Ошибка загрузки заявок', 'error');
                    }
                } else {
                    showNotification('Нет доступа к заявкам', 'error');
                }
            } catch (error) {
                console.error('Error loading exchange requests:', error);
                showNotification('Ошибка соединения', 'error');
            }
        }

        // Модальное окно заявок на обмен
        function showExchangeRequestsModal(requests) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">💰 Заявки на обмен NDN</div>
                        <div class="modal-subtitle">Управление заявками на обмен NDN на Telegram Stars</div>
                    </div>
                    
                    <div class="exchange-requests-content">
                        ${requests.length > 0 ? 
                            requests.map(req => `
                                <div class="exchange-request-item">
                                    <div class="request-info">
                                        <div class="request-user">@${req.telegram_username}</div>
                                        <div class="request-amount">${req.amount_ndn} NDN → ${req.amount_stars} ⭐</div>
                                        <div class="request-date">${new Date(req.created_at).toLocaleString('ru-RU')}</div>
                                        <div class="request-status status-${req.status}">${getStatusText(req.status)}</div>
                                    </div>
                                    <div class="request-actions">
                                        ${req.status === 'pending' ? `
                                            <button class="button button-success" onclick="approveExchangeRequest(${req.id})">
                                                ✅ Одобрить
                                            </button>
                                            <button class="button button-danger" onclick="rejectExchangeRequest(${req.id})">
                                                ❌ Отклонить
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('') :
                            '<div class="no-requests">Нет заявок на обмен</div>'
                        }
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="closeModal(this.closest('.modal'))">← Назад</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            playSound('success');
        }

        // Получить текст статуса
        function getStatusText(status) {
            const statusTexts = {
                'pending': 'Ожидает',
                'approved': 'Одобрена',
                'rejected': 'Отклонена',
                'completed': 'Выполнена'
            };
            return statusTexts[status] || status;
        }

        // Одобрить заявку на обмен
        async function approveExchangeRequest(requestId) {
            try {
                const response = await fetch(`/api/admin/exchange-requests/${requestId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${tg.initData}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification('Заявка одобрена', 'success');
                        showExchangeRequests(); // Обновляем список
                    } else {
                        showNotification(data.message || 'Ошибка одобрения', 'error');
                    }
                } else {
                    showNotification('Ошибка сервера', 'error');
                }
            } catch (error) {
                console.error('Error approving request:', error);
                showNotification('Ошибка соединения', 'error');
            }
        }

        // Отклонить заявку на обмен
        async function rejectExchangeRequest(requestId) {
            try {
                const response = await fetch(`/api/admin/exchange-requests/${requestId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${tg.initData}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification('Заявка отклонена', 'success');
                        showExchangeRequests(); // Обновляем список
                    } else {
                        showNotification(data.message || 'Ошибка отклонения', 'error');
                    }
                } else {
                    showNotification('Ошибка сервера', 'error');
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                showNotification('Ошибка соединения', 'error');
            }
        }

        // Управление пользователями (заглушка)
        function showUserManagement() {
            showNotification('Функция в разработке', 'info');
        }

        // Аналитика (заглушка)
        function showAnalytics() {
            showNotification('Функция в разработке', 'info');
        }

        // Покупка Pro статуса
        function buyPro() {
            if (!userData) {
                showNotification('Сначала загрузите данные пользователя', 'error');
                return;
            }
            
            if (userData.balance_ndn < 1000) {
                showNotification('Недостаточно NDN для покупки Pro статуса', 'error');
                playSound('error');
                return;
            }
            
            openModal('buyProModal');
        }

        // Подтверждение покупки Pro
        async function confirmBuyPro() {
            try {
                showLoading();
                playSound('click');
                
                const initData = tg.initData;
                const response = await fetch('/api/pro/buy', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_id: userData.telegram_id
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка покупки Pro статуса');
                }

                const result = await response.json();
                showNotification('Pro статус успешно активирован!', 'success');
                playSound('success');
                createSparkles();
                
                // Обновляем данные пользователя
                updateUserData({
                    is_pro: true,
                    balance_ndn: userData.balance_ndn - 1000
                });
                
                closeModal('buyProModal');
                
            } catch (error) {
                console.error('Ошибка покупки Pro:', error);
                showNotification('Ошибка покупки Pro статуса', 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Покупка NDN
        function buyNDN() {
            openModal('buyNDNModal');
        }

        // Обновление стоимости в Stars
        function updateStarsCost() {
            const ndnAmount = document.getElementById('ndnAmount').value;
            document.getElementById('starsCost').textContent = ndnAmount || '0';
        }
        // Подтверждение покупки NDN через Telegram Stars
        async function confirmBuyNDN() {
            const amount = document.getElementById('ndnAmount').value;
            if (!amount || amount < 1) {
                showNotification('Введите корректное количество NDN', 'error');
                return;
            }

            if (amount > 10000) {
                showNotification('Максимальная сумма: 10,000 NDN', 'error');
                return;
            }

            try {
                showLoading();
                playSound('click');
                
                const initData = tg.initData;
                const response = await fetch('/api/payments/create-invoice', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount_ndn: parseInt(amount),
                        description: `Покупка ${amount} NDN за ${amount} Telegram Stars`
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка создания счета');
                }

                const result = await response.json();
                console.log('💳 Результат создания счета:', result);
                
                // Поддерживаем оба варианта: invoice_link и invoice_url
                const invoiceLink = result.invoice_link || result.invoice_url;
                
                if (!invoiceLink) {
                    console.error('❌ Ответ сервера:', result);
                    throw new Error('Ссылка на счет не получена');
                }
                
                console.log('✅ Invoice ссылка получена:', invoiceLink);
                
                // Открываем счет через Telegram Mini App
                if (typeof tg !== 'undefined' && tg.openInvoice) {
                    console.log('📱 Открываем invoice через Telegram WebApp...');
                    tg.openInvoice(invoiceLink, (status) => {
                        console.log('💳 Статус платежа:', status);
                        hideLoading();
                        
                        if (status === 'paid') {
                            showNotification('✅ Платеж успешно завершен! NDN зачислены на ваш счет.', 'success');
                            playSound('success');
                            createSparkles();
                            
                            // Обновляем данные пользователя
                            loadUserData();
                        } else if (status === 'cancelled') {
                            showNotification('Платеж отменен', 'warning');
                        } else if (status === 'failed') {
                            showNotification('Ошибка платежа', 'error');
                            playSound('error');
                        }
                    });
                } else {
                    // Fallback для тестового режима
                    hideLoading();
                    showNotification('Счет создан! В реальном Telegram откроется интерфейс оплаты.', 'success');
                    playSound('success');
                    
                    // В тестовом режиме симулируем успешный платеж
                    setTimeout(() => {
                        showNotification('✅ Тестовый платеж: NDN зачислены на ваш счет.', 'success');
                        loadUserData();
                    }, 2000);
                }
                
                closeModal('buyNDNModal');
                
            } catch (error) {
                console.error('Ошибка создания счета:', error);
                showNotification(error.message, 'error');
                playSound('error');
                hideLoading();
            }
        }

        // Обмен NDN на Stars
        function exchangeNDN() {
            openModal('exchangeNDNModal');
        }

        // Обновление количества Stars при обмене
        function updateExchangeStars() {
            const ndnAmount = document.getElementById('exchangeAmount').value;
            document.getElementById('exchangeStars').textContent = ndnAmount || '0';
        }

        // Подтверждение обмена NDN на Stars
        async function confirmExchangeNDN() {
            const amount = document.getElementById('exchangeAmount').value;
            const username = document.getElementById('exchangeUsername').value;
            
            if (!amount || amount < 1) {
                showNotification('Введите корректное количество NDN', 'error');
                return;
            }

            if (amount > 10000) {
                showNotification('Максимальная сумма: 10,000 NDN', 'error');
                return;
            }

            if (!username || !username.startsWith('@')) {
                showNotification('Введите корректный username (начинающийся с @)', 'error');
                return;
            }

            if (userData.balance_ndn < amount) {
                showNotification('Недостаточно NDN на балансе', 'error');
                return;
            }

            try {
                showLoading();
                playSound('click');
                
                const initData = tg.initData;
                const response = await fetch('/api/payments/exchange-request', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount_ndn: parseInt(amount),
                        telegram_username: username,
                        description: `Заявка на обмен ${amount} NDN на ${amount} Telegram Stars`
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка создания заявки');
                }

                const result = await response.json();
                showNotification(result.message, 'success');
                playSound('success');
                createSparkles();
                
                // Обновляем данные пользователя
                loadUserData();
                
                closeModal('exchangeNDNModal');
                
            } catch (error) {
                console.error('Ошибка создания заявки:', error);
                showNotification(error.message, 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Вывод NDN
        function withdrawNDN() {
            openModal('withdrawModal');
        }

        // Подтверждение вывода
        async function confirmWithdraw() {
            const amount = document.getElementById('withdrawAmount').value;
            const recipientId = document.getElementById('recipientId').value;
            
            if (!amount || amount < 100) {
                showNotification('Минимальная сумма вывода: 100 NDN', 'error');
                return;
            }
            
            if (!recipientId) {
                showNotification('Введите ID получателя', 'error');
                return;
            }

            try {
                showLoading();
                playSound('click');
                
                const initData = tg.initData;
                const response = await fetch('/api/user/withdraw', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount_ndn: parseFloat(amount),
                        recipient_telegram_id: recipientId
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка вывода NDN');
                }

                const result = await response.json();
                showNotification('NDN успешно выведены!', 'success');
                playSound('success');
                createSparkles();
                
                // Обновляем данные пользователя
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                updateUserData({
                    balance_ndn: userData.balance_ndn - amount
                });
                
                closeModal('withdrawModal');
                
            } catch (error) {
                console.error('Ошибка вывода NDN:', error);
                showNotification('Ошибка вывода NDN', 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Показать рефералов
        async function showReferrals() {
            if (!userData) {
                showNotification('Сначала загрузите данные пользователя', 'error');
                return;
            }
            
            try {
                showLoading();
                playSound('click');
                
                if (!userData.id) {
                    throw new Error('User ID не найден');
                }
                
                console.log('📡 Загружаем рефералов для пользователя ID:', userData.id);
                const response = await fetch(`/api/referrals/by-id/${userData.id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('📡 Ответ сервера:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Ошибка ответа:', errorText);
                    throw new Error(`Ошибка загрузки рефералов: ${response.status}`);
                }

                const data = await response.json();
                console.log('📡 Данные рефералов:', data);
                
                if (data.success) {
                    showReferralsModal(data);
                } else {
                    showNotification(data.message || 'Ошибка загрузки рефералов', 'error');
                }
                
            } catch (error) {
                console.error('Ошибка загрузки рефералов:', error);
                showNotification('Ошибка загрузки рефералов', 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Показать таблицу лидеров
        async function showLeaderboard() {
            try {
                showLoading();
                playSound('click');
                
                console.log('📡 Загружаем лидерборд...');
                const response = await fetch('/api/stats/leaderboard', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('📡 Ответ сервера:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Ошибка ответа:', errorText);
                    throw new Error(`Ошибка загрузки лидерборда: ${response.status}`);
                }

                const data = await response.json();
                console.log('📡 Данные лидерборда:', data);
                
                if (data.success) {
                    // Сервер возвращает data.leaderboard, не data.leaders
                    showLeaderboardModal(data.leaderboard || []);
                } else {
                    showNotification(data.message || 'Ошибка загрузки лидерборда', 'error');
                }
                
            } catch (error) {
                console.error('❌ Ошибка загрузки лидерборда:', error);
                showNotification('Ошибка загрузки лидерборда: ' + error.message, 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Показать правила
        async function showRules() {
            try {
                showLoading();
                playSound('click');
                
                console.log('📋 Загрузка правил игры, язык:', currentLanguage);
                
                // Пробуем прод-роут Node сервера, затем FastAPI-роут как фолбэк
                // Добавляем cache-busting через timestamp
                const cacheBuster = Date.now();
                let response = await fetch(`/api/game/rules?_=${cacheBuster}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept-Language': currentLanguage || 'ru',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                console.log('📋 Ответ от /api/game/rules:', response.status, response.statusText);

                if (!response.ok) {
                    console.log('⚠️ Первый эндпоинт не сработал, пробуем /api/game-rules');
                    response = await fetch(`/api/game-rules?_=${cacheBuster}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept-Language': currentLanguage || 'ru',
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    console.log('📋 Ответ от /api/game-rules:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`Ошибка загрузки правил: ${response.status}`);
                    }
                }

            const data = await response.json();
            console.log('📋 Данные правил получены:', data);
            console.log('📋 data.success:', data.success);
            console.log('📋 data.rules:', data.rules);
            console.log('📋 data.rules.sections:', data.rules?.sections);
            
            if (data.success && data.rules && data.rules.sections && Array.isArray(data.rules.sections)) {
                console.log('✅ Правила валидны, sections:', data.rules.sections.length);
                console.log('📋 Первая секция:', data.rules.sections[0]);
                showRulesModal(data.rules);
            } else {
                console.error('❌ Неверная структура данных:', data);
                console.error('❌ data.success:', data.success);
                console.error('❌ data.rules:', data.rules);
                console.error('❌ data.rules?.sections:', data.rules?.sections);
                showNotification('Ошибка: неверная структура правил', 'error');
            }
                
            } catch (error) {
                console.error('❌ Ошибка загрузки правил:', error);
                showNotification(`Ошибка загрузки правил: ${error.message}`, 'error');
                playSound('error');
            } finally {
                hideLoading();
            }
        }

        // Показать модальное окно рефералов
        function showReferralsModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            // Используем данные из API (структура ответа сервера)
            const stats = data.stats || {};
            const totalReferrals = stats.total_referrals || 0;
            const proReferrals = stats.pro_referrals || 0;
            const regularReferrals = totalReferrals - proReferrals;
            const allReferrals = data.referrals || [];
            const referralsByLevel = data.referralsByLevel || {};
            
            // Подсчитываем общие заработки из статистики
            let totalEarnings = stats.total_earnings || 0;
            
            // Обновляем описание для ясности
            const earningsDescription = totalEarnings > 0 ? 
                `${totalEarnings.toFixed(2)} NDN (только с PRO рефералов)` : 
                '0 NDN (награды за PRO рефералов)';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" data-i18n="buttons.referrals">👥 Мои рефералы</div>
                        <div class="modal-subtitle" data-i18n="referrals.description">Награды начисляются только когда рефералы покупают PRO статус</div>
                    </div>
                    
                    <div class="referral-stats">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">👥</div>
                                <div class="stat-info">
                                    <div class="stat-label" data-i18n="referrals.total">Всего рефералов</div>
                                    <div class="stat-value">${totalReferrals}</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">👤</div>
                                <div class="stat-info">
                                    <div class="stat-label" data-i18n="referrals.regular">Обычных</div>
                                    <div class="stat-value">${regularReferrals}</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">💎</div>
                                <div class="stat-info">
                                    <div class="stat-label" data-i18n="referrals.pro">PRO</div>
                                    <div class="stat-value">${proReferrals}</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">💰</div>
                                <div class="stat-info">
                                    <div class="stat-label" data-i18n="referrals.earnings">Заработано</div>
                                    <div class="stat-value">${earningsDescription}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="referral-levels">
                        <h3 data-i18n="referrals.level_stats">📊 Статистика по уровням:</h3>
                        ${data.referralStats && data.referralStats.length > 0 ? 
                            data.referralStats.filter(stat => stat.total_referrals > 0).map(stat => `
                                <div class="level-item">
                                    <div class="level-info">
                                        <div class="level-number" data-i18n="referrals.level" data-level="${stat.level}">${stat.level} уровень</div>
                                        <div class="level-details">
                                            <div class="level-stats">
                                                <span class="level-count" data-i18n="referrals.referrals_count" data-count="${stat.total_referrals}">${stat.total_referrals} рефералов</span>
                                                <span class="level-reward" data-i18n="referrals.earnings" data-earnings="${stat.total_earnings.toFixed(2)}">+${stat.total_earnings.toFixed(2)} NDN</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') :
                            '<div class="no-referrals" data-i18n="referrals.no_level_stats">Статистика по уровням пока недоступна</div>'
                        }
                    </div>
                    
                    <div class="referrals-content">
                        <h3 data-i18n="referrals.referrals_list">👥 Список рефералов по уровням:</h3>
                        ${Object.keys(referralsByLevel).length > 0 ? 
                            Object.keys(referralsByLevel).sort((a, b) => parseInt(a) - parseInt(b)).filter(level => referralsByLevel[level].length > 0).map(level => `
                                <div class="level-section">
                                    <h4 data-i18n="referrals.level_with_count" data-level="${level}" data-count="${referralsByLevel[level].length}">📊 ${level} уровень (${referralsByLevel[level].length} рефералов):</h4>
                                    ${referralsByLevel[level].map(ref => `
                                        <div class="referral-item">
                                            <div class="referral-info">
                                                <div class="referral-name">
                                                    ${ref.first_name || 'Пользователь'}
                                                    ${ref.is_pro ? ' 💎' : ''}
                                                    ${ref.is_direct ? ' (прямой)' : ''}
                                                </div>
                                                <div class="referral-date">${new Date(ref.created_at).toLocaleDateString('ru-RU')}</div>
                                            </div>
                                            <div class="referral-balance">${ref.balance_ndn || 0} NDN</div>
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('') :
                            '<div class="no-referrals" data-i18n="referrals.no_referrals">У вас пока нет рефералов</div>'
                        }
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="closeModal(this.closest('.modal'))" data-i18n="buttons.back">← Назад</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Обновляем переводы для динамически созданного модального окна
            setTimeout(() => {
                updateModalTranslations();
            }, 100);
            
            playSound('success');
        }

        // Показать модальное окно лидерборда
        function showLeaderboardModal(leaders) {
            if (!leaders || leaders.length === 0) {
                showNotification('Нет данных для отображения', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" data-i18n="buttons.leaderboard">🏆 Таблица лидеров</div>
                        <div class="modal-subtitle" data-i18n="leaderboard.description">Топ игроков по балансу NDN</div>
                    </div>
                    <div class="leaderboard-content">
                        ${leaders.map((leader, index) => {
                            const rank = index + 1;
                            const displayName = leader.first_name || leader.username || 'Пользователь';
                            const balance = (leader.balance_ndn || 0).toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            return `
                            <div class="leader-item ${index < 3 ? 'top-' + (index + 1) : ''}">
                                <div class="leader-rank">#${rank}</div>
                                <div class="leader-info">
                                    <div class="leader-name">${displayName}</div>
                                </div>
                                <div class="leader-balance">
                                    <div class="balance-ndn">${balance} NDN</div>
                                    ${leader.is_pro ? '<div class="pro-badge">💎</div>' : ''}
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="closeModal(this.closest('.modal'))" data-i18n="buttons.back">← Назад</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Обновляем переводы для динамически созданного модального окна
            setTimeout(() => {
                updateModalTranslations();
            }, 100);
            playSound('success');
        }

        // Показать модальное окно правил
        function showRulesModal(rules) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            // Функция рендера контента секции (поддержка массива объектов или строки)
            const renderContent = (content) => {
                if (Array.isArray(content)) {
                    return content.map(item => {
                        const textContent = typeof item === 'object' ? item.text : item;
                        const highlight = item.highlight ? 'highlight' : '';
                        return `<div class="rule-item ${highlight}">${textContent}</div>`;
                    }).join('');
                }
                return `<div class="rule-item">${content}</div>`;
            };
            
            modal.innerHTML = `
                <div class="modal-content rules-modal">
                    <div class="modal-header">
                        <div class="modal-title" data-i18n="buttons.rules">${rules.title}</div>
                        ${rules.description ? `<div class="modal-subtitle">${rules.description}</div>` : ''}
                    </div>
                    <div class="modal-body">
                        <div class="rules-content">
                            ${rules.sections.map(section => `
                                <div class="rule-section">
                                    <div class="rule-header">
                                        ${section.icon ? `<span class="rule-icon">${section.icon}</span>` : ''}
                                        <span class="rule-title">${section.title}</span>
                                        ${section.badge ? `<span class="rule-badge badge-${section.badgeColor || 'blue'}">${section.badge}</span>` : ''}
                                    </div>
                                    <div class="rule-content">
                                        ${renderContent(section.content)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="closeModal(this.closest('.modal'))" data-i18n="buttons.back">← Назад</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Обновляем переводы для динамически созданного модального окна
            setTimeout(() => {
                updateModalTranslations();
            }, 100);
            
            playSound('success');
        }

        // ==================== ДОСТИЖЕНИЯ ====================
        
        async function showAchievements() {
            try {
                if (!userData || !userData.telegram_id) {
                    showNotification('Сначала загрузите данные пользователя', 'error');
                    return;
                }
                
                showModal('achievementsModal');
                showLoading();
                
                const response = await fetch(`/api/achievements/${userData.telegram_id}`);
                const data = await response.json();
                
                if (data.success) {
                    displayAchievements(data.achievements);
                } else {
                    throw new Error('Ошибка загрузки достижений');
                }
            } catch (error) {
                console.error('Error loading achievements:', error);
                showNotification('Ошибка загрузки достижений', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function displayAchievements(achievements) {
            const container = document.getElementById('achievementsList');
            
            if (!achievements || achievements.length === 0) {
                container.innerHTML = '<div class="no-data">Достижения не найдены</div>';
                return;
            }
            
            const groupedAchievements = achievements.reduce((groups, achievement) => {
                const category = achievement.category || 'general';
                if (!groups[category]) {
                    groups[category] = [];
                }
                groups[category].push(achievement);
                return groups;
            }, {});
            
            let html = '';
            for (const [category, categoryAchievements] of Object.entries(groupedAchievements)) {
                const categoryNames = {
                    'trading': '💰 Торговля',
                    'referral': '👥 Рефералы',
                    'special': '⭐ Особые',
                    'social': '💬 Социальные',
                    'general': '🏆 Общие'
                };
                
                html += `
                    <div class="achievement-category">
                        <h3>${categoryNames[category] || category}</h3>
                        <div class="achievement-list">
                            ${categoryAchievements.map(achievement => `
                                <div class="achievement-item ${achievement.is_completed ? 'completed' : ''}">
                                    <div class="achievement-icon">${achievement.icon}</div>
                                    <div class="achievement-info">
                                        <div class="achievement-name">${achievement.name}</div>
                                        <div class="achievement-description">${achievement.description}</div>
                                        <div class="achievement-progress">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${Math.min(100, (achievement.progress / achievement.requirement_value) * 100)}%"></div>
                                            </div>
                                            <span class="progress-text">${achievement.progress}/${achievement.requirement_value}</span>
                                        </div>
                                        ${achievement.is_completed ? `
                                            <div class="achievement-reward">
                                                <span class="reward-ndn">💰 ${achievement.reward_ndn} NDN</span>
                                                <span class="reward-stars">⭐ ${achievement.reward_stars} Stars</span>
                                                ${!achievement.claimed_reward ? `
                                                    <button class="button button-success" onclick="claimAchievement(${achievement.achievement_id})">
                                                        Получить награду
                                                    </button>
                                                ` : '<span class="claimed">✅ Получено</span>'}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        async function claimAchievement(achievementId) {
            try {
                const response = await fetch(`/api/achievements/${userData.telegram_id}/claim?achievement_id=${achievementId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    playSound('success');
                    createSparkles();
                    // Обновляем данные пользователя
                    await loadUserData();
                    // Перезагружаем достижения
                    await showAchievements();
                } else {
                    showNotification(data.message || 'Ошибка получения награды', 'error');
                }
            } catch (error) {
                console.error('Error claiming achievement:', error);
                showNotification('Ошибка получения награды', 'error');
            }
        }
        
        // ==================== МАГАЗИНЫ ====================
        
        async function showShops() {
            try {
                if (!userData || !userData.telegram_id) {
                    showNotification('Сначала загрузите данные пользователя', 'error');
                    return;
                }
                
                showModal('shopsModal');
                showLoading();
                
                const response = await fetch(`/api/shops/${userData.telegram_id}`);
                const data = await response.json();
                
                if (data.success) {
                    displayShops(data.shops);
                } else {
                    throw new Error('Ошибка загрузки магазинов');
                }
            } catch (error) {
                console.error('Error loading shops:', error);
                showNotification('Ошибка загрузки магазинов', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function displayShops(shops) {
            const container = document.getElementById('shopsList');
            
            if (!shops || shops.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">🏪</div>
                        <div class="no-data-title">У вас нет магазинов</div>
                        <div class="no-data-subtitle">Откройте свой первый магазин за 10,000 NDN!</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            shops.forEach(shop => {
                html += `
                    <div class="shop-item">
                        <div class="shop-header">
                            <div class="shop-name">${shop.name}</div>
                            <div class="shop-status ${shop.is_active ? 'active' : 'inactive'}">
                                ${shop.is_active ? '✅ Активен' : '❌ Неактивен'}
                            </div>
                        </div>
                        <div class="shop-description">${shop.description || 'Без описания'}</div>
                        <div class="shop-stats">
                            <div class="shop-stat">
                                <span class="stat-label">Товаров:</span>
                                <span class="stat-value">${shop.items_count}</span>
                            </div>
                            <div class="shop-stat">
                                <span class="stat-label">Продаж:</span>
                                <span class="stat-value">${shop.total_sales}</span>
                            </div>
                            <div class="shop-stat">
                                <span class="stat-label">Категория:</span>
                                <span class="stat-value">${shop.category}</span>
                            </div>
                        </div>
                        <div class="shop-actions">
                            <button class="button button-primary" onclick="showAddItemForm(${shop.shop_id})">
                                📦 Добавить товар
                            </button>
                            <button class="button button-secondary" onclick="viewShopItems(${shop.shop_id})">
                                👀 Просмотреть товары
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showOpenShopForm() {
            closeModal('shopsModal');
            showModal('openShopModal');
        }
        async function confirmOpenShop() {
            const name = document.getElementById('shopName').value.trim();
            const description = document.getElementById('shopDescription').value.trim();
            const category = document.getElementById('shopCategory').value;
            
            if (!name) {
                showNotification('Введите название магазина', 'error');
                return;
            }
            
            if (userData.balance_ndn < 10000) {
                showNotification('Недостаточно NDN для открытия магазина (требуется 10,000 NDN)', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/shops/open', {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${tg.initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        category: category
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    playSound('success');
                    createSparkles();
                    closeModal('openShopModal');
                    // Обновляем данные пользователя
                    await loadUserData();
                    // Показываем магазины
                    await showShops();
                } else {
                    showNotification(data.message || 'Ошибка открытия магазина', 'error');
                }
            } catch (error) {
                console.error('Error opening shop:', error);
                showNotification('Ошибка открытия магазина', 'error');
            }
        }
        
        function showAddItemForm(shopId) {
            window.currentShopId = shopId;
            closeModal('shopsModal');
            showModal('addItemModal');
        }
        
        async function confirmAddItem() {
            const name = document.getElementById('itemName').value.trim();
            const description = document.getElementById('itemDescription').value.trim();
            const priceNDN = parseFloat(document.getElementById('itemPriceNDN').value) || 0;
            const priceStars = parseFloat(document.getElementById('itemPriceStars').value) || 0;
            const itemType = document.getElementById('itemType').value;
            const category = document.getElementById('itemCategory').value;
            const imageUrl = document.getElementById('itemImageUrl').value.trim();
            const stock = parseInt(document.getElementById('itemStock').value) || -1;
            
            if (!name) {
                showNotification('Введите название товара', 'error');
                return;
            }
            
            if (priceNDN <= 0 && priceStars <= 0) {
                showNotification('Укажите цену в NDN или Stars', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/shops/${window.currentShopId}/items`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `tma ${tg.initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        price_ndn: priceNDN,
                        price_stars: priceStars,
                        item_type: itemType,
                        category: category,
                        image_url: imageUrl || null,
                        stock_quantity: stock
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    playSound('success');
                    createSparkles();
                    closeModal('addItemModal');
                    // Очищаем форму
                    document.getElementById('itemName').value = '';
                    document.getElementById('itemDescription').value = '';
                    document.getElementById('itemPriceNDN').value = '';
                    document.getElementById('itemPriceStars').value = '';
                    document.getElementById('itemImageUrl').value = '';
                    document.getElementById('itemStock').value = '-1';
                } else {
                    showNotification(data.message || 'Ошибка добавления товара', 'error');
                }
            } catch (error) {
                console.error('Error adding item:', error);
                showNotification('Ошибка добавления товара', 'error');
            }
        }
        
        function viewShopItems(shopId) {
            // TODO: Реализовать просмотр товаров магазина
            showNotification('Функция просмотра товаров в разработке', 'info');
        }
        
        // Тестовые функции
        function resetTestData() {
            if (confirm('Сбросить все тестовые данные?')) {
                localStorage.removeItem('nodeon_test_user');
                showNotification('Тестовые данные сброшены', 'success');
                playSound('success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }

        function addTestMoney() {
            if (userData) {
                updateUserData({
                    balance_ndn: userData.balance_ndn + 1000 // Добавляем NDN для тестирования
                });
                showNotification('Добавлено 1000 NDN для тестирования!', 'success');
                playSound('success');
                createSparkles();
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM загружен, инициализируем приложение...');
            
            // Проверяем наличие ключевых элементов
            const keyElements = {
                'ndnBalance': document.getElementById('ndnBalance'),
                'userId': document.getElementById('userId'),
                'subtitle': document.querySelector('.subtitle')
            };
            
            console.log('🔍 Проверка элементов DOM:', keyElements);
            
            // Инициализируем игровые данные
            initializeGameData();
            
            createParticles();
            
            // Обработчики событий
            const ndnAmountInput = document.getElementById('ndnAmount');
            if (ndnAmountInput) {
                ndnAmountInput.addEventListener('input', updateStarsCost);
            }
            
            // Загружаем данные пользователя после инициализации DOM
            setTimeout(() => {
                console.log('⏰ Запускаем загрузку данных пользователя...');
                loadUserData();
            }, 500); // Увеличил задержку
            
            // Инициализируем обработчики переводов
            initializeTransferHandlers();
            
            // Закрытие модальных окон по клику вне их
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
        });

        // Функции для работы с приглашениями
        function inviteFriends() {
            console.log('inviteFriends() called');
            console.log('userData:', userData);
            console.log('userData.is_pro:', userData ? userData.is_pro : 'userData is null');
            
            if (!userData) {
                console.log('No userData, showing error notification');
                showNotification('Сначала загрузите данные пользователя!', 'error');
                return;
            }
            
            if (!userData.is_pro) {
                console.log('User is not PRO, showing error notification');
                showNotification('Только PRO пользователи могут приглашать друзей!', 'error');
                return;
            }
            
            console.log('User is PRO, proceeding with invite modal');
            
            // Проверяем, существует ли модальное окно
            const modal = document.getElementById('inviteFriendsModal');
            if (!modal) {
                console.error('inviteFriendsModal not found');
                showNotification('Ошибка: модальное окно не найдено', 'error');
                return;
            }
            
            // Загружаем реферальную ссылку
            loadReferralLink();
            
            // Показываем модальное окно
            showModal('inviteFriendsModal');
            console.log('Invite modal should be visible now');
        }
        
        function loadReferralLink() {
            const linkInput = document.getElementById('referralLinkInput');
            if (!linkInput) {
                console.error('Referral link input not found');
                return;
            }
            
            let referralLink = '';
            
            const botUsername = 'pro_stars_bot'; // Имя бота для реферальных ссылок
            
            if (userData && userData.referral_link && userData.referral_link.trim() !== '') {
                // Если в БД короткая ссылка типа "ref_5" - формируем полную
                if (userData.referral_link.startsWith('ref_')) {
                    referralLink = `https://t.me/${botUsername}?startapp=${userData.referral_link}`;
                    console.log('Generated full referral link from short token:', referralLink);
                } else if (userData.referral_link.startsWith('https://')) {
                    // Если уже полная ссылка - используем как есть
                    referralLink = userData.referral_link;
                    console.log('Using full referral link from database:', referralLink);
                } else {
                    // Если неизвестный формат - добавляем как токен
                    referralLink = `https://t.me/${botUsername}?startapp=${userData.referral_link}`;
                    console.log('Generated referral link from token:', referralLink);
                }
            } else if (userData && userData.id) {
                // Генерируем ссылку на основе игрового ID
                referralLink = `https://t.me/${botUsername}?startapp=ref_${userData.id}`;
                console.log('Generated referral link with game ID:', referralLink);
            } else if (userData && userData.telegram_id) {
                // Fallback на Telegram ID
                referralLink = `https://t.me/${botUsername}?startapp=ref_${userData.telegram_id}`;
                console.log('Generated referral link with Telegram ID:', referralLink);
            } else {
                // Fallback ссылка
                referralLink = 'https://t.me/pro_stars_bot';
                console.log('Using fallback referral link:', referralLink);
            }
            
            linkInput.value = referralLink;
            linkInput.style.color = '#000000';
            linkInput.style.backgroundColor = '#ffffff';
            console.log('Referral link set to:', referralLink);
            
            // Проверяем, что ссылка действительно установлена
            if (linkInput.value !== referralLink) {
                console.error('Failed to set referral link value');
                showNotification('Ошибка загрузки реферальной ссылки', 'error');
            }
        }
        
        async function copyReferralLink() {
            const linkInput = document.getElementById('referralLinkInput');
            if (!linkInput) {
                showNotification('Поле ссылки не найдено', 'error');
                return;
            }
            
            const linkText = linkInput.value.trim();
            if (!linkText) {
                showNotification('Ссылка не загружена. Попробуйте еще раз.', 'error');
                return;
            }
            
            console.log('Копируем ссылку:', linkText);
            
            try {
                // Современный API для копирования
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(linkText);
                    showNotification('Ссылка скопирована в буфер обмена!', 'success');
                    console.log('Ссылка успешно скопирована через Clipboard API');
                } else {
                    // Fallback для старых браузеров
                    linkInput.select();
                    linkInput.setSelectionRange(0, 99999);
                    
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showNotification('Ссылка скопирована в буфер обмена!', 'success');
                        console.log('Ссылка успешно скопирована через execCommand');
                    } else {
                        throw new Error('execCommand failed');
                    }
                }
            } catch (err) {
                console.error('Ошибка копирования:', err);
                showNotification('Не удалось скопировать ссылку. Попробуйте выделить и скопировать вручную.', 'error');
            }
        }
        
        function showLinkModal() {
            const linkInput = document.getElementById('referralLinkInput');
            if (!linkInput || !linkInput.value.trim()) {
                showNotification('Ссылка не загружена', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">🔗 Ваша реферальная ссылка</div>
                        <div class="modal-subtitle">Выделите и скопируйте ссылку вручную</div>
                    </div>
                    <div class="link-display">
                        <div class="link-text" id="linkTextDisplay">${linkInput.value}</div>
                        <div class="link-instructions">
                            <p>📋 Инструкции:</p>
                            <ol>
                                <li>Выделите ссылку выше</li>
                                <li>Нажмите Ctrl+C (или Cmd+C на Mac)</li>
                                <li>Вставьте в нужное место</li>
                            </ol>
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="copyReferralLink()">📋 Копировать автоматически</button>
                        <button class="button button-secondary" onclick="closeModal(this.closest('.modal'))">Закрыть</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Выделяем текст для удобства копирования
            setTimeout(() => {
                const linkText = document.getElementById('linkTextDisplay');
                if (linkText) {
                    const range = document.createRange();
                    range.selectNodeContents(linkText);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }, 100);
        }
        
        function shareViaTelegram() {
            const linkInput = document.getElementById('referralLinkInput');
            if (linkInput && linkInput.value) {
                const message = `🎮 Присоединяйся к NodeOn Crypto!\n\n💰 Зарабатывай NDN и Telegram Stars\n🏆 Открывай достижения и магазины\n👥 Приглашай друзей и получай бонусы\n\n🔗 ${linkInput.value}`;
                
                // Используем Telegram WebApp API для выбора контактов
                if (window.Telegram && window.Telegram.WebApp) {
                    // Открываем диалог выбора контактов
                    window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(linkInput.value)}&text=${encodeURIComponent(message)}`);
                } else {
                    // Fallback для обычных браузеров
                    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(linkInput.value)}&text=${encodeURIComponent(message)}`;
                    window.open(shareUrl, '_blank');
                }
            }
        }
        
        // Функция для выбора контактов из Telegram
        function selectTelegramContacts(callback) {
            // Пока используем простое модальное окно для ввода контакта
            // В будущем можно добавить интеграцию с Telegram API
            showContactInputModal(callback);
        }
        
        // Fallback модальное окно для ввода контакта
        function showContactInputModal(callback) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'contactInputModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">📱 Выберите контакт</div>
                        <div class="modal-subtitle">Введите @username или номер телефона</div>
                    </div>
                    <div class="modal-body">
                        <input type="text" class="form-input" id="contactInput" placeholder="@username или +7XXXXXXXXXX">
                    </div>
                    <div class="modal-buttons">
                        <button class="button button-primary" onclick="confirmContactSelection()">Выбрать</button>
                        <button class="button button-secondary" onclick="closeModal('contactInputModal')">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            showModal('contactInputModal');
            
            // Глобальная функция для подтверждения выбора
            window.confirmContactSelection = function() {
                const contactInput = document.getElementById('contactInput');
                const contact = contactInput.value.trim();
                if (contact) {
                    callback({ username: contact, first_name: contact });
                    closeModal('contactInputModal');
                } else {
                    showNotification('Введите контакт', 'error');
                }
            };
        }
        
        // Функция для приглашения через выбор контакта
        function inviteToTelegramContact() {
            const linkInput = document.getElementById('referralLinkInput');
            if (!linkInput || !linkInput.value) {
                showNotification('Сначала загрузите реферальную ссылку', 'error');
                return;
            }
            
            // Копируем ссылку в буфер обмена
            copyReferralLink();
            
            // Открываем Telegram для выбора контакта
            const message = `🎮 Привет! Присоединяйся к NodeOn Crypto!\n\n💰 Зарабатывай NDN и Telegram Stars\n🏆 Открывай достижения и магазины\n👥 Приглашай друзей и получай бонусы\n\n🔗 ${linkInput.value}`;
            
            if (window.Telegram && window.Telegram.WebApp) {
                // Открываем Telegram с сообщением для выбора контакта
                window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(linkInput.value)}&text=${encodeURIComponent(message)}`);
            } else {
                // Fallback для браузера
                const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(linkInput.value)}&text=${encodeURIComponent(message)}`;
                window.open(shareUrl, '_blank');
            }
            
            showNotification('Ссылка скопирована! Выберите контакт в Telegram', 'success');
        }
        
        // Функция для проверки регистрации пользователя
        function checkUserRegistration(contact, callback) {
            // Здесь можно добавить API вызов для проверки регистрации
            // Пока что возвращаем false (не зарегистрирован)
            setTimeout(() => {
                callback(false, null);
            }, 100);
        }
        
        // Функции для работы с переводами NDN
        let selectedRecipient = null;
        
        function transferNDN() {
            // Обновляем баланс в модальном окне
            document.getElementById('transferBalance').textContent = (userData.balance_ndn || 0).toFixed(2);
            
            // Сбрасываем форму
            selectedRecipient = null;
            document.getElementById('recipientInfo').style.display = 'none';
            document.getElementById('recipientInputSection').style.display = 'block';
            document.getElementById('recipientIdInput').value = '';
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferSummary').style.display = 'none';
            document.getElementById('confirmTransferBtn').disabled = true;
            
            showModal('transferNDNModal');
        }
        
        // Функция для поиска игрока по ID
        async function findRecipient() {
            const recipientId = document.getElementById('recipientIdInput').value.trim();
            
            if (!recipientId) {
                showNotification('Введите игровой ID', 'error');
                return;
            }
            
            if (recipientId == userData.id) {
                showNotification('Нельзя переводить самому себе', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // Ищем игрока по ID
                const response = await fetch(`/api/users/find-by-id/${recipientId}`);
                const data = await response.json();
                
                if (data.success && data.user) {
                    // Игрок найден
                    selectedRecipient = data.user;
                    
                    // Обновляем UI
                    document.getElementById('recipientName').textContent = data.user.first_name || 'Неизвестно';
                    document.getElementById('recipientId').textContent = `ID: ${data.user.id}`;
                    
                    document.getElementById('recipientInfo').style.display = 'block';
                    document.getElementById('recipientInputSection').style.display = 'none';
                    
                    // Проверяем, можно ли активировать кнопку перевода
                    updateTransferButton();
                    
                    showNotification(`Найден игрок: ${data.user.first_name}`, 'success');
                } else {
                    showNotification('Игрок с таким ID не найден', 'error');
                }
            } catch (error) {
                console.error('Error finding recipient:', error);
                showNotification('Ошибка поиска игрока', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function changeRecipient() {
            selectedRecipient = null;
            document.getElementById('recipientInfo').style.display = 'none';
            document.getElementById('recipientInputSection').style.display = 'block';
            document.getElementById('recipientIdInput').value = '';
            document.getElementById('transferSummary').style.display = 'none';
            updateTransferButton();
        }
        
        function updateTransferButton() {
            const amount = parseFloat(document.getElementById('transferAmount').value) || 0;
            const hasRecipient = selectedRecipient !== null;
            const hasAmount = amount > 0;
            const hasEnoughBalance = amount <= (userData.balance_ndn || 0);
            
            const canTransfer = hasRecipient && hasAmount && hasEnoughBalance;
            document.getElementById('confirmTransferBtn').disabled = !canTransfer;
            
            // Обновляем сводку перевода
            if (hasRecipient && hasAmount) {
                updateTransferSummary();
            } else {
                document.getElementById('transferSummary').style.display = 'none';
            }
        }
        
        function updateTransferSummary() {
            const amount = parseFloat(document.getElementById('transferAmount').value) || 0;
            const fee = 0; // Комиссия 0% для простоты
            const total = amount + fee;
            
            document.getElementById('summaryRecipient').textContent = `${selectedRecipient.first_name} (ID: ${selectedRecipient.id})`;
            document.getElementById('summaryAmount').textContent = amount.toFixed(2);
            document.getElementById('summaryFee').textContent = fee.toFixed(2);
            document.getElementById('summaryTotal').textContent = total.toFixed(2);
            
            document.getElementById('transferSummary').style.display = 'block';
        }
        
        // Функция для копирования игрового ID
        function copyUserId() {
            if (userData && userData.id) {
                navigator.clipboard.writeText(userData.id.toString()).then(() => {
                    showNotification('ID скопирован в буфер обмена!', 'success');
                }).catch(() => {
                    // Fallback для старых браузеров
                    const textArea = document.createElement('textarea');
                    textArea.value = userData.id.toString();
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('ID скопирован в буфер обмена!', 'success');
                });
            } else {
                showNotification('ID не загружен', 'error');
            }
        }
        
        async function confirmTransfer() {
            if (!selectedRecipient) {
                showNotification('Выберите получателя', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('transferAmount').value);
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму', 'error');
                return;
            }
            
            if (amount > (userData.balance_ndn || 0)) {
                showNotification('Недостаточно средств', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const response = await fetch('/api/transfers/ndn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tg.initData}`
                    },
                    body: JSON.stringify({
                        from_telegram_id: userData.telegram_id,
                        to_user_id: selectedRecipient.id,
                        amount: amount,
                        description: `Перевод игроку ${selectedRecipient.first_name}`
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Перевод ${amount} NDN выполнен!`, 'success');
                    closeModal('transferNDNModal');
                    
                    // Обновляем баланс пользователя
                    if (userData) {
                        userData.balance_ndn = result.from_balance;
                        updateUI();
                    }
                    
                    // Сбрасываем форму
                    document.getElementById('recipientIdInput').value = '';
                    document.getElementById('transferAmount').value = '';
                    selectedRecipient = null;
                    document.getElementById('recipientInfo').style.display = 'none';
                    document.getElementById('recipientInputSection').style.display = 'block';
                    document.getElementById('transferSummary').style.display = 'none';
                    document.getElementById('confirmTransferBtn').disabled = true;
                } else {
                    showNotification(result.message || 'Ошибка перевода', 'error');
                }
            } catch (error) {
                console.error('Transfer error:', error);
                showNotification('Ошибка соединения', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Обработчик изменения суммы перевода
        function initializeTransferHandlers() {
            const transferAmountInput = document.getElementById('transferAmount');
            if (transferAmountInput) {
                transferAmountInput.addEventListener('input', updateTransferButton);
            }
        }
        
        function shareViaOther() {
            const linkInput = document.getElementById('referralLinkInput');
            if (linkInput && linkInput.value) {
                const message = `🎮 Присоединяйся к NodeOn Crypto!\n\n💰 Зарабатывай NDN и Telegram Stars\n🏆 Открывай достижения и магазины\n👥 Приглашай друзей и получай бонусы\n\n🔗 ${linkInput.value}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'NodeOn Crypto - Зарабатывай NDN!',
                        text: message,
                        url: linkInput.value
                    }).catch(err => {
                        console.log('Ошибка при шаринге:', err);
                        copyReferralLink();
                    });
                } else {
                    copyReferralLink();
                }
            }
        }
    </script>
</body>
</html>