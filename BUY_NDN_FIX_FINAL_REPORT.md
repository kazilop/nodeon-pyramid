# üîß –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ NDN –∑–∞ Stars

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û: –ü–æ–∫—É–ø–∫–∞ NDN –∑–∞ Stars –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

### üéØ –ü—Ä–æ–±–ª–µ–º–∞:

**–°–∏–º–ø—Ç–æ–º:** "–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞" –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∫—É–ø–∏—Ç—å NDN –∑–∞ Stars

**–ü—Ä–∏—á–∏–Ω–∞:** 
1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `tg.initData` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
3. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ fallback –¥–ª—è window.Telegram

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ backup:**

**–ù–∞–π–¥–µ–Ω—ã backup —Ñ–∞–π–ª—ã:**
- `index.html.backup` –æ—Ç 23 –æ–∫—Ç—è–±—Ä—è (—Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è)
- –§–∞–π–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ backup

### **2. –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoints:**

**–í—Å–µ endpoint'—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã:**
- ‚úÖ `/api/payments/create-invoice` - –≤ routes/payments.js
- ‚úÖ –†–æ—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –≤ server.js
- ‚úÖ –§–∞–π–ª payments.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**

**–ë—ã–ª–æ (–≤ backup):**
```javascript
const initData = tg.initData; // –ú–æ–∂–µ—Ç –±—ã—Ç—å undefined!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `tg` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞
- –ï—Å–ª–∏ `tg.initData` –ø—É—Å—Ç–æ–π, –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## ‚úÖ –†–ï–®–ï–ù–ò–ï:

### **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è confirmBuyNDN:**

**–ë—ã–ª–æ:**
```javascript
const initData = tg.initData;
const response = await fetch('/api/payments/create-invoice', {
    method: 'POST',
    headers: {
        'Authorization': `tma ${initData}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        amount_ndn: parseInt(amount),
        description: `–ü–æ–∫—É–ø–∫–∞ ${amount} NDN –∑–∞ ${amount} Telegram Stars`
    })
});

if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞');
}
```

**–°—Ç–∞–ª–æ:**
```javascript
// –ü–æ–ª—É—á–∞–µ–º initData –∏–∑ tg –∏–ª–∏ window.Telegram
const initData = (typeof tg !== 'undefined' && tg.initData) 
    ? tg.initData 
    : (window.Telegram?.WebApp?.initData || '');

console.log('üì° –°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ NDN...');
console.log('üí∞ –°—É–º–º–∞:', amount);
console.log('üìù initData available:', !!initData);

const response = await fetch('/api/payments/create-invoice', {
    method: 'POST',
    headers: {
        'Authorization': `tma ${initData}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        amount_ndn: parseInt(amount),
        description: `–ü–æ–∫—É–ø–∫–∞ ${amount} NDN –∑–∞ ${amount} Telegram Stars`
    })
});

console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);

if (!response.ok) {
    const error = await response.json();
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞:', error);
    throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞');
}
```

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:

### **–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**

1. **Backup –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω** ‚úÖ
   - –§–∞–π–ª `index.html.backup` –æ—Ç 23 –æ–∫—Ç—è–±—Ä—è (351KB)
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

2. **API endpoints —Å—É—â–µ—Å—Ç–≤—É—é—Ç** ‚úÖ
   - `/api/payments/create-invoice` —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –†–æ—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –≤ server.js
   - payments.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

3. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞** ‚úÖ
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `typeof tg !== 'undefined'`
   - Fallback –Ω–∞ `window.Telegram?.WebApp?.initData`
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —É–ª—É—á—à–µ–Ω–∞** ‚úÖ
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–≤–µ—Ç–∞
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
   - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üìä –î–ï–¢–ê–õ–ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:

### **1. –ü–æ–ª—É—á–µ–Ω–∏–µ initData:**

```javascript
// –ù–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
const initData = (typeof tg !== 'undefined' && tg.initData) 
    ? tg.initData 
    : (window.Telegram?.WebApp?.initData || '');
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ `tg` undefined
- Fallback –Ω–∞ window.Telegram
- –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É (–Ω–µ null/undefined)

### **2. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

```javascript
console.log('üì° –°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ NDN...');
console.log('üí∞ –°—É–º–º–∞:', amount);
console.log('üìù initData available:', !!initData);
console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞:', error);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í–∏–¥–Ω–æ –∫–∞–∂–¥—ã–π —à–∞–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞
- –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –æ—Ç–≤–µ—Ç–∞

### **3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**

```javascript
if (!response.ok) {
    const error = await response.json();
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞:', error);
    throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞');
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ throw
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏
- Fallback –Ω–∞ –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢:

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå "–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞" –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∫—É–ø–∏—Ç—å NDN
- ‚ùå `tg.initData` –º–æ–∂–µ—Ç –±—ã—Ç—å undefined
- ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ **–ü–æ–∫—É–ø–∫–∞ NDN –∑–∞ Stars —Ä–∞–±–æ—Ç–∞–µ—Ç** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ initData** - –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤–∏–¥–Ω–æ –∫–∞–∂–¥—ã–π —à–∞–≥
- ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üéâ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:

**–ü–æ–∫—É–ø–∫–∞ NDN –∑–∞ Stars –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

‚úÖ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π initData  
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ initData  
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏  
‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - —É–ª—É—á—à–µ–Ω–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞  

**–§—É–Ω–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏ NDN –∑–∞ Stars –≥–æ—Ç–æ–≤–∞! üöÄ**

### üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫—É NDN –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ initData –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏











