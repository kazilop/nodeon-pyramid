# Автоматическое обновление баланса после покупки NDN

## Проблема
После успешной покупки NDN за Stars баланс в интерфейсе не обновлялся автоматически. Пользователь был вынужден перезагружать игру, чтобы увидеть изменения.

## Причина
Функция `confirmBuyNDN` использовала `setTimeout` с фиксированной задержкой 3 секунды для обновления баланса. Если платеж обрабатывался дольше или был отменен, пользователь не видел изменений без перезагрузки.

## Решение

### Добавлена периодическая проверка баланса

Вместо одноразового обновления через 3 секунды, теперь баланс проверяется каждые 3 секунды в течение 30 секунд, пока не обнаружится увеличение:

```javascript
// Периодически проверяем баланс (платеж может пройти)
let checkCount = 0;
const maxChecks = 10; // Проверяем 10 раз по 3 секунды = 30 секунд
const checkInterval = setInterval(async () => {
    checkCount++;
    try {
        const oldBalance = userData.balance_ndn;
        await loadUserData();
        const newBalance = userData.balance_ndn;
        
        if (newBalance > oldBalance) {
            // Баланс увеличился - платеж прошел!
            clearInterval(checkInterval);
            showNotification(`✅ Платеж успешен! Баланс обновлен: +${newBalance - oldBalance} NDN`, 'success');
            playSound('success');
            createSparkles();
        } else if (checkCount >= maxChecks) {
            // Прекращаем проверку через 30 секунд
            clearInterval(checkInterval);
            console.log('Проверка баланса завершена');
        }
    } catch (e) {
        console.error('Ошибка обновления данных:', e);
        if (checkCount >= maxChecks) {
            clearInterval(checkInterval);
        }
    }
}, 3000);
```

## Как это работает

1. **Пользователь открывает окно оплаты** → `tg.openLink(invoiceUrl)`
2. **Показывается уведомление** → "Открыто окно оплаты"
3. **Запускается периодическая проверка** → каждые 3 секунды вызывается `loadUserData()`
4. **Сравнивается баланс** → если баланс увеличился, значит платеж прошел
5. **Отображается уведомление** → "✅ Платеж успешен! Баланс обновлен: +2 NDN"
6. **Воспроизводится звук** → `playSound('success')`
7. **Анимация** → `createSparkles()`
8. **Проверка прекращается** → `clearInterval(checkInterval)`

## Параметры проверки

- **Интервал:** 3 секунды
- **Количество проверок:** 10 раз
- **Общее время:** 30 секунд
- **Автоматическое прекращение:** после обнаружения изменения баланса или по истечению времени

## Результат

- ✅ Баланс обновляется автоматически после платежа
- ✅ Пользователь видит уведомление о успешном платеже
- ✅ Звук и анимация подтверждают успешный платеж
- ✅ Не требуется перезагрузка страницы
- ✅ Проверка прекращается автоматически

## Тестирование

1. Откройте Mini App в Telegram
2. Нажмите "Купить NDN"
3. Введите сумму (например, 2 NDN)
4. Нажмите "Купить"
5. Подтвердите платеж в Telegram
6. Баланс обновится автоматически в течение 3-30 секунд
7. Вы увидите уведомление "✅ Платеж успешен! Баланс обновлен: +2 NDN"










