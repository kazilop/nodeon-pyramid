# üí≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Æ–ö–∞—Å—Å—ã –¥–ª—è NodeOn Pyramid

## üéØ –û–±–∑–æ—Ä

–Æ–ö–∞—Å—Å–∞ - —ç—Ç–æ –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä—É–±–ª—è—Ö. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–∫—É–ø–∞—Ç—å NDN –º–æ–Ω–µ—Ç—ã –∑–∞ —Ä—É–±–ª–∏.

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Æ–ö–∞—Å—Å—ã

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –Æ–ö–∞—Å—Å–µ

1. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç –Æ–ö–∞—Å—Å—ã:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ https://yookassa.ru/
   - –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"

2. **–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:**
   - –í—ã–±–µ—Ä–∏—Ç–µ "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω"
   - –£–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
   - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω

3. **–ü—Ä–æ–π–¥–∏—Ç–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é:**
   - –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
   - –î–æ–∂–¥–∏—Ç–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∫–∏ (1-3 –¥–Ω—è)

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π

–ü–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:
- **Shop ID** - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞
- **Secret Key** - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è API

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Supabase

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```sql
-- –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Æ–ö–∞—Å—Å—ã
UPDATE nodeon_yookassa_config SET config_value = 'YOUR_SHOP_ID' WHERE config_key = 'yookassa_shop_id';
UPDATE nodeon_yookassa_config SET config_value = 'YOUR_SECRET_KEY' WHERE config_key = 'yookassa_secret_key';
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook

1. **–í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–ö–∞—Å—Å—ã:**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "Webhook"
   - URL: `https://nodeon-production.up.railway.app/api/yookassa/webhook`
   - –°–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook:**
   - –Æ–ö–∞—Å—Å–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Railway

## üí∞ –¢–∞—Ä–∏—Ñ—ã –Æ–ö–∞—Å—Å—ã

### –ö–æ–º–∏—Å—Å–∏–∏:
- **–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã:** 2.9% + 15‚ÇΩ
- **–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏:** 3.5% + 15‚ÇΩ
- **–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã:** 1.5% + 15‚ÇΩ

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã:
- **–ú–∏–Ω–∏–º—É–º:** 1‚ÇΩ
- **–ú–∞–∫—Å–∏–º—É–º:** 15,000,000‚ÇΩ

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API

### 1. –û–±–Ω–æ–≤–∏—Ç–µ main.py

–ó–∞–º–µ–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `main.py` –Ω–∞ `main_with_payments.py`:

```bash
cp main_with_payments.py main.py
```

### 2. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–î–æ–±–∞–≤—å—Ç–µ –≤ `requirements.txt`:

```
yookassa==3.0.0
```

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ Railway:

```
YOOKASSA_SHOP_ID=–≤–∞—à_shop_id
YOOKASSA_SECRET_KEY=–≤–∞—à_secret_key
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã

–Æ–ö–∞—Å—Å–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:

- **–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:** 5555 5555 5555 4444
- **–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞:** 5555 5555 5555 4445
- **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤:** 5555 5555 5555 4446

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã

```bash
python test_stars_functionality.py
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Telegram

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫—É–ø–∏—Ç—å NDN –∑–∞ —Ä—É–±–ª–∏

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π

### 1. –õ–æ–≥–∏ Railway

```bash
railway logs --tail 50
```

### 2. –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –Æ–ö–∞—Å—Å—ã

- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ü–ª–∞—Ç–µ–∂–∏"
- –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- –°–∫–∞—á–∏–≤–∞–π—Ç–µ –æ—Ç—á–µ—Ç—ã

### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞—Ç–µ–∂–µ–π
SELECT * FROM nodeon_yookassa_payments ORDER BY created_at DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
SELECT 
    DATE(created_at) as date,
    COUNT(*) as payments,
    SUM(amount_rub) as total_rub,
    SUM(ndn_amount) as total_ndn
FROM nodeon_yookassa_payments 
WHERE status = 'succeeded'
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏

–í—Å–µ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è:

```python
import hmac
import hashlib

def verify_yookassa_signature(data, signature, secret_key):
    expected_signature = hmac.new(
        secret_key.encode(),
        data.encode(),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(signature, expected_signature)
```

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

## üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

### 1. –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

- **–ö–æ–Ω–≤–µ—Ä—Å–∏—è:** % —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- **–°—Ä–µ–¥–Ω–∏–π —á–µ–∫:** —Å—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
- **–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—É–º–º—ã:** –∫–∞–∫–∏–µ —Å—É–º–º—ã –ø–æ–∫—É–ø–∞—é—Ç —á–∞—â–µ
- **–í—Ä–µ–º—è –ø–ª–∞—Ç–µ–∂–∞:** –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç

### 2. –î–∞—à–±–æ—Ä–¥

–°–æ–∑–¥–∞–π—Ç–µ –¥–∞—à–±–æ—Ä–¥ —Å –∫–ª—é—á–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏:

```sql
-- –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ç—Ä–∞—Ç–∞–º
SELECT 
    u.first_name,
    u.username,
    SUM(yp.amount_rub) as total_rub,
    SUM(yp.ndn_amount) as total_ndn
FROM nodeon_yookassa_payments yp
JOIN nodeon_users u ON yp.user_id = u.id
WHERE yp.status = 'succeeded'
GROUP BY u.id, u.first_name, u.username
ORDER BY total_rub DESC
LIMIT 10;
```

## üöÄ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Æ–ö–∞—Å—Å—ã:

‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –ø–æ–∫—É–ø–∞—Ç—å NDN –∑–∞ —Ä—É–±–ª–∏**
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ NDN –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã**
‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π**
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook**

**–í—Ä–µ–º—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ~30 –º–∏–Ω—É—Ç**
**–†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞!**
