# ‚úÖ –ù–ê–°–¢–†–û–ô–ö–ê TELEGRAM STARS –ó–ê–í–ï–†–®–ï–ù–ê

## üéØ –ß–¢–û –°–î–ï–õ–ê–ù–û:

### **1. Backend (payments.js):**
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `axios` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ invoice —Å—Å—ã–ª–∫–∏ —á–µ—Ä–µ–∑ `createInvoiceLink`  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ invoice —á–µ—Ä–µ–∑ –±–æ—Ç–∞  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω endpoint `/confirm-payment` –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞  

### **2. Backend Bot (telegram_bot.py):**
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `/buy_ndn` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è invoice  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `PreCheckoutQuery`  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `successful_payment`  
‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ NDN –Ω–∞ –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ API  

### **3. –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

#### **–í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Bot API (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
1. –ö–ª–∏–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `/api/payments/create-invoice`
2. –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç invoice —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ `createInvoiceLink`
3. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç `invoice_url` 
4. –ö–ª–∏–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `tg.openInvoice(invoice_url, callback)`
5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `PreCheckoutQuery` –≤ –±–æ—Ç–µ
6. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `successful_payment`
7. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –Ω–∞ `/api/payments/confirm-payment`
8. NDN –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### **–í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ –±–æ—Ç–∞ (Fallback)**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/buy_ndn <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ>` –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º
2. –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç invoice –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
3. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `successful_payment`
4. NDN –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å

## üìù –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´:

- ‚úÖ `server-deployment/routes/payments.js` - –°–æ–∑–¥–∞–Ω–∏–µ invoice —Å—Å—ã–ª–∫–∏
- ‚úÖ `backend/telegram_bot.py` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ PM2 –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω

## ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ê:

### **Backend URL –≤ –±–æ—Ç–µ:**
–í —Ñ–∞–π–ª–µ `backend/telegram_bot.py` –≤ –º–µ—Ç–æ–¥–µ `successful_payment_handler`:
```python
response = await client.post(
    f"{settings.backend_url}/api/payments/confirm-payment",
    # ...
)
```

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ `settings.backend_url` —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –≤–∞—à–µ–≥–æ backend API.

### **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ `.env` –µ—Å—Ç—å:
```
TELEGRAM_BOT_TOKEN=your_token
TELEGRAM_BOT_USERNAME=your_bot_username
SUPABASE_URL=your_url
SUPABASE_ANON_KEY=your_key
```

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:

### **1. –¢–µ—Å—Ç —á–µ—Ä–µ–∑ Mini App:**
1. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram
2. –ù–∞–∂–∞—Ç—å "–ö—É–ø–∏—Ç—å NDN –∑–∞ Telegram Stars"
3. –í–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ NDN
4. –ù–∞–∂–∞—Ç—å "–ö—É–ø–∏—Ç—å"
5. –î–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å—Å—è –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã
6. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã NDN –¥–æ–ª–∂–Ω—ã –∑–∞—á–∏—Å–ª–∏—Ç—å—Å—è

### **2. –¢–µ—Å—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/buy_ndn 100` –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º
2. –ü–æ–ª—É—á–∏—Ç—å invoice –æ—Ç –±–æ—Ç–∞
3. –û–ø–ª–∞—Ç–∏—Ç—å invoice
4. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏

## üéâ –†–ï–ó–£–õ–¨–¢–ê–¢:

‚úÖ Invoice —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Bot API  
‚úÖ –ü–ª–∞—Ç–µ–∂–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ NDN –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å  
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∏ —á–µ—Ä–µ–∑ Mini App, –∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞  

## ‚ö†Ô∏è –í–ê–ñ–ù–û:

–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω–æ:
1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ telegram_bot.py –∑–∞–ø—É—â–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π backend_url –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–æ—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

## üìû –ü–û–î–î–ï–†–ñ–ö–ê:

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ PM2
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è











